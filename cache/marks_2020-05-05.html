<html><head>
    <meta charset="UTF-8">
    
    <title>Электронная школа - Личный кабинет</title>
    
    <meta name="description" content="">
    <meta name="keyword" content="">
    <link href="/static/personal_area/images-theme-style/favicon.ico" rel="icon">
    <meta name="viewport" content="initial-scale=1.0, width=device-width">
    <link rel="stylesheet" type="text/css" href="/static/personal_area/css/vendor/jquery-ui.min.css" media="all">
    <link rel="stylesheet" type="text/css" href="/static/personal_area/css/main-style.css" media="all">
    <link rel="stylesheet" type="text/css" href="/static/personal_area/css/plugins-style.css" media="all">
    <link rel="stylesheet" data-type="style" type="text/css" href="/static/personal_area/css/theme-style.css" media="all">

    
    <script type="text/javascript" src="/static/personal_area/js/vendor/jquery.min.js"></script>
    <script type="text/javascript" src="/static/personal_area/js/vendor/jquery-ui.min.js"></script>
    <script type="text/javascript" src="/static/personal_area/js/vendor/jquery.jeditable.min.js"></script>
    
    <script type="text/javascript" src="/static/personal_area/js/vendor/pagination.js"></script>
    <script type="text/javascript" src="/static/personal_area/js/vendor/jquery-ui.customs.js"></script>
    <script type="text/javascript" src="/static/personal_area/js/vendor/jquery.ui.datepicker-ru.js"></script>
    <script type="text/javascript" src="/static/personal_area/js/vendor/jquery.cookie.min.js"></script>
    <script type="text/javascript" src="/static/personal_area/js/vendor/jquery.mousewheel.js"></script>
    <script type="text/javascript" src="/static/personal_area/js/vendor/jquery.jscrollpane.min.js"></script>
    <script type="text/javascript" src="/static/personal_area/js/vendor/ajaxupload.min.js"></script>
    <script type="text/javascript" src="/static/personal_area/js/vendor/highcharts.js"></script>
    <script type="text/javascript" src="/static/personal_area/js/vendor/ckeditor/ckeditor.js"></script><style>.cke{visibility:hidden;}</style>
    <script type="text/javascript" src="/static/personal_area/js/vendor/ckeditor/adapters/jquery.js"></script>

    <script type="text/javascript">
        window.FileAPI = {
            debug: false,
            media: false,
            staticPath: "/static/personal_area/js/vendor/FileAPI/dist"
        }
    </script>

    
    <script type="text/javascript" src="/static/personal_area/js/vendor/underscore-min.js"></script>
    <script type="text/javascript" src="/static/personal_area/js/vendor/backbone-min.js"></script>
    <script type="text/javascript" src="/static/personal_area/js/vendor/backbone.marionette.min.js"></script>
    <script type="text/javascript" src="/static/personal_area/js/vendor/backbone.syphon.min.js"></script>
    <script type="text/javascript" src="/static/personal_area/js/vendor/FileAPI/dist/FileAPI.min.js"></script>
    <script type="text/javascript">
    </script>
    

</head>
<body>
<div class="page">
    <div id="header-region"><div class="header clearfix">
    <span class="logo"><a href="/personal-area/"></a></span>
    <div><div>
    <div class="day">5</div>
    <span>Май /
        <span>Вторник</span><br>
        <span class="year">2020</span>
    </span>
</div><div id="profile-container">
    <div class="menu-item profile">
        <!-- // ФИО и аватар выбранного ребенка (совпадает с пользователем, когда пользователь - ребенок) -->
        <p>
            Никитина Валерия
            <img src="/media/uploads/userprofile/2017/09/07/2845828a187a49599aa1d5a062e229a5.jpg" title="Никитина Валерия" alt="Никитина Валерия">
        </p>
        <span class="arrow"></span>
        <div class="more">
            <div class="clearfix">
                <!-- // ФИО и аватар текущего пользователя -->
                <img src="/media/uploads/userprofile/2017/09/07/2845828a187a49599aa1d5a062e229a5.jpg">
                <div>
                    <p>
                        Никитина Валерия Юрьевна<br>
                        <span>Ученица 6 Б класса</span>
                    </p>
                    <a class="go_profile btn green brown">Профиль</a>
                </div>
                
            </div>
            <div class="links clearfix">
                
                <a class="logout" href="/auth/force-logout">Выход<span class="ico"></span></a>
            </div>
            <span class="corner top"><span></span></span>
        </div>
    </div>
</div><div id="indicator-container">
    <div class="gpa">
        <div>
            <ul></ul>
        </div>
        <span class="arrow up"></span>
        <span class="arrow down"></span>
    </div>
</div></div>
</div></div>
    <div class="wrapper clearfix">
        <div id="left-region" class="left"><div><div><ul class="menu"><li class="diary">
    <a href="#diary" class="active">
        <i></i>
        Дневник
        
        <span class="ico"></span>
    </a>
    
</li><li class="schedule">
    <a href="#schedule">
        <i></i>
        Расписание
        
        <span class="ico"></span>
    </a>
    
</li><li class="grades">
    <a href="#marks">
        <i></i>
        Оценки
        
        <span class="ico"></span>
    </a>
    
</li><li class="school">
    <a href="#school">
        <i></i>
        Школа
        
        <span class="ico"></span>
    </a>
    
</li><li class="homework">
    <a href="#homework">
        <i></i>
        Домашнее задание
        
        <span class="ico"></span>
    </a>
    
</li><li class="portfolio">
    <a href="#portfolio">
        <i></i>
        Портфолио
        
        <span class="ico"></span>
    </a>
    
</li><li class="board">
    <a href="#advertboard">
        <i></i>
        Доска объявлений
        
        <span class="ico"></span>
    </a>
    
</li><li class="mailbox">
    <a href="#mailbox/inbox">
        <i></i>
        Почта
        
          <span class="hint">15</span>
        
        <span class="ico"></span>
    </a>
    
</li></ul><div class="info_block meeting" style="display: none;">
    <h3>Родительское собрание</h3>
    <div class="date"></div>
    <div class="time-place"><span>-</span>Каб. </div>
    
</div><div class="info_block meeting" style="display: none;">
    <h3>Классный час</h3>
    <div class="date"></div>
    <div class="time-place"><span>-</span></div>
    <div></div>
    <div class="time-place"><span></span></div>
</div><div class="info_block activity" style="display: none;">
    <h3>Мероприятия</h3>
    <ul></ul>
    <div class="btn rnd green open_list"><i class="ico arrow"></i></div>
</div><div class="info_block birthdays" style="display: none;">
    <h3>Дни рождения</h3>
    <span></span>
</div></div></div></div>
        <div id="main-region" class="right" style="padding-bottom: 160px;"><div class="diary">
    <div class="top clearfix">
        <div class="left_el close_all"><span>Свернуть все</span></div>
        <div class="left_el today"><span>Сегодня</span></div>
        <div id="for-datepicker"><div>
        <div class="right_el calendar">
            <div class="calendar_btn pick-activator">
                <span class="ico"></span>
            </div>
            <div class="calendar_wrap">
                <div class="datepicker hasDatepicker" id="dp1588623767420"><div class="ui-datepicker-inline ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all" style="display: block;"><div class="ui-datepicker-header ui-widget-header ui-helper-clearfix ui-corner-all"><a class="ui-datepicker-prev ui-corner-all" data-handler="prev" data-event="click" title="<Пред"><span class="ui-icon ui-icon-circle-triangle-w">&lt;Пред</span></a><a class="ui-datepicker-next ui-corner-all" data-handler="next" data-event="click" title="След>"><span class="ui-icon ui-icon-circle-triangle-e">След&gt;</span></a><div class="ui-datepicker-title"><span class="ui-datepicker-month">Май</span>&nbsp;<span class="ui-datepicker-year">2020</span></div></div><table class="ui-datepicker-calendar"><thead><tr><th scope="col"><span title="понедельник">Пн</span></th><th scope="col"><span title="вторник">Вт</span></th><th scope="col"><span title="среда">Ср</span></th><th scope="col"><span title="четверг">Чт</span></th><th scope="col"><span title="пятница">Пт</span></th><th scope="col" class="ui-datepicker-week-end"><span title="суббота">Сб</span></th><th scope="col" class="ui-datepicker-week-end"><span title="воскресенье">Вс</span></th></tr></thead><tbody><tr><td class=" ui-datepicker-other-month " data-handler="selectDay" data-event="click" data-month="3" data-year="2020"><a class="ui-state-default ui-priority-secondary" href="#">27</a></td><td class=" ui-datepicker-other-month " data-handler="selectDay" data-event="click" data-month="3" data-year="2020"><a class="ui-state-default ui-priority-secondary" href="#">28</a></td><td class=" ui-datepicker-other-month " data-handler="selectDay" data-event="click" data-month="3" data-year="2020"><a class="ui-state-default ui-priority-secondary" href="#">29</a></td><td class=" ui-datepicker-other-month " data-handler="selectDay" data-event="click" data-month="3" data-year="2020"><a class="ui-state-default ui-priority-secondary" href="#">30</a></td><td class=" " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">1</a></td><td class=" ui-datepicker-week-end " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">2</a></td><td class=" ui-datepicker-week-end " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">3</a></td></tr><tr><td class=" " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">4</a></td><td class=" ui-datepicker-days-cell-over  ui-datepicker-current-day ui-datepicker-today" data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default ui-state-highlight ui-state-active ui-state-hover" href="#">5</a></td><td class=" " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">6</a></td><td class=" " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">7</a></td><td class=" " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">8</a></td><td class=" ui-datepicker-week-end " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">9</a></td><td class=" ui-datepicker-week-end " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">10</a></td></tr><tr><td class=" " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">11</a></td><td class=" " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">12</a></td><td class=" " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">13</a></td><td class=" " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">14</a></td><td class=" " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">15</a></td><td class=" ui-datepicker-week-end " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">16</a></td><td class=" ui-datepicker-week-end " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">17</a></td></tr><tr><td class=" " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">18</a></td><td class=" " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">19</a></td><td class=" " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">20</a></td><td class=" " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">21</a></td><td class=" " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">22</a></td><td class=" ui-datepicker-week-end " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">23</a></td><td class=" ui-datepicker-week-end " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">24</a></td></tr><tr><td class=" " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">25</a></td><td class=" " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">26</a></td><td class=" " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">27</a></td><td class=" " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">28</a></td><td class=" " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">29</a></td><td class=" ui-datepicker-week-end " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">30</a></td><td class=" ui-datepicker-week-end " data-handler="selectDay" data-event="click" data-month="4" data-year="2020"><a class="ui-state-default" href="#">31</a></td></tr></tbody></table></div></div>
            </div>
        </div>
        <div class="date-panel" <="" div=""><div>
    
        <div class="right_el sel_week">
            <a class="prev"><span class="ico"></span></a>
            <a class="next"><span class="ico"></span></a>
            <div class="container">
                <span>
                    04
                    <span>
                        05
                        <br>
                        пн
                    </span>
                </span>  –
                <span>
                    10
                    <span>
                        05
                        <br>
                        вс
                    </span>
                </span>
            </div>
        </div>
    
</div></div></div></div>
    </div>
    <div id="for-content"><div>
    <div class="content">
        <span class="line"></span>
        <ul class="dynamic"><li>
    <div class="weekday_header cursor_pointer clearfix">
        <div class="date">4/<span>05</span></div>
        <div class="week_day">Понедельник</div>
        <div class="text">Сегодня</div>
        <span class="ico arrow"></span>
    </div>
    <table class="not">
        <thead>
        <tr>
            <th width="5%"><div>Время</div></th>
            <th width="20%"><div>Предмет</div></th>
            <th width="30%"><div>Тема</div></th>
            <th width="30%"><div>Домашнее задание</div></th>
            <th width="5%"><div>Файл</div></th>
            <th width="10%"><div>Посещаемость</div></th>
            <th width="5%"><div>Оценка</div></th>
            <th width="15%"><div>Учитель</div></th>
        </tr>
        </thead>
        <tbody>
            
                <tr><td colspan="5"> Праздник </td></tr>
            
        </tbody>
    </table>
</li><li class="today open">
    <div class="weekday_header cursor_pointer clearfix">
        <div class="date">5/<span>05</span></div>
        <div class="week_day">Вторник</div>
        <div class="text">Сегодня</div>
        <span class="ico arrow"></span>
    </div>
    <table class="not">
        <thead>
        <tr>
            <th width="5%"><div>Время</div></th>
            <th width="20%"><div>Предмет</div></th>
            <th width="30%"><div>Тема</div></th>
            <th width="30%"><div>Домашнее задание</div></th>
            <th width="5%"><div>Файл</div></th>
            <th width="10%"><div>Посещаемость</div></th>
            <th width="5%"><div>Оценка</div></th>
            <th width="15%"><div>Учитель</div></th>
        </tr>
        </thead>
        <tbody>
            
                <tr><td colspan="5"> Праздник </td></tr>
            
        </tbody>
    </table>
</li><li>
    <div class="weekday_header cursor_pointer clearfix">
        <div class="date">6/<span>05</span></div>
        <div class="week_day">Среда</div>
        <div class="text">Сегодня</div>
        <span class="ico arrow"></span>
    </div>
    <table class="not">
        <thead>
        <tr>
            <th width="5%"><div>Время</div></th>
            <th width="20%"><div>Предмет</div></th>
            <th width="30%"><div>Тема</div></th>
            <th width="30%"><div>Домашнее задание</div></th>
            <th width="5%"><div>Файл</div></th>
            <th width="10%"><div>Посещаемость</div></th>
            <th width="5%"><div>Оценка</div></th>
            <th width="15%"><div>Учитель</div></th>
        </tr>
        </thead>
        <tbody>
            
                <tr><td colspan="5"> Праздник </td></tr>
            
        </tbody>
    </table>
</li><li>
    <div class="weekday_header cursor_pointer clearfix">
        <div class="date">7/<span>05</span></div>
        <div class="week_day">Четверг</div>
        <div class="text">Сегодня</div>
        <span class="ico arrow"></span>
    </div>
    <table class="not">
        <thead>
        <tr>
            <th width="5%"><div>Время</div></th>
            <th width="20%"><div>Предмет</div></th>
            <th width="30%"><div>Тема</div></th>
            <th width="30%"><div>Домашнее задание</div></th>
            <th width="5%"><div>Файл</div></th>
            <th width="10%"><div>Посещаемость</div></th>
            <th width="5%"><div>Оценка</div></th>
            <th width="15%"><div>Учитель</div></th>
        </tr>
        </thead>
        <tbody>
            
                <tr><td colspan="5"> Праздник </td></tr>
            
        </tbody>
    </table>
</li><li>
    <div class="weekday_header cursor_pointer clearfix">
        <div class="date">8/<span>05</span></div>
        <div class="week_day">Пятница</div>
        <div class="text">Сегодня</div>
        <span class="ico arrow"></span>
    </div>
    <table class="not">
        <thead>
        <tr>
            <th width="5%"><div>Время</div></th>
            <th width="20%"><div>Предмет</div></th>
            <th width="30%"><div>Тема</div></th>
            <th width="30%"><div>Домашнее задание</div></th>
            <th width="5%"><div>Файл</div></th>
            <th width="10%"><div>Посещаемость</div></th>
            <th width="5%"><div>Оценка</div></th>
            <th width="15%"><div>Учитель</div></th>
        </tr>
        </thead>
        <tbody>
            
                <tr><td colspan="5"> Праздник </td></tr>
            
        </tbody>
    </table>
</li><li>
    <div class="weekday_header cursor_pointer clearfix">
        <div class="date">9/<span>05</span></div>
        <div class="week_day">Суббота</div>
        <div class="text">Сегодня</div>
        <span class="ico arrow"></span>
    </div>
    <table class="not">
        <thead>
        <tr>
            <th width="5%"><div>Время</div></th>
            <th width="20%"><div>Предмет</div></th>
            <th width="30%"><div>Тема</div></th>
            <th width="30%"><div>Домашнее задание</div></th>
            <th width="5%"><div>Файл</div></th>
            <th width="10%"><div>Посещаемость</div></th>
            <th width="5%"><div>Оценка</div></th>
            <th width="15%"><div>Учитель</div></th>
        </tr>
        </thead>
        <tbody>
            
                <tr><td colspan="5"> Выходной </td></tr>
            
        </tbody>
    </table>
</li><li>
    <div class="weekday_header cursor_pointer clearfix">
        <div class="date">10/<span>05</span></div>
        <div class="week_day">Воскресенье</div>
        <div class="text">Сегодня</div>
        <span class="ico arrow"></span>
    </div>
    <table class="not">
        <thead>
        <tr>
            <th width="5%"><div>Время</div></th>
            <th width="20%"><div>Предмет</div></th>
            <th width="30%"><div>Тема</div></th>
            <th width="30%"><div>Домашнее задание</div></th>
            <th width="5%"><div>Файл</div></th>
            <th width="10%"><div>Посещаемость</div></th>
            <th width="5%"><div>Оценка</div></th>
            <th width="15%"><div>Учитель</div></th>
        </tr>
        </thead>
        <tbody>
            
                <tr><td colspan="5"> Выходной </td></tr>
            
        </tbody>
    </table>
</li></ul>
    </div>
</div></div>
</div></div>
        <div class="push"></div>
    </div>
    <br><br>
</div>
<div class="footer">

    
        <div class="right">
    <div class="banners opened" align="left">
      <div class="banner_mobile-apps" style="height: 143px;">
      
      
        
          <p><a href="https://itunes.apple.com/ru/app/moj-dnevnik/id557094374?mt=8" target="_blank">Мобильное приложение "Мой дневник" для iOS (Бесплатно)</a></p>
<p><a href="https://play.google.com/store/apps/details?id=ru.barsopen.mydiary&amp;hl=ru" target="_blank">Мобильное приложение "Мой дневник" для Android (Бесплатно)</a></p>
<p><a href="http://pd.rkn.gov.ru/multimedia/video114.htm" target="_blank">Обучающие материалы по защите персональных данных (Роскомнадзор)</a></p>
        
      
      </div>
      <span class="ico"></span>
    </div>
</div>

    

</div>

<div class="overlay"></div>
<div id="popup-region"></div>
<div id="tier-2-popup-region"></div>

<script type="text/javascript" src="/static/personal_area/js/vendor/backbone.marionette.js"></script>



    <script id="egegia-item-template" type="text/template">
    <td><%= $.datepicker.formatDate($.datepicker.regional.ru.dateFormat, exam_date) %></td>
    <td>
        <p><span class="color-link"><%= discipline_name %></span></p>
        <% if (task_a) { %>
        <p>А: <%= task_a %> </p>
        <% } %>
        <% if (task_b) { %>
        <p>B: <%= task_b %> </p>
        <% } %>
        <% if (task_c) { %>
        <p>C: <%= task_c %> </p>
        <% } %>
        <% if (task_d) { %>
        <p>D: <%= task_d %> </p>
        <% } %>
    </td>
    <td><%= point %></td>
    <td class="gr-<%= value %>"><%= value %></td>
</script>

<script id="egegia-collection-template" type="text/template">
    <thead>
    <tr>
        <th>
            <div>Дата</div>
        </th>
        <th>
            <div>Предмет</div>
        </th>
        <th>
            <div>Балл</div>
        </th>
        <th>
            <div>Оценка</div>
        </th>
    </tr>
    </thead>
    <tbody></tbody>
</script>

<script id="egegia-layout-template" type="text/template">
    <span class="line"></span>
    <div class="content_head gia-head">Результаты ОГЭ</div>
    <ul>
        <li class="gia-region"></li>
    </ul>
    <div class="content_head ege-head">Результаты ЕГЭ</div>
    <ul>
        <li class="ege-region"></li>
    </ul>
</script>

    <script id="training-item-template" type="text/template">
  <td><span><%= param_name %></span></td>
  <td><%= first_value %></td>
  <td><%= second_value %></td>
</script>

<script type="text/template" id="training-template">
  <span class="line"></span>
  <div class="content_head">
    <p><span>Медицинская группа:</span> <%= medical_group %></p>
    <p><span>Рекомендации врача:</span> <%= medical_advice %></p>
  </div>
  <ul>
    <li>
      <table>
        <thead>
        <tr>
          <th><div>Показатель</div></th>
          <th><div>В начале учебного года</div></th>
          <th><div>В конце учебного года</div></th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
    </li>
  </ul>
</script>

    <script type="text/template" id="portfolio-layout">

    <div class="top clearfix">
        <div class="left_el tab">
            <a href="#works">Творческие работы</a>
            <a href="#hobby">Мои увлечения</a>
            
                
                    <a href="#exams">ЕГЭ и ОГЭ</a>
                
            
            
            <a href="#training">Физическая подготовка</a>
            
            <a href="#achievements">Достижения</a>
        </div>
    </div>

    <div id="works"></div>
    <div id="hobby"></div>
    <div id="exams"></div>
    <div id="training"></div>
    <div id="achievements"></div>

</script>


    <script type="text/template" id="hobby-template">
  <span class="line"></span>
  <div class="content_head">
    <span>Увлечения</span>
    
  </div>
  <div class="content_body">
    <form>
      <textarea class="ckeditor-area" style="width: auto; height: 100%" name="hobby" cols="30" rows="10" disabled><%= hobby %></textarea>
    </form>
  </div>
</script>


    <script type="text/template" id="creations-template">
    <span class="line"></span>
    <div class="content_head">
        <span>Творческие работы, рефераты, проекты</span>
        
    </div>
    <div class="content_body">
        <ul class="listing"></ul>
    </div>
</script>

<script type="text/template" id="creation-template">
    
    <% if (document_url) { %>
    <a href="<%= document_url %>" class="btn blue fr" download><i class="ico load white"></i>Скачать</a>
    <% } %>
    <div class="img">
        <% if (preview_url) { %>
        <img src="<%= preview_url %>">
        <% } else { %>
        <span class="icon file <%= documentType %>"></span>
        <% } %>
    </div>
    <div class="list_content">
        <p><span class="color-link"><%= name %></span></p>
        <p><span class="color-link"><%= description %></span></p>
        <div class="file_info">
            <%= dateInstance.getDate() %> <%= dateInstance.getMonthName(true).toLowerCase() %> <%= dateInstance.getFullYear()+"г" %> <% if (document_url) { %><span class="point"><i></i></span> <span class="file_size"><%= document_size.toHumanReadableFileSize() %></span><% } %>
        </div>
    </div>
</script>

<script type="text/template" id="creation-add-template">
    <h6>Добавление работы</h6>
    <form id='my_form'>
        <div class="control load_file clearfix">
            <label>Файл</label>
            <div class="btn blue orange fr">Выбрать</div>
            <div class="input_wrap">
                <input type="text" value="<%= document_name %>" name="document_name">
                <span class="ico folder"></span>
                <input type="file" value="" name="document">
            </div>
        </div>
        <div class="control">
            <label>Название</label>
            <div class="input_wrap">
                <input type="text" name="name" value="<%= name %>" required>
            </div>
        </div>
        <div class="control">
            <label>Дата</label>
            <div class="input_wrap">
                <input type="text" name="date" value="<%= date %>" required>
            </div>
        </div>
        <div class="control">
            <label>Предмет</label>
            <div class="input_wrap discipline-combobox-region"></div>
        </div>
        <div class="control">
            <label>Руководитель</label>
            <div class="input_wrap master-combobox-region"></div>

        </div>
        <div class="control">
            <label>Описание</label>
            <div class="input_wrap">
                <textarea name="description" rows="4"><%= description %></textarea>
            </div>
        </div>

        <div class="clearfix">
            <button class="btn green fr">Сохранить</button>
            <div class="btn fr closable">Отмена</div>
        </div>
    </form>

    <span class="ico close-popup closable"></span>
</script>


    <script id="event-item-template" type="text/template">
  <td>
    <span class="color-link"><%= event_name %></span><% if (document_url) { %><a href="<%= document_url %>" download><i class="ico attachment"></i></a><% } %>
  </td>
  <td><%= level_name %></td>
  <td><%= $.datepicker.formatDate($.datepicker.regional.ru.dateFormat, date) %></td>
  <td><%= teacher_names.join(", ") %></td>
  <td><%= result %></td>
  <td><%= rating %></td>
</script>

<script id="events-template" type="text/template">
  <thead>
    <tr>
      <th>
        <div>Вид мероприятия</div>
      </th>
      <th>
        <div>Уровень проведения</div>
      </th>
      <th>
        <div>Дата</div>
      </th>
      <th>
        <div>Руководитель</div>
      </th>
      <th>
        <div>Результат участия</div>
      </th>
      <th>
        <div>Рейтинг</div>
      </th>
    </tr>
  </thead>
  <tbody></tbody>
</script>


<script id="events-empty-template" type="text/template">
  <thead>
    <tr>
      <th>
        <div>Вид мероприятия</div>
      </th>
      <th>
        <div>Уровень проведения</div>
      </th>
      <th>
        <div>Дата</div>
      </th>
      <th>
        <div>Руководитель</div>
      </th>
      <th>
        <div>Результат участия</div>
      </th>
      <th>
        <div>Рейтинг</div>
      </th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="6" style="text-align: center">нет</td></tr>
  </tbody>
</script>

<script id="achievement-item-template" type="text/template">
  <td><%= $.datepicker.formatDate($.datepicker.regional.ru.dateFormat, dateInstance) %></td>
  <td><span class="color-link"><%= description %></span>
  </td>
  <td class="file">
    <% if (document_url) { %>
    <div class="img">
      <a href="<%= document_url %>" download>
        <% if (preview_url) { %>
        <img src="<%= preview_url %>">
        <% } else { %>
        <span class="icon file <%= documentType %>"></span>
        <% } %>
      </a>
    </div>
    <% } %>
    
  </td>
</script>

<script id="achievements-template" type="text/template">
  <thead>
  <tr>
    <th>
      <div>Дата</div>
    </th>
    <th>
      <div>Описание</div>
    </th>
    <th>
      <div>Файл</div>
    </th>
  </tr>
  </thead>
  <tbody></tbody>
</script>

<script id="achievements-empty-template" type="text/template">
  <thead>
  <tr>
    <th>
      <div>Дата</div>
    </th>
    <th>
      <div>Описание</div>
    </th>
    <th>
      <div>Файл</div>
    </th>
  </tr>
  </thead>
  <tbody><tr><td colspan="3" style="text-align: center">нет</td></tr></tbody>
</script>

<script id="achievements-layout-template" type="text/template">
  <span class="line"></span>
  <div class="content_head events-head">Сведения об участии в мероприятиях</div>
  <ul>
    <li class="events-region"></li>
  </ul>
  <div class="content_head">
    <span>Полученные дипломы, сертификаты и др. (без учета данных в первой секции)</span>
    
  </div>
  <ul>
    <li class="achievements-region"></li>
  </ul>
</script>


<script id="achievement-add-template" type="text/template">
    <h6>Награды и достижения учащегося, добавление</h6>
    <form>
      <div class="control">
        <label for="achievement-date-input">Дата</label>
        <div class="input_wrap"><input id="achievement-date-input" type="text" name="date" value="<%= date %>" required></div>
      </div>
      <div class="control load_file clearfix">
        <label for="achievement-document-input">Файл</label>
        <div class="btn blue orange fr">Выбрать</div>
        <div class="input_wrap">
          <input id="achievement-document-input" type="text" value="<%= document_name %>" name="document_name">
          <span class="ico folder"></span>
          <input type="file" value="" name="document">
        </div>
      </div>
      <div class="control">
        <label for="achievement-description-input">Описание</label>
        <div class="input_wrap"><textarea name="description" id="achievement-description-input" required rows="4"><%= description %></textarea></div>
      </div>
      <div class="clearfix">
        <input class="btn green fr" type="submit" value="Сохранить">
        <button class="btn fr closable">Отмена</button>
      </div>
    </form>

    <span class="ico closable"></span>
</script>

    <script type="text/template" id="selectbox-item"><%- name %></script>

<script type="text/template" id="selectbox">
  <input type="text" name="<%- fieldName %>" id="valueField" hidden>
  <div class="">
    <input type="text" id="display" autocomplete="off" <% if (required) { %>required<% } %>>
    <div class="selectbox-trigger">
      <i class="arrow"></i>
    </div>
  </div>
  <ul class="selectbox-select"></ul>
</script>

    <script id="menu-template" type="text/template">
</script>

<script id="menu-item" type="text/template">
    <a href="<% if (url.indexOf('http') == 0) { %><%= url %><% } else { %>#<%= url %><% } %>">
        <i></i>
        <%= text %>
        <% if (count) { %>
          <span class="hint"><%= count %></span>
        <% } %>
        <span class="ico"></span>
    </a>
    <% if (!_.isEmpty(submenu)) { %>
    <div class="sub_menu" style="display: none;">
        <ul></ul>
        <span class="arrow"></span>
    </div>
    <% } %>
</script>


<script type="text/template" id="submenu-item-template">
    <a href="#<%= url %>">
        <%= text %>
        <% if (count) { %>
            <span class="hint"><%= count %></span>
        <% } %>
        <span class="ico"></span>
    </a>
</script>

    <script type="text/template" id="events-collection-template">
    <h3>Мероприятия</h3>
    <ul></ul>
    <div class="btn rnd green open_list"><i class="ico arrow"></i></div>
</script>

<script type="text/template" id="events-item-template">
   <span><%= date_str %></span> - <%= theme %>
</script>


    <script id="meeting-widget-template" type="text/template">
    <h3>Родительское собрание</h3>
    <div class="date"><%= date %></div>
    <div class="time-place"><span><%= begin %>-<%= end %></span>Каб. <%= office %></div>
    <% if (protocol) { %>
    <a href="<%= protocol %>" class="btn green info download-url" download>протокол<span class="ico"></span></a>
    <% } %>
</script>

<script id="empty-widget" type="text/template">
    
</script>

    <script type="text/template" id="confirm-remove-template">
<div class="popup">
   <div class="one clearfix">
    <p><%= text %></p>
  </div>

  <div class="clearfix">
    <button class="<%= ok_btn_class %> ok-button"><%= ok_btn_label %></button>
    <div class="btn fr cancel-button close-popup">Отмена</div>
  </div>

  <span class="ico close-popup"></span>
</div>
</script>

    <script id="classhour-widget-template" type="text/template">
    <h3>Классный час</h3>
    <div class="date"><%= date %></div>
    <div class="time-place"><span><%= begin %>-<%= end %></span></div>
    <div><%= place %></div>
    <div class="time-place"><span><%= theme %></span></div>
</script>

    <script id="datepicker-widget-template" type="text/template">
        <div class="right_el calendar">
            <div class="calendar_btn pick-activator">
                <span class="ico"></span>
            </div>
            <div class="calendar_wrap">
                <div class="datepicker"></div>
            </div>
        </div>
        <div class="date-panel"

        </div>
</script>


<script id="datepicker-widget-panel-template" type="text/template">
    <% if(style == "week"){ %>
        <div class="right_el sel_week">
            <a class="prev"><span class="ico"></span></a>
            <a class="next"><span class="ico"></span></a>
            <div class="container">
                <span>
                    <%= weekBegin.getDateStringZeroed() %>
                    <span>
                        <%= weekBegin.getMonthStringZeroed() %>
                        <br/>
                        <%= weekBegin.getDayShortName() %>
                    </span>
                </span>  &ndash;
                <span>
                    <%= weekEnd.getDateStringZeroed() %>
                    <span>
                        <%= weekEnd.getMonthStringZeroed() %>
                        <br/>
                        <%= weekEnd.getDayShortName() %>
                    </span>
                </span>
            </div>
        </div>
    <% } else if (style == "month"){ %>
        <div class="right_el sel_week">
            <a class="prev"><span class="ico"></span></a>
            <a class="next"><span class="ico"></span></a>
            <div class="container month" >
                <span>
                   <%= date.getMonthName() %>
                </span>
            </div>
        </div>

    <% } else if (style == "day"){ %>
        <div class="right_el sel_week pick-activator" style="width: 32px;">
            <div class="container day" >
                <span>
                    <%= date.getDateStringZeroed() %>
                    <span>
                        <%= date.getMonthStringZeroed() %>
                        <br/>
                        <%= (date.getFullYear() + "") .slice(2,4) %>
                    </span>
                </span>
            </div>
        </div>
    <% }; %>
</script>


    <script type="text/template" id="birthdays-collection-template">
    <h3>Дни рождения</h3>
    <span></span>
</script>

<script type="text/template" id="birthday-item-template">
    <% if (!photo) { %>
        <img src="/static/personal_area/images/<% if (male) { %>pupil-men.png<% } else { %>pupil-women.png<% } %>">
    <% } else { %>
        <img src="<%= photo %>">
    <% } %>
    <p><%= short_name %><br/><span class="today"><%= date %></span></p>
</script>

    <script id="behaviour-maskable-template" type="text/template">
    <div class="view-mask">
        <div class="view-overlay">
            <div class="imgwrap" style="position: absolute; left:0; right: 0;">
                <img width="<%= img_width %>" height="<%= img_height %>"
                     align="middle"
                     src="<%= img_src %>"
                     style="display: block; margin-left: auto; margin-right: auto;">
            </div>
        </div>
    </div>
</script>

<script id="tab-maskable-template" type="text/template">
    <div class="overlay-tab">
        <div class="tab-icon" style="background: url(<%= img_src %>) no-repeat 28px 26px;">
            <div class="loader">
            </div>
        </div>
    </div>
</script>


    <div class="title">
    <p>У ученика стоит точка за урок!</p>
</div>
<div class="portfolio">
        <div class="content">
        <ul><li>
            <table>
                <thead>
                    <tr>
                        <th width="25%"><div>Дата урока</div></th>
                        <th width="28%"><div>Время урока</div></th>
                        <th><div>Предмет</div></th>
                    </tr><tr>
                </tr></thead>
                <tbody>
                    
                </tbody>
            </table>
        </li></ul>
    </div>
</div>


    <script id="diary-main-template" type="text/template">
    <div class="top clearfix">
        <div class="left_el close_all"><span>Свернуть все</span></div>
        <div class="left_el today"><span>Сегодня</span></div>
        <div id="for-datepicker"></div>
    </div>
    <div id="for-content"></div>
</script>

<script id="week-template" type="text/template">
    <div class="content">
        <span class="line"></span>
        <ul class="dynamic"></ul>
    </div>
</script>

<script id="weekday-template" type="text/template">
    <div class="weekday_header cursor_pointer clearfix">
        <div class="date"><%= date.getDate() %>/<span><%= date.getMonthStringZeroed() %></span></div>
        <div class="week_day"><%= date.getDayName() %></div>
        <div class="text">Сегодня</div>
        <span class="ico arrow"></span>
    </div>
    <table <%= dayOff ? 'class="not"': '' %>>
        <thead>
        <tr>
            <th width="5%"><div>Время</div></th>
            <th width="20%"><div>Предмет</div></th>
            <th width="30%"><div>Тема</div></th>
            <th width="30%"><div>Домашнее задание</div></th>
            <th width="5%"><div>Файл</div></th>
            <th width="10%"><div>Посещаемость</div></th>
            <th width="5%"><div>Оценка</div></th>
            <th width="15%"><div>Учитель</div></th>
        </tr>
        </thead>
        <tbody>
            <% if(dayOff){ %>
                <tr><td colspan="5"> <%= dayOff %> </td></tr>
            <% }; %>
        </tbody>
    </table>
</script>

<script id="lesson-row-template" type="text/template">
    <td><%= studyTime %><br/><%= idx %> урок <br/><%= timeBegin %></td>
    <td><%= discipline %></td>
    <td><%= theme %></td>
    <td class="homework">
        <%= homework %>
        <% if(ind_homework_exists){ %><strong>Имеется И.Д.З.</strong><%}%>
    </td>
    <td class="load">
        <% _.each(materials, function(item) { %>
            <a href="<%= item.url %>" target="_blank" download title="<%= item.name %>"></a>
        <% }) %>
    </td>
    <td><%= attendance %></td>
    <td class="assessment" id="mark-comment-container">
    </td>
    <td><%= teacher %></td>
    // 
</script>

<script id="mark-comment-template" type="text/template">
<div class="hack">
    <span title="<%= mark_type %>" ><%= mark %></span>
    <% if (comment || remarks) { %>
    <span class="ico comment"></span>
    <div class="popup comment">
        <div class="title"><p><span class="up">Комментарий:</span></p></div>
        <span>
            <%= comment %>
            <% if (remarks) { %>
                <br /><b>Замечание:</b> <%- remarks %>
            <% } %>
        </span>
        <span class="ico closable"></span>
    </div>
    <% } %>
</div>
</script>

<script id="lesson-info-template" type="text/template">
    <div class="title">
        <p><%= discipline %></p>
        <p><%= teacher %><br/><%= date.getDate() %> <%=date.getMonthName(true)%> <%=date.getFullYear() %></p>
    </div>
    <p><span class="up">Тема урока:</span><br/><%= theme %></p>
    <p>
        <span class="up">Домашнее задание:</span><br/>
        <div class="homework"><%= homework %></div>
        <% if(ind_homework_exists){ %><br/> Имеется И.Д.З.<%}%>
    </p>
    <p><span>Вид урока:</span><br/><%= schedulelessontype %></p>
    <% _.each(materials, function(item) { %>
        <p class="bottom clearfix">
            <a href="<%= item.url %>" class="load"><span class="ico"></span><%= item.name %></a>
            <a href="<%= item.url %>" download>Скачать</a>
            <% if (!(item.name.endsWith('.html') || item.name.endsWith('.htm'))) { %>
                <a href="<%= item.url %>" target="_blank">Посмотреть</a>
            <% } %>
        </p>
    <% }) %>
    <!-- // Пока не ясно что здесь отображать
        <p class="bottom clearfix">
        <a href="" class="load"><span class="ico"></span>Карта СССР 30х годов.jpg</a>
        <a href="">Скачать</a>
        <a href="">Посмотреть</a>
    </p> -->
    <span class="ico closable"></span>
</script>


    <script type="text/template" id="homework-layout-template">
    <div class="top clearfix">
        <div class="left_el select">
            <span>Предмет</span>
            <span class="selectbox" id="discipline-filter"></span>
        </div>
        <div id="homework-datepicker-widget"></div>
    </div>
    <div id="content"></div>
</script>

<script type="text/template" id="homework-weekdays-template">
    <span class="line"></span>
    <ul class="dynamic"></ul>
</script>

<script type="text/template" id="homework-weekday-template">
    <div class="weekday_header cursor_pointer clearfix">
        <div class="date"><%= date.getDateStringZeroed() %>/<span><%= date.getMonthStringZeroed() %></span></div>
        <div class="week_day"><%= date.getDayName() %></div>
        <div class="count">
            <% if (count) { %>
                Уроков: <%= count %>
            <% } else { %>
                Не задано
            <% } %>
        </div>
        <div class="text">Сегодня</div>
        <span class="ico arrow"></span>
    </div>
    <table>
        <tbody></tbody>
    </table>
</script>

<script type="text/template" id="homework-template">
    <td width="30"><%= index %></td>
    <td class="lesson" width="220"><%= discipline %></td>
    <td class="homework">
        <span><%= homework %></span>
        <% _.each(individualHomeworks, function(item) { %>
            <div class="ind">
                <strong>И.Д.З. </strong> <%= item.description %>
                <% if (item.document.url ) { %>
                    <br>
                    <strong>ФАЙЛ: </strong> <a href="<%= item.document.url %>" target="_blank" download><%= item.document.name %></a>
                <% } %>
            </div>
        <% }) %>
    </td>
    <td class="load">
        <% _.each(materials, function(item) { %>
            <a href="<%= item.url %>" target="_blank" download title="<%= item.name %>"></a>
        <% }) %>
    </td>
</script>

<script type="text/template" id="homework-info-view">
    <div class="title">
        <p><%= discipline %></p>
        <p><%= teacher %> <br/><%= date.getDate() %> <%= date.getMonthName(true) %> <%= date.getFullYear() %></p>
    </div>
    <p><span class="up">Тема урока:</span><br/><%= theme %></p>
    <p>
        <span class="up">Домашнее задание:</span>
        <br/>
        <div class="homework"><%= homework %></div>
    </p>
    <p><span>Вид работы:</span> <%= schedulelessontype %></p>
    <% _.each(materials, function(item) { %>
        <p class="bottom clearfix">
            <a href="<%= item.url %>" class="load"><span class="ico"></span><%= item.name %></a>
            <a href="<%= item.url %>" download>Скачать</a>
            <% if (!(item.name.endsWith('.html') || item.name.endsWith('.htm'))) { %>
                <a href="<%= item.url %>" target="_blank">Посмотреть</a>
            <% } %>
        </p>
    <% }) %>
    <span class="ico close-popup closable"></span>
</script>


    <script id="schedule-template" type="text/template">
    <div class="top clearfix">
        <div class="left_el tab ">
            <a href="#schedule/week">Неделя</a>
            <a href="#schedule/month">Месяц</a>
        </div>

        <div class="left_el print"><a class=""></a></div>
        <div class="datepicker-widget">
        </div>
    </div>

    <div id="week-schedule">
        <div class="content" id="week">
        </div>
    </div>

    <div id="month-schedule">
        <div class="content" id="month">
        </div>
    </div>
</script>

<!-- Schedule by Weekday Templates -->

<script id="weekschedule-template" type="text/template">
    <div class="line"></div>
    <ul class="dynamic">

    </ul>
</script>

<script id="weekschedule-oneday-template" type="text/template">
    <div class="clearfix">
        <div class="date"><%= date.getDate() %>/<span><%= date.getMonthStringZeroed() %></span></div>
        <div class="week_day"><%= date.getDayName() %></div>
        <div class="count">
        <% if(dayOff){ %>
            <%= dayOff %>
        <% }else{ %>
            Уроков: <%= lessons.length %>
        <% }; %>
        </div>
        <div class="text">Сегодня</div>
        <span class="ico arrow"></span>
    </div>
    <table <%= dayOff ? 'class="not"': '' %>>
        <tbody>
            <% if(dayOff){ %>
                <tr><td> <%= dayOff %> </td></tr>
            <% }; %>
        </tbody>
    </table>
</script>

<script id="weekschedule-lesson-template" type="text/template">
    <td><%= studyTime %><br/><%= index %> урок</td>
    <td class="time"><span><%= getHours(timeBegin) %><span><%= getMinute(timeBegin) %></span></span>-<span><%= getHours(timeEnd) %><span><%= getMinute(timeEnd) %></span></span></td>
    <td>
        <p><%= discipline %></p>
        <p><%= teacher %><br/> <%= office %></p>
    </td>
</script>

<!-- Schedule by Month Templates -->

<script id="monthschedule-template" type="text/template">
    <div class="line"></div>
    <ul>
        <li>
            <table>
                <colgroup>
                    <col class="first"/>
                    <col/>
                    <col/>
                    <col/>
                    <col/>
                    <col/>
                    <col/>
                    <col/>
                </colgroup>
                <thead>
                    <tr>
                        <th><div></div></th>
                        <th class="mon"><div>Понедельник</div></th>
                        <th><div>Вторник</div></th>
                        <th><div>Среда</div></th>
                        <th><div>Четверг</div></th>
                        <th><div>Пятница</div></th>
                        <th><div>Суббота</div></th>
                        <th><div>Воскресенье</div></th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </li>
    </ul>
</script>


<script id="monthschedule-firsttd-template" type="text/template">
    <div>
        <div class="rotate">
            <span><%= index %></span>
            неделя
        </div>
    </div>
</script>


<script id="monthschedule-oneday-template" type="text/template">
    <div>
        <div>
            <div class="date"><span><%= date.getDate() %>/<span><%= date.getMonthStringZeroed() %></span></span></div>
            <% if(dayOff){ %>
                <span "dayoff"><%= dayOff %><span>
            <% }else{ %>
                <ol>
                <% _(lessons).each(function(l) { %>
                    <li><%= l.index %> <%= l.discipline %></li>
                <% }); %>
                </ol>
            <% }; %>
            <% if ( date.isToday() ) { %>
            <div class="text">cегодня</div>
            <% }; %>
        </div>
    </div>
</script>


    <script id="profile-template" type="text/template">
    <div class="content">
        <span class="line"></span>
        <div id="user-info-container" class="clearfix">
        </div>
        <ul>
            <li>
                <div class="clearfix">
                    
                </div>
                <table>
                    <tbody id="children-container">
                    </tbody>
                </table>
            </li>
        </ul>
    </div>
</script>


<script id="user-info-template" type="text/template">
    <div class="user_ava">
        <img src="<%= user_ava_url %>">
        <p><span class="cursor_pointer ava_change">
            <% if (user_has_ava) { %>Сменить <% } else { %>Загрузить <% } %>аватар
        </span></p>
        <% if (user_has_ava) { %>
        <p><span class="cursor_pointer ava_remove">Удалить аватар</span></p>
        <% }; %>
    </div>
    <div class="user_info">
        <div id="profile-btn-container"></div>
        <p class="fullname"><%= fullname %></p>
        <div>
            
            <p><span>Организация:</span>&nbsp;<%= school %></p>
            <p><span>Класс:</span>&nbsp;<%= classyear %></p>
            
            <p><span>E-mail:</span>&nbsp;<%= email %></p>
            
        </div>
    </div>
</script>


<script id="child-template" type="text/template">
    <img src="<%= ava_url %>"/>
    <div id="child-container">
        <p><%= fullname %></p>
        <div>
            <p><span>Организация:</span> <%= school %></p>
            <p><span>Класс:</span><%= classyear %></p>
            <p><span>E-mail:</span><%= email %></p>
        </div>
    </div>
    <a class="btn green brown">Выбрать</a>
</script>


<script id="profile-btn-template" type="text/template">
    Редактировать профиль
</script>


<script id="user-info-edit-template" type="text/template">
    <div class="title"><p>Редактировать профиль</p></div>
    <div class="title"><p>Смена пароля</p></div>
    <form id="password" class="clearfix">
        <label class="clearfix">Старый пароль <input type="password" name="old" value=""/></label>
        <label class="clearfix">Новый пароль <input type="password" name="new" value=""/></label>
        <label class="clearfix">Подтверждение <input type="password" name="repeat" value=""/></label>
        <p><a id="change-pass" class="close-popup btn green brown">Сменить пароль</a></p>
    </form>
    <div class="title"><p>Электронная почта</p></div>
    <form id="email" class="clearfix">
        <label class="clearfix">Эл.почта <input type="text" name="email" value="<%= email %>"/></label>
        <p><a id="change-email" class="close-popup btn green brown">Сменить e-mail</a></p>
    </form>
    
    <span class="ico closable"></span>
</script>


    <script id="header-widget-template" type="text/template">
    <span class="logo"><a href="/personal-area/"></a></span>
    <div></div>
</script>


<script id="today-template" type="text/template">
    <div class="day"><%= day %></div>
    <span><%=month%> /
        <span><%=weekDayName%></span><br/>
        <span class="year"><%=year%></span>
    </span>
</script>

<script id="profile-header-template" type="text/template">
    <div class="menu-item profile">
        <!-- // ФИО и аватар выбранного ребенка (совпадает с пользователем, когда пользователь - ребенок) -->
        <p>
            <%= selected_pupil_name %>
            <img src=<%= selected_pupil_ava_url %> title="<%= selected_pupil_name %>" alt="<%= selected_pupil_name %>" />
        </p>
        <span class="arrow"></span>
        <div class="more">
            <div class="clearfix">
                <!-- // ФИО и аватар текущего пользователя -->
                <img src=<%= user_ava_url %> />
                <div>
                    <p>
                        <%= user_fullname %><br/>
                        <span><%= user_desc %></span>
                    </p>
                    <a class="go_profile btn green brown">Профиль</a>
                </div>
                
            </div>
            <div class="links clearfix">
                
                <a class="logout" href="/auth/force-logout">Выход<span class="ico"></span></a>
            </div>
            <span class="corner top"><span></span></span>
        </div>
    </div>
</script>

<script id="indicator-template" type="text/template">
    <div class="gpa">
        <div>
            <ul></ul>
        </div>
        <span class="arrow up"></span>
        <span class="arrow down"></span>
    </div>
</script>

<script id="indicator-item-template" type="text/template">
    <span><%= name %></span><span class="<%= css %>"><%= value %></span>
</script>


    <script id="marks-template" type="text/template">
    <div class="top clearfix">
        <div class="left_el tab ">
            <a href="#marks/summary">Сводная</a>
            <a href="#marks/total">Итоговые</a>
            <a href="#marks/visual">Визуализация</a>
        </div>
        <div class="datepicker-widget">
        </div>
    </div>

    <div id="summary-marks">
        <div class="content" id="summary">
        </div>
    </div>

    <div id="total-marks">
        <div class="content" id="total">
        </div>
    </div>

    <div id="visual-marks">
        <div class="content" id="visual">
        </div>
    </div>    
</script>

<!-- Summary Marks Template -->
<script id="summarymarks-template" type="text/template">
    <span class="line"></span>
    <ul>
        <li>
            <table>
                <colgroup>
                    <col class="fix_col"/>
                    <col/>
                    <col class="fix_col"/>
                </colgroup>
                <thead>
                <tr>
                    <th><div>Предмет</div></th>
                    <th><div>Дата (<%= subperiod.name %>)</div></th>
                    <th><div>Средняя оценка</div></th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>
                        <div>
                            <table class="table_first_col">
                                <thead><tr><th><div></div></th></tr></thead>
                                <tbody>
                                <% _.each( discipline_marks, function(val, key){ %>
                                    <tr><td><%= val.discipline %></td></tr>
                                <% }); %>
                                </tbody>
                            </table>
                        </div>
                        <div class="crop"></div>
                    </td>
                    <td class="table_cont">
                        <div>
                            <table>
                                <thead>
                                <tr>
                                    <% _.each( dates, function(date){ %>
                                        <th><div><%= fromatedDate(date) %></div></th>
                                    <% }); %>
                                </tr>
                                </thead>
                                <tbody>
                                <% _.each( discipline_marks, function(dmark){ %>
                                <tr>
                                    <% dateMarks = markGroup(dmark); %>
                                    <%  _.each(dates, function(date){ %>
                                        <td class="<%- (selectedDate == date) ? 'selected': '' %>"
                                            title="<%- _(dateMarks[date]).pluck('description').join(' / ') %>">
                                          <%- _(dateMarks[date]).pluck('mark').join(' / ') %>
                                        </td>
                                    <% }); %>
                                </tr>
                                <% }); %>
                                </tbody>
                            </table>
                        </div>
                        <div class="crop"></div>
                    </td>
                    <td id="last" class="avg_score_col">
                        <div>
                            <table>
                                <thead><tr><th><div></div></th></tr></thead>
                                <tbody>
                                <% _.each( discipline_marks, function(dmark){ %>
                                <% 
                                	var avg = dmark["average_mark"] || 0,
                                		className = "";
                                	if(avg<3){
                                		className = "gr-2";
                                	}else if( avg<4){
                                		className = "gr-3";
                                	}
                                %>
                                <tr>
                                	<td class="<%= className %>">
                                	<%= (avg || "") %>
                                	</td>
                                </tr>
                                <% }); %>                           
                                </tbody>
                            </table>
                        </div>
                        <div class="crop"></div>
                    </td>
                </tr>
                </tbody>
            </table>
            <span class="ico"></span>
            <span class="ico right"></span>
        </li>
    </ul>
</script>


<!-- Total Marks Template -->
<script id="totalmarks-template" type="text/template">
    <div class="line"></div>
    <ul>
        <li>
            <table>
                <thead>
                <tr>
                    <th><div>Предмет</div></th>
                    <% _.each( subperiods, function(sp){ %>
                        <th><div><%= sp.name %></div></th>
                    <% }); %>
                </tr>
                </thead>
                <tbody>

                <% _.each( discipline_marks, function(dm){ %>
                    <tr>
                    <td><%= dm.discipline %></td>
	                <% 
	                var totals = _(dm.period_marks).indexBy("subperiod_code");
                    _.each( subperiods, function(sp){

	                	var val = (totals[sp.code] && totals[sp.code].mark) || 0;

	                	className = "";
	                	if(val < 3){
	                		className = "gr-2";
	                	}else if( val < 4){
	                		className = "gr-3";
	                	}
	                %>                    
                    	<td class="<%= className %>"><%= (val || "") %></td>
                    <% }); %>
                    </tr>
                 <% }); %> 

                </tbody>
            </table>
            <span class="ico"></span>
        </li>
    </ul>
</script>

<!-- Visual Marks Template -->
<script id="visualmarks-template" type="text/template">
    <div class="line"></div>

    <div class="top params">
        <div class="left_el select chart-type">
            <span>График:</span>
            <select class="styled" style="width: 130px">
                <option selected value="attendance">Посещаемость</option>
                <option value="progress">Успеваемость</option>
            </select>
        </div>
        <div class="left_el select chart-discipline">
            <span>Предмет:</span>
            <select class="styled" style="width: 220px">
                <option selected value="0">Все</option>
                <% _(disciplines).each(function(discipline){ %>
                <option value="<%= discipline.id %>"><%= discipline.name %></option>
                <% }); %>
            </select>
        </div>

        <div class="datepicker-widget date-to">
        </div>

        <div class="right_el sel_week" style="width: 18px; margin: 0px -15px 0px -3px;">
            <div class="container"> &ndash; </div>
        </div>

        <div class="datepicker-widget date-from">
        </div>

    </div>

    <div class="container charts-container">
    </div>
</script>


<script id="visualmarks-chartspanel-template" type="text/template">
    <div class="content" id="chart-panel">

        <div class="content" id="chart-subpanel1">
        </div>

        <div class="content" id="chart-subpanel2">
        </div>

    </div>
</script>


    
<script type="text/template" id="school-tab">
    <div class="top clearfix">
        <div class="left_el tab">
            <a href="#school/common" class="active">Школа</a>
            <a href="#school/classyear">Класс</a>
        </div>
    </div>
    <div id="school-school">
        <div class="content" id="school"></div>
    </div>
    <div id="school-class">
        <div class="content" id="class"></div>
    </div>
</script>


<script type="text/template" id="school-template">
    <span class="line"></span>
    <div class="school-container">
        <div class="school-wrapper">
            <div class="title clearfix">
                <% if (ustav) { %>
                  <a href="<%= ustav %>" class="btn big2"><span class="ico charter"></span> Устав организации</a>
                <% } %>
                <h1><%= name %></h1>
            </div>
            <% if (!photo) { %>
                <img src="/static/personal_area/images/school-photo.png" class="school-photo"/>
            <% } else { %>
                <img src="<%= photo %>" class="school-photo"/>
            <% } %>
            <table class="info">
                <tbody>
                <tr>
                    <td><p><span class="ico address"></span>Адрес организации:</p></td>
                    <td><%= address %></td>
                </tr>
                <tr>
                    <td><p><span class="ico phone"></span>Телефон организации:</p></td>
                    <td><%= phone %></td>
                </tr>
                <tr>
                    <td><p><span class="ico mail"></span>E-mail организации:</p></td>
                    <td><a href="mailto:<%= email %>"><%= email %></a></td>
                </tr>
                <tr>
                    <td><p><span class="ico website"></span>Адрес сайта:</p></td>
                    <td><a href="<%= site_url %>"><%= site_url %></a></td>
                </tr>
                <tr>
                    <td><p><span class="ico employee"></span>Количество сотрудников:</p></td>
                    <td><%= count_employees %></td>
                </tr>
                <tr>
                    <td><p><span class="ico pupil"></span>Количество учеников:</p></td>
                    <td><%= count_pupils %></td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="clearfix"></div>
    </div>
    <ul class="dynamic"></ul>
</script>


<script type="text/template" id="employees-group">
    <div class="clearfix cursor_pointer">
        <div class="title"><%= group() %></div>
        <span class="ico arrow"></span>
    </div>
    <table>
        <tbody></tbody>
    </table>
</script>


<script type="text/template" id="employee-cell">
    <% if (!photo) { %>
        <img src="/static/personal_area/images/<% if (male) { %>teacher-men.png<% } else { %>teacher-women.png<% } %>"/>
    <% } else { %>
        <img src="<%= photo %>" width="80" />
    <% } %>
    <div>
        <p><%= fullname %></p>
        <p>
            <% _.each(employer_jobs, function(item) { %>
                <%= item %><br />
            <% }) %>
        Категория: <%= category %></p>
    </div>
</script>


<script type="text/template" id="classyear">
    <span class="line"></span>
    <div class="clearfix">
        <% if (!photo) { %>
            <img src="/static/personal_area/images/class-photo.png"/>
        <% } else { %>
            <img src="<%= photo %>"/>
        <% } %>
        <p><span><%= study_level %><span><%= letter %></span></span><%= specialization %></p>
        <div class="clearfix">
            <% if (!form_master_photo) { %>
                <img src="/static/personal_area/images/<% if (form_master_male) { %>teacher-men.png<% } else { %>teacher-women.png<% } %>"/>
            <% } else { %>
                <img src="<%= form_master_photo %>" width="80" />
            <% } %>
            <p>
                <span>Классный руководитель:</span><br/>
                <%= form_master %>
            </p>
        </div>
    </div>
    <ul>
        <li>
            <div class="clearfix">
                <div class="title">Мой класс</div>
            </div>
            <table>
                <tbody></tbody>
            </table>
        </li>
    </ul>
</script>


<script type="text/template" id="pupil-cell">
    <% if (!photo) { %>
        <img src="/static/personal_area/images/<% if (male) { %>pupil-men.png<% } else { %>pupil-women.png<% } %>"/>
    <% } else { %>
        <img src="<%= photo %>" width="80" />
    <% } %>
    <div>
        <p><%= fullname %></p>
    </div>
</script>

<script type="text/template" id="empty-cell">
    
</script>


    <script id="contingent-event-item-template" type="text/template">
  <td><%- date %></td>
  <td><span class="color-link"><%- event_name %></span></td>
  <td><%- event_type %></td>
  <td><%- level_name %></td>
  <td><%- result_name %></td>
  <td><%- rank %></td>
  <td><%= document_url %></td>
</script>

<script id="contingent-events-template" type="text/template">
  <thead>
    <tr>
      <th><div>Дата</div></th>
      <th><div>Наименование</div></th>
      <th><div>Вид мероприятия</div></th>
      <th><div>Уровень проведения</div></th>
      <th><div>Результат участия</div></th>
      <th><div>Завание/Разряд</div></th>
      <th><div>Файл</div></th>
    </tr>
  </thead>
  <tbody></tbody>
</script>

<script id="contingent-events-empty-template" type="text/template">
  <thead>
    <tr>
      <th><div>Дата</div></th>
      <th><div>Наименование</div></th>
      <th><div>Вид мероприятия</div></th>
      <th><div>Уровень проведения</div></th>
      <th><div>Результат участия</div></th>
      <th><div>Завание/Разряд</div></th>
      <th><div>Файл</div></th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="7" style="text-align: center">нет</td></tr>
  </tbody>
</script>


    <script id="gveegegia-layout-template" type="text/template">
    <span class="line"></span>
    <div class="content_head gia-head">Результаты ОГЭ</div>
    <ul>
        <li class="gia-region"></li>
    </ul>
    <div class="content_head ege-head">Результаты ЕГЭ</div>
    <ul>
        <li class="ege-region"></li>
    </ul>
    <div class="content_head gve-head">Результаты ГВЭ</div>
    <ul>
        <li class="gve-region"></li>
    </ul>
</script>

    

<script type="text/template" id="school-meals-view">
<iframe src="<%= url %>" width="100%" height="660px" style="border: 0px;"></iframe>
</script>

    <script id="feedback-main-template" type="text/template">
    <div class="top clearfix">
        <div id="for-datepicker"></div>
    </div>
    <div id="for-content"></div>
</script>

<script type="text/template" id="feedback-messages" xmlns="http://www.w3.org/1999/html">
<div class="feedback content">
    <div class="content_head">Обращение, созданное с использованием сервиса обратной связи, не является обращением в рамках Федерального закона &quot;О порядке рассмотрения обращений граждан Российской Федерации&quot; от 02.05.2006 N 59-ФЗ. Сервис обратной связи предназначен для улучшения работы АИС &quot;Электронная школа&quot;.</div>
    <span class="line"></span>
    <div class="top clearfix">
        <div class="left_el default">
            <a data-popup="feedback-new-message" href="" class="new-message btn thin green">Создать</a>
        </div>
        <div class="showMessage left_el default">
          <a href="" class="btn thin green">Просмотр</a>
        </div>
        <div class="left_el default">
            <a href="" class="refresh btn thin green">Обновить</a>
        </div>
        <div class="right_el">
            <input type="text" class="feedback-search" placeholder="Поиск" id="text" value="">
        </div>
    </div>
    <ul>
        <li>
            <table>
                 <thead>
                    <tr>
                        <th width="10%"><div>Дата создания</div></th>
                        <th width="10%"><div>Дата последнего обновления</div></th>
                        <th width="30%"><div>Рубрика</div></th>
                        <th width="5%"><div>ID</div></th>
                        <th width="35%"><div>Тема</div></th>
                        <th width="20%"><div>Статус</div></th>
                    </tr>
                 </thead>
                 <tbody></tbody>
             </table>
        </li>
    </ul>
    <div class="content_footer clearfix">
      <div class="fr paging2"></div>
      <span><%- getPagingInfo() %></span>
    </div>
</div>
</script>


<script type="text/template" id="feedback-message">
  <td><%= date %></td>
  <td><%= update_date %></td>
  <td><%= rubric %></td>
  <td><%= id %></td>
  <td><a href="" data-popup="feedback-full-message" href="" class="full-message feedback-title"><%= title %></a></td>
  <td><%= status %></td>
</script>


<script type="text/template" id="feedback-full-message">
<div class="popup w540 ">
  <div class="popup_header">
    <h6 class="wrapped_text"><%- title %></h6>
    <p class="wrapped_text">Дата создания: <%- date %></p>
    <p class="wrapped_text">Рубрика: <%- rubric %></p>
    <p class="wrapped_text">Ребенок: <%- child %></p>
    <p class="wrapped_text">Организация: <%- school %></p>
  </div>
  <p class="file_list_title">Вопрос:</p>
  <p class="wrapped_text scrollable"><%= text.replace(/([^>])\n/g, '$1<br/>') %></p>
  <% if (attachment_url) { %>
    <p class="file_list_title">Вложение:</p>
    <p class="bottom clearfix" style="display:inline-flex">
      <a class="load"><span class="ico"></span></a>
      <h7 class="wrapped_text"><%- attachment_filename %></h7>
      <a href="<%- attachment_url %>" download="">Скачать</a>
      <% if (!(attachment_filename.endsWith('.html') || attachment_filename.endsWith('.htm'))) { %>
        <a href="<%- attachment_url %>" target="_blank">Посмотреть</a>
      <% } %>
    </p>
  <% } %>
  <% if (answer) { %>
    <p class="file_list_title">Ответ:</p>
    <p class="wrapped_text scrollable" style="max-height: 200px;"><%= answer.replace(/([^>])\n/g, '$1<br/>') %></p>
  <% } %>
  <% if (answer_attachment_url) { %>
    <p class="file_list_title">Вложение в ответе:</p>
    <p class="bottom clearfix" style="display:inline-flex">
      <a class="load"><span class="ico"></span></a>
      <h7 class="wrapped_text"><%- answer_attachment_filename %></h7>
      <a href="<%- answer_attachment_url %>" download="">Скачать</a>
      <% if (!(answer_attachment_filename.endsWith('.html') || answer_attachment_filename.endsWith('.htm'))) { %>
        <a href="<%- answer_attachment_url %>" target="_blank">Посмотреть</a>
      <% } %>
    </p>
  <% } %>
  <% if (revision_allowed) { %>
    <div class="control">
      <label>Комментарий:</label>
      <div class="input_wrap">
        <input class="comment-field" type="text" name="comment" maxlength="100" required>
      </div>
    </div>
  <% } %>
  <% if (history) { %>
    <div class="popup_line clearfix"></div>
    <p class="file_list_title">История:</p>
    <p class="wrapped_text scrollable" style="max-height: 200px;"><%= history.replace(/([^>])\n/g, '$1<br/>') %></p>
  <% } %>
  <div class="popup_footer clearfix">
    <% if (revision_allowed) { %>
      <button id="to-revision-btn" class="btn green orange fl">Доработка</button>
    <% } %>
    <% if (closing_allowed) { %>
      <button id="close-message-btn" class="btn green orange fl">Закрыть</button>
    <% } %>
    <a id="close-window-btn" class="btn green yellow fr close-popup">Закрыть окно</a>
  </div>
  <span class="ico close-popup"></span>
</div>
</script>


<script type="text/template" id="feedback-new-message">
<div class="popup w540">
<h6>Новое обращение</h6>
  <form>
    <div class="control">
      <label>Рубрика</label>
      <div class="input_wrap">
          <select id="rubric-combobox" name="rubric" style="padding: 5px 7px; width: 500px;">
          </select>
      </div>
    </div>
    <div>
      <p id="alert-msg"><i>Просим Вас обратить внимание, что при выборе рубрики
        "Технические вопросы" в вашем профиле должен быть указан актуальный
        адрес Вашей электронной почты для направления ответа.</i>
      </p>
    </div>
    <div class="control">
      <label>Тема</label>
      <div class="input_wrap">
        <input type="text" name="title" maxlength="100" required>
      </div>
    </div>
    <div class="control">
      <label>Ребенок</label>
      <div class="input_wrap">
          <select id="child-combobox" name="child" style="padding: 5px 7px; width: 500px;">
          </select>
      </div>
    </div>
    <div class="control">
      <label>Вопрос</label>
      <div class="input_wrap">
        <textarea id='question' name="text" rows="4" maxlength="300" required></textarea>
      </div>
    </div>
    <div class="control load_file clearfix">
      <label>Вложение</label>
      <div class="btn green default fr">Выбрать</div>
      <div class="input_wrap">
        <input type="text" value="" name="document_name">
        <span class="ico folder"></span>
        <input type="file" value="" name="document">
        <i>Ограничение прикладываемого файла 10,0 Мб</i>
      </div>
    </div>
    <div class="clearfix">
      <button id="send-message-btn" class="btn green fr">Отправить</button>
      <div id="cancel-btn" class="btn fr closable close-popup">Отмена</div>
    </div>
  </form>
</div>
</script>



<script type="text/template" id="feedback-update-contacts">
<div class="popup w540">
<h6>Внимание</h6>
  <form>
    <div>
      <p id="contacts-msg"><i>Уважаемый пользователь. Для отправки обращения,
        необходимо указать ваши контактные данные (телефон или email).
        Указанные контактные данные будут сохранены в вашем профиле</i>
      </p>
    </div>
    <div class="control">
      <label>Телефон</label>
      <div class="input_wrap">
        <input id="phone" type="tel" name="phone" maxlength="100"
               pattern="^\+7\(9\d{2}\)\d{2}-\d{2}-\d{3}$">
      </div>
    </div>
    <div class="control">
      <label>Email</label>
      <div class="input_wrap">
        <input name="email" type="email" maxlength="100">
      </div>
    </div>
    <div class="clearfix">
      <button id='send-contacts' class="btn green fr">Сохранить</button>
      <div class="btn fr closable close-popup">Отмена</div>
    </div>
  </form>
</div>
</script>

<script type="text/javascript" src="/static/jquery.inputmask.js"></script>


    

<script type="text/template" id="advertboard-item-view">
<div class="content">
    <span class="line"></span>
    <div class="content_body">
        <ul class="listing">
            <li style="word-break: break-all">
                <h3><%= theme %></h3>
                <%= message %>
                <div class="info">
                    Добавлено <%= advert_date %> <br>
                    Автор: <%= author %>
                    <% if (school) { %>
                    <br>
                    Организация: <%= school %>
                    <% } %>
                </div>
                <div class="list_content_bottom clearfix">
                    <div id="view-btn-container"></div>
                    <% if (file_url) { %>
                    <a href="<%= file_url %>" class="load"><span class="icon"></span>Скачать файл</a>
                    <% } %>
                </div>
            </li>
        </ul>
    </div>
</div>
</script>

<script type="text/template" id="advertboard">
<div class="top clearfix">
    <div class="right_el search">
        <form id="advert-search-form" action="" method="">
            <input type="text" id="advert-search-text" value="" />
            <span class="ico"><input type="submit" value="" /></span>
        </form>
    </div>
</div>
<div class="advertboard-content">
</div>
</script>

<script type="text/template" id="current-advert">
<div class="popup w540" style="top: 45%;">
    <div class="title">
        <p style="word-break: break-all"><%= theme %></p>
        <p>
            Автор: <%= author %> <br>Добавлено: <%= advert_date %>
            <% if (school) { %> <br>Организация: <%= school %> <% } %>
        </p>

    </div>
    <p class="wrapped_text scrollable" style="max-height: 200px;"><%= message %></p>
    <p class="bottom clearfix">
        <% if (file_url) { %>
    <a href="<%= file_url %>" class="load"><span class="icon"></span>Скачать файл</a>
        <% } %>
    </p>
    <span class="ico close-popup"></span>
</div>
</script>

<script id="advert-btn" type="text/template">
    <a class="view btn yellow green fr"> Просмотр </a>
    
    <a class="reply btn yellow green fr"> Ответить </a>
    
</script>


    
<script type="text/template" id="mailbox-layout-template" xmlns="http://www.w3.org/1999/html">
  <div class="content clearfix">
    <div class="clearfix">
        <div class="new-message">
            <a data-popup="mailbox-new-message" href="" class="fr btn primary yellow"><i class="ico white mail"></i> Новое сообщение</a>
        </div>
        <div class="top_search">
            <form>
                <input type="text" value="" id="search_text">
                <span class="ico loupe"></span>
                <input type="submit" value="Найти">
            </form>
        </div>
    </div>

    <div class="int_tabs_wrap">
      <span id="tabs"></span>
      <div class="int_tab bordered">

      </div>
    </div>
  </div>
</script>


<script type="text/template" id="mailbox-tab-template-default">
  <a href="<%= url %>"><%= name %>
    <% if (count) { %>
      <span class="hint"><%= count %></span>
    <% } %>
  </a>
</script>


<script type="text/template" id="mailbox-tab-template-hint">
  <%= count %> <%= name %>
</script>


<script type="text/template" id="inbox-message">
  <div class="check"><input type="checkbox"></div>
    <a id="reply" class="btn yellow green fr">Ответить</a>
    <a id="reply_all" class="btn yellow green fr">Ответить всем</a>
    <div class="img"><img src="<%- sender_avatar %>"></div>
    <div class="list_content">
        <p><a href="javascript:void(0)"><%- sender_fullname %></a></p>
        <p class="wrapped_text"><a href="" class="subject">&lt;<%- subject %>&gt;</a>
        <div class="wrapped_text preview"><%= short_text %></div>
        </p>
        <div class="date"><%- date %></div>
  </div>
</script>


<script type="text/template" id="inbox-messages">
  <div class="content_head">
      <div class="check check_all"><input type="checkbox"></div>
      <span>Всего: <%- count %> полученных сообщений</span>
      <% if (new_count) { %>
        <span class="unread"><%- new_count %> непрочитанных сообщения</span>
      <% } %>
      <a href="" class="btn green default fr" id="remove_checked">Удалить </a>
  </div>
  <div class="content_body">
      <ul class="listing" id="mailbox-listing"></ul>
  </div>
  <div class="content_footer clearfix">
    <div class="fr paging2"></div>
    <span><%- getPagingInfo() %></span>
  </div>
</script>


<script type="text/template" id="outbox-message">
  <div class="check"><input type="checkbox"></div>
    <div class="img"><% if (receiver_avatar) { %><img src="<%- receiver_avatar %>"><% } %></div>
    <div class="list_content">
        <p><a href="javascript:void(0)">
          <% if (receivers.length > 2) { %>
            <%- _.pluck(receivers, 'fullname').slice(0, 2) %>...
          <% } else { %>
            <%- _.pluck(receivers, 'fullname').join(', ') %>
          <% } %>
        </a></p>
        <p class="wrapped_text" title="<%= tooltip %>">
            <a href="" class="subject">&lt;<%- subject %>&gt;</a>
            <p class="wrapped_text preview"><%= short_text %></p>
        </p>
        <div class="date"><%- date %></div>
  </div>
</script>


<script type="text/template" id="outbox-messages">
  <div class="content_head">
      <div class="check check_all"><input type="checkbox"></div>
      <span>Всего: <%- count %> отправленных сообщений</span>
      <a href="" class="btn green default fr" id="remove_checked">Удалить </a>
  </div>
  <div class="content_body">
      <ul class="listing" id="mailbox-listing"></ul>
  </div>
  <div class="content_footer clearfix">
    <div class="fr paging2"></div>
    <span><%- getPagingInfo() %></span>
  </div>
</script>


<script type="text/template" id="inbox-full-message">
<div class="popup w540">
  <div class="popup_header">
      <h6 class="wrapped_text"><%- subject %></h6>
      <div class="mail_head">
          <% if (sender_avatar) { %><img src="<%- sender_avatar %>" class="fr"><% } %>
          <table>
              <tbody>
              <tr>
                  <td>От кого:</td>
                  <td><%- sender_fullname %></td>
              </tr>
              <tr style="overflow: scroll;">
                  <td>Кому:</td>
                  <td>
                    <div class="receivers_list" style="height: 52px">
                      <ul style="margin: 0; padding: 0;">
                        <li style="list-style-type: none; display: block; float: left; margin: 0;"><%- _.pluck(receivers, 'fullname').join(', ') %></li>
                      </ul>
                    </div>
                  </td>
              </tr>
              </tbody>
          </table>
          <p><%- date %> <% if (attachments.length > 0) { %><span class="attachment"><i class="ico"></i> <span>Файлов: <%= attachments.length %></span></span><% } %></p>
      </div>
  </div>

  <div class="wrapped_text scrollable" style="color: #383838;"><%= text.replace(/([^>])\n/g, '$1<br/>') %></div>
  <% if (attachments.length > 0) { %>
    <p class="file_list_title">Вложения:</p>
    <% _.each(attachments, function(item) { %>
        <p class="bottom clearfix">
            <a class="load"><span class="ico"></span><%= item.original_name %></a>
            <a href="<%- item.download_link %>" download="<%= item.original_name %>">
               Скачать</a>
            <% if (!(item.original_name.endsWith('.html') || item.original_name.endsWith('.htm'))) { %>
                <a href="<%- item.download_link %>" target="_blank">Посмотреть</a>
            <% } %>
        </p>
    <% }) %>
  <% } %>
  <div class="popup_footer clearfix">
      <a class="btn green yellow fr close-popup">Закрыть</a>
      <a id="reply" class="btn green yellow fr">Ответить</a>
      <a id="reply_all" class="btn green yellow fr">Ответить всем</a>
      <a class="btn default remove_btn">Удалить</a>
  </div>
  <span class="ico close-popup"></span>
</div>
</script>


<script type="text/template" id="outbox-full-message">
<div class="popup w540">
  <div class="popup_header">
      <h6 class="wrapped_text"><%- subject %></h6>
      <div class="mail_head">
          <% if (receiver_avatar) { %><img src="<%- receiver_avatar %>" class="fr"><% } %>
          <table>
              <tbody>
              <tr>
                  <td>От кого:</td>
                  <td><%- sender_fullname %></td>
              </tr>
              <tr style="overflow: scroll;">
                  <td>Кому:</td>
                  <td>
                    <div class="receivers_list" style="height: 52px;">
                      <ul style="margin: 0; padding: 0;">
                        <li style="list-style-type: none; display: block; float: left; margin: 0;"><%- _.pluck(receivers, 'fullname').join(', ') %></li>
                      </ul>
                    </div>
                  </td>
              </tr>
              </tbody>
          </table>
          <p><%- date %> <% if (attachments.length > 0) { %><span class="attachment"><i class="ico"></i> <span>Файлов: <%= attachments.length %></span></span><% } %></p>
      </div>
  </div>

  <div class="wrapped_text scrollable" style="color: #383838;"><%= text.replace(/([^>])\n/g, '$1<br/>') %></div>
  <% if (attachments.length > 0) { %>
    <p class="file_list_title">Вложения:</p>
    <% _.each(attachments, function(item) { %>
        <p class="bottom clearfix">
            <a class="load"><span class="ico"></span><%= item.original_name %></a>
            <a href="<%- item.download_link %>" download="<%= item.original_name %>">
               Скачать</a>
            <% if (!(item.original_name.endsWith('.html') || item.original_name.endsWith('.htm'))) { %>
                <a href="<%- item.download_link %>" target="_blank">Посмотреть</a>
            <% } %>
        </p>
    <% }) %>
  <% } %>
  <div class="popup_footer clearfix">
      <a class="btn green yellow fr close-popup">Закрыть</a>
      <a class="btn default remove_btn">Удалить</a>
  </div>
  <span class="ico close-popup"></span>
</div>
</script>


<script type="text/template" id="mailbox-new-message">
<div class="popup w540">
<h6>Новое сообщение</h6>
  <form>
    <div id="scrollable-container" style="height: 380px; margin-bottom: 10px">
        <div class="control receivers">
          <div id="get-pupil-receivers" class="btn green yellow">Ученики</div>
          <div id="get-employee-receivers" class="btn green yellow">Учителя</div>
          <div id="get-parent-receivers" class="btn green yellow">Родители</div>
          <div id="get-admin-receivers" class="btn green yellow">Администраторы</div>
        </div>
        <div class="control">
          <label>Кому</label>
          <div id="receivers_names" style="overflow:auto;"><ul><li><%- receivers.pluck('fullname').join(',') %></li></ul></div>
          <div class="input_wrap">
            <input type="text" name="receivers_ids" id="receivers_ids" required hidden value="<%- receivers.pluck('id').join(',') %>">
          </div>
        </div>
        <div class="control">
          <label>Тема</label>
          <div class="input_wrap">
            <input type="text" name="subject" maxlength="300" value="<%- subject %>" required>
          </div>
        </div>
        <div class="control load_file clearfix">
          <label>Вложения</label>
          <div class="btn green default fr">Выбрать</div>
          <div class="btn default fr clear-inputs" title="Очистить">X</div>
          <div class="input_wrap clearable">
            <input type="text" value="" name="document_names">
            <input type="hidden" name="filenames" value="">
            <span class="ico folder"></span>
            <input type="file" value="" name="documents" multiple>
          </div>
        </div>
        <div class="control">
          <label>Текст</label>
          <div class="input_wrap">
            <textarea id='message' class="ckeditor-area" name="message" rows="4"><%= text.replace(/([^>])\n/g, '$1<br/>') %></textarea>
          </div>
        </div>
    </div>
    <div class="clearfix">
      <button id='send-message' class="btn green fr">Отправить</button>
      <div class="btn fr closable close-popup">Отмена</div>
    </div>
  </form>
</div>
</script>

<script type="text/template" id="new-message-pupil-receiver">
  <td><div class="check"><input type="checkbox"></div></td>
  <td><%- fullname %></td>
  <td><%- class_name %></td>
</script>
<script type="text/template" id="new-message-employee-receiver">
  <td><div class="check"><input type="checkbox"></div></td>
  <td><%- fullname %></td>
  <td><%- job %></td>
</script>
<script type="text/template" id="new-message-parent-receiver">
  <td><div class="check"><input type="checkbox"></div></td>
  <td><%- fullname %></td>
  <td><%- child_fullname %></td>
  <td><%- class_name %></td>
</script>
<script type="text/template" id="new-message-admin-receiver">
  <td><div class="check"><input type="checkbox"></div></td>
  <td><%- fullname %></td>
</script>


<script type="text/template" id="new-message-pupil-receivers">
  <div class="popup w540" id="pupils" style="height: 600px">
    <div class="popup_header">
      <h6>Ученики</h6>
      <div class="top_search">
        <form class="receivers-search-form">
            <input type="text" class="search-text" value="">
            <span class="ico loupe"></span>
            <input type="submit" value="Найти">
        </form>
      </div>
      <div class="user_list">
        <table>
          <colgroup>
            <col width="21">
            <col width="300">
          </colgroup>
          <thead>
            <tr>
              <th><div class="check check_all"><input type="checkbox"></div></th>
              <th>Фамилия Имя Отчество</th>
              <th>Класс</th>
            </tr>
            <tr>
              <td colspan="2"><input class="column-filter-field" name="fullname" type="text" style="width: 20em;" placeholder="ФИО"></td>
              <td>
                  <input class="column-filter-field" name="study_level" type="text" style="float: left; width: 4.5em;" placeholder="1">
                  <input class="column-filter-field" name="letter" type="text" style="float: right; width: 4.5em;" placeholder="А">
              </td>
            </tr>
          </thead>
        </table>
      </div>
    </div>
    <div class="user_list user_list_body" style="height: 440px;" data-scroll-height="345px">
      <table>
        <colgroup>
          <col width="21">
          <col width="300">
        </colgroup>
        <tbody></tbody>
      </table>
    </div>
    <div class="popup_footer clearfix">
      <a data-popup="new-mail" class="btn green fr select-receivers">Выбрать</a>
      <a class="btn default fr close-popup">Отмена</a>
      <div class="paging2 inverse"></div>
    </div>
    <span class="ico close-popup"></span>
  </div>
</script>

<script type="text/template" id="new-message-employee-receivers">
<div class="popup w540" id="pupils" style="height: 600px">
  <div class="popup_header">
    <h6>Учителя</h6>
    <div class="top_search">
      <form class="receivers-search-form">
        <input type="text" class="search-text" value="">
        <span class="ico loupe"></span>
        <input type="submit" value="Найти">
      </form>
    </div>
    <div class="user_list">
      <table>
        <colgroup>
          <col width="21">
          <col width="300">
        </colgroup>
        <thead>
          <tr>
            <th><div class="check check_all"><input type="checkbox"></div></th>
            <th>Фамилия Имя Отчество</th>
            <th>Должность</th>
          </tr>
          <tr>
            <td colspan="2"><input class="column-filter-field" name="fullname" type="text" placeholder="ФИО" style="width: 20em"></td>
            <td><input class="column-filter-field" name="employer_job" type="text" style="float: left; width: 10em" placeholder="Учитель математики"></td>
          </tr>
        </thead>
      </table>
    </div>
  </div>
  <div class="user_list user_list_body" style="height: 440px;" data-scroll-height="345px">
    <table>
      <colgroup>
        <col width="21">
        <col width="300">
      </colgroup>
      <tbody></tbody>
    </table>
  </div>
  <div class="popup_footer clearfix">
    <a data-popup="new-mail" class="btn green fr select-receivers">Выбрать</a>
    <a class="btn default fr close-popup">Отмена</a>
    <div class="paging2 inverse"></div>
  </div>
  <span class="ico close-popup"></span>
</div>
</script>

<script type="text/template" id="new-message-parent-receivers">
  <div class="popup w540" id="pupils" style="height: 600px">
    <div class="popup_header">
      <h6>Родители</h6>
      <div class="top_search">
        <form class="receivers-search-form">
          <input type="text" class="search-text" value="">
          <span class="ico loupe"></span>
          <input type="submit" value="Найти">
        </form>
      </div>
      <div class="user_list">
        <table>
          <colgroup>
            <col width="21">
            <col width="150">
            <col width="150">
            <col width="75">
          </colgroup>
          <thead>
          <tr>
            <th><div class="check check_all"><input type="checkbox"></div></th>
            <th>Фамилия Имя Отчество</th>
            <th>Фамилия Имя ученика</th>
            <th>Класс</th>
          </tr>
          <tr>
              <td colspan="2"><input class="column-filter-field" name="fullname" type="text" placeholder="ФИО" style="width: 13em;"></td>
              <td><input class="column-filter-field" name="child_fullname" type="text" placeholder="ФИО" style="width: 11em;"></td>
              <td>
                  <input class="column-filter-field" name="study_level" type="text" style="float: left; width: 1.4em;" placeholder="1">
                  <input class="column-filter-field" name="letter" type="text" style="float: right; width: 1.4em;" placeholder="А">
              </td>
            </tr>
          </thead>
        </table>
      </div>
    </div>
    <div class="user_list user_list_body" style="height: 440px;" data-scroll-height="345px">
      <table>
        <colgroup>
          <col width="21">
          <col width="150">
          <col width="150">
          <col width="75">
        </colgroup>
        <tbody></tbody>
      </table>
    </div>
    <div class="popup_footer clearfix">
      <a data-popup="new-mail" class="btn green fr select-receivers">Выбрать</a>
      <a class="btn default fr close-popup">Отмена</a>
      <div class="paging2 inverse"></div>
    </div>
    <span class="ico close-popup"></span>
  </div>
</script>

<script type="text/template" id="new-message-admin-receivers">
<div class="popup w540" id="pupils" style="height: 600px">
  <div class="popup_header">
    <h6>Администраторы</h6>
    <div class="top_search">
      <form class="receivers-search-form">
        <input type="text" class="search-text" value="">
        <span class="ico loupe"></span>
        <input type="submit" value="Найти">
      </form>
    </div>
    <div class="user_list">
      <table>
        <colgroup>
          <col width="21">
          <col width="300">
        </colgroup>
        <thead>
        <tr>
          <th><div class="check check_all"><input type="checkbox"></div></th>
          <th>Фамилия Имя Отчество</th>
        </tr>
        </thead>
      </table>
    </div>
  </div>
  <div class="user_list user_list_body" style="height: 440px;" data-scroll-height="385px">
    <table>
      <colgroup>
        <col width="21">
        <col width="300">
      </colgroup>
      <tbody></tbody>
    </table>
  </div>
  <div class="popup_footer clearfix">
    <a data-popup="new-mail" class="btn green fr select-receivers">Выбрать</a>
    <a class="btn default fr close-popup">Отмена</a>
    <div class="paging2 inverse"></div>
  </div>
  <span class="ico close-popup"></span>
</div>
</script>



<script id="base-popup" type="text/template">
    <div class="title">
        <p><%= title %></p>
    </div>
    <span><%= message %></span>
    <span class="ico close-popup"></span>
</script>


<script type="text/javascript">
    
        /**
 * Created by tim on 16.07.14.
 */


/**
 * Склонение слов в зависимости от числительных
 * Пример: decOfNum(5, ['секунда', 'секунды', 'секунд'])
 * Массив легко создавать провяряя числа 1, 3 и 5
 */
function declOfNum(number, titles) {
    var cases = [2, 0, 1, 1, 1, 2];
    return titles[ (number%100>4 && number%100<20)? 2 : cases[(number%10<5)?number%10:5] ];
}

function getReadableFileSizeString(fileSizeInBytes) {

    var i = -1;
    var byteUnits = [' kB', ' MB', ' GB', ' TB', 'PB', 'EB', 'ZB', 'YB'];
    do {
        fileSizeInBytes = fileSizeInBytes / 1024;
        i++;
    } while (fileSizeInBytes > 1024);

    return Math.max(fileSizeInBytes, 0.1).toFixed(1) + byteUnits[i];
}

Date.prototype.rusMonths =  [
    "Январь", "Февраль", "Март", "Апрель", "Май", "Июнь",
    "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"
];

Date.prototype.rusMonthsGenitive =  [
    "Января", "Февраля", "Марта", "Апреля", "Мая", "Июня", "Июля",
    "Августа", "Сентября", "Октября", "Ноября", "Декабря"
];

Date.prototype.getMonthName = function(genitive) {
    return (genitive?this.rusMonthsGenitive:this.rusMonths)[this.getMonth()]
};


Date.prototype.getDayName = function () {
    return [
        "Воскресенье",
        "Понедельник",
        "Вторник",
        "Среда",
        "Четверг",
        "Пятница",
        "Суббота"
    ][this.getDay()]
};


Date.prototype.getDayShortName = function () {
    return [
        "вс",
        "пн",
        "вт",
        "ср",
        "чт",
        "пт",
        "сб"
    ][this.getDay()]
};


Date.prototype.toJSONDateString = function () {
    return new Date(
        this.getFullYear(), this.getMonth(), this.getDate(),
        this.getHours(), this.getMinutes() - this.getTimezoneOffset(),
        this.getSeconds(), this.getMilliseconds()).toJSON().slice(0, 10);
};


Date.prototype.getWeekdayRange = function () {
    var dateBegin, dateEnd;

    if (this.getDay() == 0) {
        dateBegin = this.getDate() - 6;
    } else {
        dateBegin = this.getDate() - this.getDay() + 1;
    }

    dateEnd = dateBegin + 6;

    return [
        new Date(this.getFullYear(), this.getMonth(), dateBegin),
        new Date(this.getFullYear(), this.getMonth(), dateEnd)
    ]
};

Date.prototype.getDateStringZeroed = function () {
    return ("0" + this.getDate()).slice(-2)
};

Date.prototype.getMonthStringZeroed = function () {
    return ("0" + (this.getMonth()+1) ).slice(-2)
};

Date.prototype.isToday = function () {
    var now = new Date();
    return (
        now.getDate() == this.getDate() && 
        now.getMonth() == this.getMonth() && 
        now.getFullYear() == this.getFullYear()
    )
};

Number.prototype.toHumanReadableFileSize = function () {
    var sizes = ["B", "KB", "MB", "GB"],
        retval = this;
    for (var size; size = sizes.shift();){
        if (retval < 1000) {
            if (retval - Math.floor(retval) != 0){
                retval = retval.toFixed(2);
            }
            return retval.toString() + " " + size;
        }
        retval = retval / 1024
    }
};

    
        var PersonalArea = new Marionette.Application({
    navigate: function (route, options) {
        options || (options = {
            pushState: true,
            trigger: true
        });
        Backbone.history.navigate(route, options);
    },

    getCurrentRoute: function () {
        return Backbone.history.getFragment();
    },
    openFile: function (url) {
        var hiddenIFrameID = 'hiddenDownloader',
            iframe = document.getElementById(hiddenIFrameID);
        if (iframe === null) {
            iframe = document.createElement('iframe');
            iframe.id = hiddenIFrameID;
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
        }
        iframe.src = url;
    }
});

PersonalArea.getModuleAttr = function (path) {
    var attrPath = path.split("."),
        attr = attrPath.pop(),
        modulePath = attrPath.join("."),
        module = PersonalArea.module(modulePath);
    return module[attr]
};

PersonalArea.addRegions({
    headerRegion: "#header-region",
    leftRegion: "#left-region",
    mainRegion: "#main-region",
    popupRegion: "#popup-region",
    anotherPopupRegion: '#tier-2-popup-region'
});


PersonalArea.Behaviors = {};
Backbone.Marionette.Behaviors.behaviorsLookup = function () {
    return PersonalArea.Behaviors
};

var showError = _.debounce(popupShow, 1000, true);
PersonalArea.showError = showError;

PersonalArea.on("start", function () {
    Backbone.history.start();
    
    
        PersonalArea.need_select = false;
        var frag = PersonalArea.getCurrentRoute();
        if (!frag) {
            PersonalArea.navigate(
                '#diary'
            );
        }
    
    // Вывод всплывающего окна с уведомлением о выставленных точках вместо оценок на уроках для учеников
    
});


// overriding Backbone
(function (Backbone) {

    // Map from CRUD to HTTP for our default `Backbone.sync` implementation.
    var methodMap = {
        'create': 'POST',
        'update': 'PUT',
        'patch': 'PATCH',
        'delete': 'DELETE',
        'read': 'GET'
    };

    // Throw an error when a URL is needed, and none is supplied.
    var urlError = function() {
        throw new Error('A "url" property or function must be specified');
    };

    var emulateJsonDoesNotSupported = function () {
        throw new Error("Cannot use emulateJSON ajax option due to it doesn't support by spyne.JsonDocument protocol" );
    };

    var noXhrPatch =
    typeof window !== 'undefined' && !!window.ActiveXObject &&
      !(window.XMLHttpRequest && (new XMLHttpRequest).dispatchEvent);

    // Wrap an optional error callback with a fallback error event.
    var wrapError = function (model, options) {
      var error = options.error;
      options.error = function (resp) {
        if (error) error(model, resp, options);
        model.trigger('error', model, resp, options);
      };
    };


    Backbone.sync = function (method, model, options) {

        var apiMethods = _.result(model, "apiMethods");
        // Request to spyne.JsonDocument service always must be POST
        var type = apiMethods ? "POST": methodMap[method];

        // Default options, unless specified.
        _.defaults(options || (options = {}), {
            emulateHTTP: Backbone.emulateHTTP,
            emulateJSON: Backbone.emulateJSON
        });

        options.emulateJSON && apiMethods && emulateJsonDoesNotSupported();

        // Default JSON-request options.
        var params = {type: type, dataType: 'json'};

        // Ensure that we have a URL.
        if (!options.url) {
            params.url = _.result(model, 'url') || urlError();
        }

        // Ensure that we have the appropriate request data.
        if (options.data == null && model && (apiMethods || method === 'create' || method === 'update' || method === 'patch')) {
            params.contentType = 'application/json';
            var data = options.attrs || model.toJSON(options);
            if (apiMethods) {
                if (method == "update" || method == "delete" || method == "patch") {
                    data.id = model.id;
                }
                params.data = {};
                params.data[apiMethods[method]] = data;
            } else {
                params.data = data;
            }
            params.data = JSON.stringify(params.data);
        }

        // For older servers, emulate JSON by encoding the request into an HTML-form.
        if (options.emulateJSON) {
            params.contentType = 'application/x-www-form-urlencoded';
            params.data = params.data ? {model: params.data} : {};
        }

        // For older servers, emulate HTTP by mimicking the HTTP method with `_method`
        // And an `X-HTTP-Method-Override` header.
        if (options.emulateHTTP && (type === 'PUT' || type === 'DELETE' || type === 'PATCH')) {
            params.type = 'POST';
            if (options.emulateJSON) params.data._method = type;
            var beforeSend = options.beforeSend;
            options.beforeSend = function (xhr) {
                xhr.setRequestHeader('X-HTTP-Method-Override', type);
                if (beforeSend) return beforeSend.apply(this, arguments);
            };
        }

        // Don't process data on a non-GET request.
        if (params.type !== 'GET' && !options.emulateJSON) {
            params.processData = false;
        }

        // If we're sending a `PATCH` request, and we're in an old Internet Explorer
        // that still has ActiveX enabled by default, override jQuery to use that
        // for XHR instead. Remove this line when jQuery supports `PATCH` on IE8.
        if (params.type === 'PATCH' && noXhrPatch) {
            params.xhr = function () {
                return new ActiveXObject("Microsoft.XMLHTTP");
            };
        }

        // Make the request, allowing the user to override any Ajax options.
        var xhr = options.xhr = Backbone.ajax(_.extend(params, options));
        model.trigger('request', model, xhr, options);
        return xhr;
    };

    // хак фетча коллекции для itemstotal_fabric (itemsRoot в конфиге коллекции)
    Backbone.Collection.prototype.fetch = function (options) {

      options = options ? _.clone(options) : {};
      if (options.parse === void 0) options.parse = true;
      var success = options.success;
      var collection = this;
      options.success = function (resp) {
        var method = options.reset ? 'reset' : 'set';
        collection[method](
          collection["itemsRoot"] ? resp[collection["itemsRoot"]] : resp, options);
        if (success) success(collection, resp, options);
        collection.trigger('sync', collection, resp, options);
      };
      wrapError(this, options);
      return this.sync('read', this, options);
    }

})(Backbone);


/*
    Асинхронный сериализатор, для загрузки файлов.
    Пример использования:
    $.when(Backbone.Syphone.serializeAsync(view))
        .then(function(data) {
            model.set(data);
            model.save();
        });
 */
(function (Syphon) {

    var buildConfig = function (options) {
        var config = _.clone(options) || {};

        config.ignoredTypes = _.clone(Syphon.ignoredTypes);
        config.inputReaders = config.inputReaders || Syphon.InputReaders;
        config.inputWriters = config.inputWriters || Syphon.InputWriters;
        config.keyExtractors = config.keyExtractors || Syphon.KeyExtractors;
        config.keySplitter = config.keySplitter || Syphon.KeySplitter;
        config.keyJoiner = config.keyJoiner || Syphon.KeyJoiner;
        config.keyAssignmentValidators = config.keyAssignmentValidators || Syphon.KeyAssignmentValidators;

        return config;
    };

    var assignKeyValue = function (obj, keychain, value) {
        if (!keychain) {
            return obj;
        }

        var key = keychain.shift();

        // build the current object we need to store data
        if (!obj[key]) {
            obj[key] = _.isArray(key) ? [] : {};
        }

        // if it's the last key in the chain, assign the value directly
        if (keychain.length === 0) {
            if (_.isArray(obj[key])) {
                obj[key].push(value);
            } else {
                obj[key] = value;
            }
        }

        // recursive parsing of the array, depth-first
        if (keychain.length > 0) {
            assignKeyValue(obj[key], keychain, value);
        }

        return obj;
    };

    var getInputElements = function (view, config) {
        var form = getForm(view);
        var elements = form.elements;

        elements = _.reject(elements, function (el) {
            var reject;
            var type = getElementType(el);
            var extractor = config.keyExtractors.get(type);
            var identifier = extractor($(el));

            var foundInIgnored = _.include(config.ignoredTypes, type);
            var foundInInclude = _.include(config.include, identifier);
            var foundInExclude = _.include(config.exclude, identifier);

            if (foundInInclude) {
                reject = false;
            } else {
                if (config.include) {
                    reject = true;
                } else {
                    reject = (foundInExclude || foundInIgnored);
                }
            }

            return reject;
        });

        return elements;
    };

    var getElementType = function (el) {
        var typeAttr;
        var $el = $(el);
        var tagName = $el[0].tagName;
        var type = tagName;

        if (tagName.toLowerCase() === "input") {
            typeAttr = $el.attr("type");
            if (typeAttr) {
                type = typeAttr;
                if (type === "file" && $el.attr("multiple")) {
                    type = "multiple-files"
                }
            } else {
                type = "text";
            }
        }

        // Always return the type as lowercase
        // so it can be matched to lowercase
        // type registrations.
        return type.toLowerCase();
    };

    var getForm = function (viewOrForm) {
        if (_.isUndefined(viewOrForm.$el) && viewOrForm.tagName.toLowerCase() === 'form') {
            return viewOrForm;
        } else {
            return viewOrForm.$el.is("form") ? viewOrForm.el : viewOrForm.$("form")[0];
        }
    };

    var getFileInputReader = function ($el) {

        var files = FileAPI.getFiles($el);
        var deferred = new $.Deferred();

        var deferreds = _.map(files, function (file) {
            var local_deferred = new $.Deferred();

            FileAPI.readAsBinaryString(file, function (evt) {
                if (evt.type == "load") {
                    local_deferred.resolve(btoa(evt.result));
                } else if (evt.type != "progress") {
                    local_deferred.resolve(void 0);
                }
            });

            return local_deferred.promise()
        });

        $.when.apply($, deferreds).then(function() {
            var objects = Array.prototype.slice.call(arguments);
            deferred.resolve(objects);
        });

        return deferred.promise();
    };

    Syphon.serializeAsync = function (view, options) {

        var serializeDeferred = new $.Deferred();

        var data = {};

        // Build the configuration
        var config = buildConfig(options);

        // Get all of the elements to process
        var elements = getInputElements(view, config);
        var elDeferreds = _.map(elements, function (el) {
            var elDeferred = new $.Deferred();
            var $el = $(el);
            var type = getElementType($el);

            // Get the key for the input
            var keyExtractor = config.keyExtractors.get(type);
            var key = keyExtractor($el);

            // Get the value for the input
            var inputReader = config.inputReaders.get(type);
            $.when(inputReader($el)).done(function (value) {
                // Get the key assignment validator and make sure
                // it's valid before assigning the value to the key
                var validKeyAssignment = config.keyAssignmentValidators.get(type);
                if (validKeyAssignment($el, key, value)) {
                    var keychain = config.keySplitter(key);
                    assignKeyValue(data, keychain, value)
                }
                elDeferred.resolve();
            });
            return elDeferred.promise()
        });

        $.when.apply($, elDeferreds).done(function () {
            serializeDeferred.resolve(data)
        });

        return serializeDeferred.promise();
    };

    // key extractor для файлов
    Syphon.KeyExtractors.register("file", function ($el) {
        return $el.attr("name");
    });

    Syphon.KeyExtractors.register("multiple-files", function ($el) {
        return $el.attr("name");
    });

    // регистрируем input-reader для файлов
    Syphon.InputReaders.register("file", function ($el) {

        var deferred = new $.Deferred();
        $.when(getFileInputReader($el)).then(function(files) {
            if (files.length > 0) {
                deferred.resolve(files[0]);
            } else {
                deferred.resolve(void 0);
            }
        });
        return deferred.promise();

    });

    Syphon.InputReaders.register("multiple-files", getFileInputReader);

    Syphon.InputReaders.registerDefault(function ($el) {
        var retval = $el.val();
        if ($el.hasClass("hasDatepicker")) {
            retval = $.datepicker.parseDate($.datepicker.regional.ru.dateFormat, retval).toJSONDateString()
        }
        return retval;
    });

})(Backbone.Syphon);


    
        function popupShow(title, message){
    // показывает popup-сообщение
    var view = new PersonalArea.Core.Views.PopupView(
        {
            model: new Backbone.Model({
                title: title,
                message: message
            })
        }
    );

    var popupEl = view.render().$el,
        overlay = $(".overlay").clone(),
        zIndex = + $('.popup').css('z-index') + 1;

    overlay.css('z-index', zIndex);
    popupEl.css('z-index', zIndex + 1);
    var body = $("body");
    body.append(overlay);
    body.append(popupEl);
    overlay.show();
    popupEl.show();
    // подписываем на закрытие
    var closePopup = function(){
        popupEl.hide();
        popupEl.remove();
        overlay.hide();
        overlay.remove();
        view.destroy();
    };
    overlay.one('click', closePopup);
    popupEl.find(".close-popup").one("click", closePopup);
    body.on('keyup', function (e) {
        if (e.keyCode == 27) {
            closePopup();
        }
    })
}

$(document).ajaxError(function (e, xhr, options) {
    var data = JSON.parse(xhr.responseText),
        title = 'Произошла ошибка',
        message = data.faultstring;
    if (message === "Internal Error"){
        message = "Непредвиденная ошибка";
    }
    showError(title, message);
});

    
        PersonalArea.module("Core.Models", function (Models, PersonalArea, Backbone, Marionette, $, _) {

    Models.DatepickModel = Backbone.Model.extend({
        initialize: function (config) {
            var date = new Date();
            var wrange = date.getWeekdayRange();
            this.set("date", date);
            this.set("weekBegin", wrange[0]);
            this.set("weekEnd", wrange[1])
        }
    });

});

    
        PersonalArea.module("Core.Views", function(Views, PersonalArea, Backbone, Marionette, $, _) {

    Views.TabbedLayoutView = Marionette.LayoutView.extend({
        tabSelectorContainer: ".left_el.tab",
        currentTab: undefined,
        tabs: {},
        loadTab: function(tabName, view){
            var container = this.tabs[tabName];
            var regionName = tabName + "Tab";
            this.addRegion(regionName , container);
            this[regionName].show(view);
        },

        switchToTab: function (tabName) {
            var container = this.tabs[tabName];
            var cont = $(this.tabSelectorContainer);
            this.trigger("switchtab:before", tabName)
            if(_.isFunction(this.onSwitchTabBefore)){
                this.onSwitchTabBefore(tabName)
            }
            cont.find("a.active").removeClass("active");
            cont.find("a[href*=" + tabName + "]").first().addClass("active");
            _(this.tabs).each(function(val, key){
                $(val).hide();
            });
            $(container).show();
            this.currentTab = tabName;
            this.trigger("switchtab:after", tabName);
        },
        getCurrentTab: function(){
            return this.currentTab;
        }
    });

    Views.DatepickerPanelView = Marionette.ItemView.extend({
        template: "#datepicker-widget-panel-template"
    });

    Views.DatepickerWidgetView = Marionette.LayoutView.extend({
        template: "#datepicker-widget-template",
        childView: Views.DatepickerPanelView,
        regions: {
            "panel": ".date-panel"
        },
        initialize: function (config) {
            config.pickerConf = config.pickerConf || {};
            this.onSelectListener = config.onSelect;
            this.pickerConf = _.extend({
                showOtherMonths: true,
                selectOtherMonths: true,
                onSelect: _.bind(this.onDateSelect, this)
            }, config.pickerConf);

            this.panelStyle = config.panelStyle || "month";

            this.datepickModel = new PersonalArea.Core.Models.DatepickModel({
                style: this.panelStyle
            });
        },
        events: {
            "click .pick-activator": "onCalendarClick",
            "click a.next": "onNext",
            "click a.prev": "onPrev"
        },
        onCalendarClick: function(e){
            this.$el.find('.calendar:first')
                .toggleClass('active').find('.calendar_wrap').slideToggle();
        },
        onShow: function(){

            $('body').off('click.datepickerwidget')
                     .on('click.datepickerwidget', function(e) {
                var target = $(e.target);
                if(target.closest('.calendar').length>0 ||
                    target.closest('.date-panel').length>0 ||
                    target.is('.ui-datepicker-prev') ||
                    target.is('.ui-datepicker-next') ||
                    target.closest('.ui-datepicker-prev').length>0 ||
                    target.closest('.ui-datepicker-next').length>0) {
                    e.stopPropagation();
                } else {
                    $('.calendar').removeClass('active')
                        .find('.calendar_wrap').slideUp();
                }
            });

            this.panelView = new Views.DatepickerPanelView({
                "model": this.datepickModel
            });
            this.panel.show(this.panelView);

            $(_.bind(function(){
                this.datepicker = this.$el.find(".datepicker:first").datepicker(
                    this.pickerConf);
                this.setDate(this.datepicker.datepicker("getDate"), true);
                $().datepicker($.datepicker.regional["ru"]);
            }, this));

        },
        setDate: function(date, silent){
            if(!silent && _.isFunction(this.onSelectListener)){
                if(!this.onSelectListener.call(this, date))
                    return;
            }
            var wrange = date.getWeekdayRange();
            this.datepickModel.set({
                "date": date,
                "weekBegin": wrange[0],
                "weekEnd": wrange[1],
                "style": this.panelStyle
            });
            if(this.datepicker){
                this.datepicker.datepicker("setDate", date);
            }
            if(this.panelView){
                this.panelView.render();
            }
            if(!silent){
                this.trigger("datepicked", date);
            }
        },
        getDate: function(){
            return this.datepickModel.get("date");
        },
        onDateSelect: function(dateString, datePicked) {
            this.$el.find('.calendar').removeClass('active')
                .find('.calendar_wrap').slideUp();
            var date = new Date(
                datePicked.selectedYear,
                datePicked.selectedMonth,
                datePicked.selectedDay
            );
            this.setDate(date);
        },
        setPanelStyle: function(style){
            this.panelStyle = style;
            this.datepickModel.set("style", this.panelStyle);
            this.panelView.render();
        },
        shiftDate: function(forward){
            var mul = forward ? 1 : -1;
            var date = this.datepickModel.get("date");
            var newDate = new Date(date);
            if(this.panelStyle == "week"){
                newDate.setDate(date.getDate() + mul*7)
            }else if(this.panelStyle == "month"){
                newDate.setMonth(date.getMonth() + mul)
            }else if(this.panelStyle == "day"){
                newDate.setDate(date.getDate() + mul)
            }
            this.setDate(newDate);
        },
        onNext: function(){
            this.shiftDate(true);
        },
        onPrev: function(){
            this.shiftDate(false);
        }
    });

    Views.PopupView = Marionette.ItemView.extend({
        // вью попапа, которая умеет закрываться
        tagName: "div",
        template: "#base-popup",  // перекрывать
        className: "popup",
        behaviors: {
            Closable: {}
        }
    });

    Views.ComboboxItemView = Marionette.ItemView.extend({
        tagName: 'option',
        getTemplate: function () {
            return _.template('<%= ' + this.displayField + ' %>');
        },
        onRender: function () {
            this.$el.val(this.model.get(this.valueField))
        },
        initialize: function(config) {
            this.displayField = config.displayField;
            this.valueField = config.valueField
        }
    });

    var configureError = function (prop) {
        throw new Error("`" + prop +"` option should be defined")
    };

    Views.Combobox = Marionette.CollectionView.extend({
        tagName: 'select',
        className: 'styled',
        childView: Views.ComboboxItemView,
        childViewOptions: function () {
            return {
                displayField: this.displayField,
                valueField: this.valueField
            }
        },
        onSelectOption: function(e, ui) {
            this.trigger('select', e, ui);
        },
        onRender: function(){
            (this.name != null) && this.$el.attr("name", this.name);
            (this.size != null) && this.$el.attr("size", this.size);
            (this.multiple != null) && this.$el.prop("multiple", true);
            (this.required != null) && this.$el.prop("required", true);
            (this.value != null) && this.$("option[value="+ this.value + "]").prop("selected", true);
        },
        onDomRefresh: function () {
            if(!this.selectMenuCreated){
                if (this.hasDataUrl) {
                    this.dataLoaded = false;
                    var view = this;
                    this.$el.selectmenu({
                        open: function () {
                            if (!view.dataLoaded) {
                                view.collection.fetch(_.extend(view.dataAjaxOptions)).done(function () {
                                    view.dataLoaded = true;
                                    view.addDefault();
                                    view.render();
                                });
                            }
                        }
                    })
                } else{
                    this.$el.selectmenu();
                }

                this.$el.on("invalid", _.bind(function (e) {
                    e.preventDefault();
                    var errorBlock = $('<div style="color: red"><p>Пожалуйста заполните это поле!</p><div>');
                    var invalid = this.$el.selectmenu("widget").find(".ui-selectmenu-text").focus().hover();
                    invalid.parent().append(errorBlock);
                    invalid.one("click", function () {
                        errorBlock.remove();
                    })

                }, this));
                this.selectMenuCreated = true;
            } else {
                this.$el.selectmenu("refresh");
            }
            var self = this;
            this.$el.selectmenu({
                change: function (e, ui) {
                  self.onSelectOption(e, ui);
                }
            });
        },
        addDefault: function () {
            var modelAttrs = {};
            modelAttrs[this.displayField] = "";
            modelAttrs[this.valueField] = "";
            if (!_.contains(this.collection.pluck(this.valueField), this.value) && this.value) {
                modelAttrs[this.valueField] = this.value;
                modelAttrs[this.displayField] = this.defaultText;
            } else if (!this.value){
                modelAttrs[this.displayField] = this.defaultText;
            }
            this.collection.unshift(modelAttrs);
        },
        initialize: function(config) {

            this.name = _.result(config, "name") || null;
            this.size = _.result(config, "size") || null;
            this.required = _.result(config, "required") || null;
            this.multiple = _.result(config, "multiple") || null;
            this.valueField = _.result(config, "valueField") || "id";
            this.displayField = _.result(config, "displayField") || "name";
            this.dataUrl = _.result(config, "dataUrl") || null;
            this.dataApiMethod = _.result(config, "dataApiMethod") || null;
            this.dataAjaxOptions = _.result(config, "dataAjaxOptions") || {};
            this.value = _.result(config, "value") || null;
            this.defaultText = _.result(config, "defaultText") || "";
            this.selectMenuCreated = false;
            var data = _.result(config, "data") || null;
            data = data && _(data);

            var hasOwnCollection = Boolean(this.collection);
            this.hasDataUrl = Boolean(this.dataUrl && !hasOwnCollection && !data);

            if (!(hasOwnCollection || data || this.dataUrl)) {
                configureError("collection, data or dataUrl")
            }


            if (!hasOwnCollection) {
                var modelDefaults = {};
                modelDefaults[this.valueField] = "";
                modelDefaults[this.displayField] = "";
                var collectionConfig = {
                    model: Backbone.Model.extend({defaults: modelDefaults}),
                    url: this.dataUrl || undefined
                };
                if (this.dataApiMethod) {
                    collectionConfig.apiMethods = {read: this.dataApiMethod}
                }
                var Collection = Backbone.Collection.extend(collectionConfig);
                this.collection = new Collection();
            }

            this.addDefault();

            // если вместо коллекции пришел массив или объект
            if (!hasOwnCollection && !this.dataUrl && data) {
                var modelAttrs;
                if (data.isArray()) {
                    data.each(function(item) {
                        modelAttrs = {};
                        modelAttrs[this.valueField] = item;
                        modelAttrs[this.displayField] = item;
                        this.collection.add(modelAttrs)
                    }, this);
                } else if (data.isObject()) {
                    data.each(function(item, key){
                        modelAttrs = {};
                        modelAttrs[this.valueField] = key;
                        modelAttrs[this.displayField] = item;
                        this.collection.add(modelAttrs);
                    }, this);
                }
            }
        }
    });

    Views.ComboboxCustom = Views.Combobox.extend({
        onDomRefresh: function () {
            if(!this.selectMenuCreated){
                if (this.hasDataUrl) {
                    this.dataLoaded = false;
                    var view = this;
                    this.$el.styledselectmenu({
                        open: function () {
                            if (!view.dataLoaded) {
                                view.collection.fetch(_.extend(view.dataAjaxOptions)).done(function () {
                                    view.dataLoaded = true;
                                    view.addDefault();
                                    view.render();
                                });
                            }
                        }
                    })
                } else{
                    this.$el.styledselectmenu();
                }

                this.$el.on("invalid", _.bind(function (e) {
                    e.preventDefault();
                    var errorBlock = $('<div style="color: red"><p>Пожалуйста заполните это поле!</p><div>');
                    var invalid = this.$el.selectmenu("widget").find(".ui-selectmenu-text").focus().hover();
                    invalid.parent().append(errorBlock);
                    invalid.one("click", function () {
                        errorBlock.remove();
                    })

                }, this));
                this.selectMenuCreated = true;
            } else {
                this.$el.styledselectmenu("refresh");
            }
            var self = this;
            this.$el.styledselectmenu({
                change: function (e, ui) {
                  self.onSelectOption(e, ui);
                }
            });
        },
    });

    Views.ConfirmView = Marionette.ItemView.extend({
        template: "#confirm-remove-template",
        behaviors: {
            Modal: {},
            Closable: {el: '.close-popup'},
            // Maskable: {},
        },

        ok_btn_label: 'Удалить',
        ok_btn_class: "btn red fr",

        triggers: {
            'click .ok-button': 'select:ok',
        },

        initialize: function(config){
            config = config || {};
            this.model = this.model || new Backbone.Model();
            this.model.set({
                ok_btn_label: config.ok_btn_label || this.ok_btn_label,
                ok_btn_class: config.ok_btn_class || this.ok_btn_class,
                text: config.text || 'Внимание! Да или нет?',
            });
        },
    });

    Views.SelectBoxItem = Marionette.ItemView.extend({
      tagName: 'li',
      template: '#selectbox-item',
      events: {
        'click': 'select'
      },
      initialize: function () {
        this.model.on('change:selected', _.bind(function (model) {
          this.$el.toggleClass('selected');
        }, this));
      },
      select: function (e) {
        _.each(this.model.collection.where({selected: true}), function (item) {
            item.set('selected', false);
        });
        this.model.set('selected', true);
      },
      onRender: function() {
        if (this.model.get('selected')) {
          this.$el.addClass('selected');
        }
      }
    });

    Views.SelectBox = Marionette.CompositeView.extend({
      template: '#selectbox',
      childView: Views.SelectBoxItem,
      className: 'select-box',
      childViewContainer: '.selectbox-select',
      ui: {
        'trigger': '.selectbox-trigger',
        'selectboxSelect': '.selectbox-select',
        'display': '#display',
        'valueField': '#valueField'
      },
      events: {
        'click @ui.trigger': 'toggle',
        'keyup @ui.display': 'autocomplete',
        'click li': 'select',
        'click': 'click'
      },
      initialize: function (options) {
        _.bindAll(this, 'scrollInit');
        _.bindAll(this, 'reInitScroll');
        _.bindAll(this, 'loadData');
        _.bindAll(this, 'clickOnDocument');

        this.value = options.value;
        this.name = options.defaultText;

        var Model = Backbone.Model.extend({});
        this.model = new Model({
          disabled: options.disabled || false,
          fieldName: options.name,
          valueField: options.valueField || 'id',
          displayField: options.displayField || 'name',
          filterParams: options.filterParams || {},
          // Кол-во введеных символов для авто комплита
          autoCompleteKeyLength: options.autoCompleteKeyLength || 2,
          required: options.required || false
        });

        this.collection.on('change', _.bind(function () {
          var valueField = this.model.get('valueField');
          var displayField = this.model.get('displayField');
          var selected = this.collection.findWhere({'selected': true});
          this.ui.display.val(selected ? selected.get(displayField) : '');
          this.ui.valueField.val(selected ? selected.get(valueField) : '');
          this.ui.selectboxSelect.hide();
        }, this));

        this.searchValue = _.debounce(this.searchValue, 500);
      },
      scrollInit: function () {
        this.pane = this.$el.find('.selectbox-select');
        this.pane.jScrollPane({showArrows: true, mouseWheelSpeed:20});
      },
      onShow: function () {
        this.scrollInit();
        if (this.model.get('disabled')) {
          this.ui.display.attr('disabled', true);
        }
        
        this.model.on('change:disabled, change:filterParams', _.bind(function (model) {
          var disabled = model.get('disabled');
          this.ui.display.attr('disabled', disabled);
          this.ui.valueField.val('');
          this.ui.display.val('');
          this.collection.last_query = null;
        }, this));

        if (this.name && this.value) {
          this.ui.valueField.val(this.value);
          this.ui.display.val(this.name);
        }

        $(document).on('click', this.clickOnDocument);
      },
      onDestroy: function () {
        $(document).unbind('click', this.clickOnDocument);
      },
      clickOnDocument: function (e) {
        if ($(e.target).closest(this.$el).length === 0) {
          this.ui.selectboxSelect.hide();
        }
      },
      reInitScroll: function() {
        var jspApi = this.pane.data('jsp') ? this.pane : null;
        (jspApi ? jspApi.reinitialise : this.scrollInit)();
      },
      toggle: function (e) {
        if (this.model.get('disabled')) {
          return;
        }

        if (!this.collection.last_query) {
          this.loadData();
          this.collection.last_query = true;
        }
        this.ui.selectboxSelect.toggle();
      },
      loadData: function(search) {
        var data = _.clone(this.model.get('filterParams') || {});

        if (search) {
          data[this.model.get('displayField')] = search;
        }

        var beforeText = this.ui.display.val();
        var beforeValue = this.ui.valueField.val();

        $.when(this.collection.fetch({
          method: 'POST', data: data
        })).then(_.bind(function() {
          var currentValue = parseInt(this.ui.valueField.val());
          var selected = this.collection.findWhere({id: currentValue});
          if (selected) {
            selected.set('selected', true);
          }

          this.render();
          this.ui.display.val(beforeText).focus();
          this.ui.valueField.val(beforeValue);
          this.ui.selectboxSelect.show();
          this.reInitScroll();
        }, this));
      },
      autocomplete: function (e) {
        this.searchValue();
        this.resetValue();
      },
      searchValue: function () {
        var text = this.ui.display.val ? this.ui.display.val() : null;
        if (text && text.length >= this.model.get('autoCompleteKeyLength')) {
          this.loadData(text);
        }
        this.collection.last_query = null;
      },
      resetValue: function () {
        if (!this.ui.display.val()) {
          this.ui.selectboxSelect.hide();
          this.ui.valueField.val('');
          this.collection.each(function(model) {
            model.set('selected', false);
          });
          this.trigger('select:ok', null);
        }
        this.collection.last_query = null;
      },
      select: function (e) {
        this.trigger('select:ok', this.collection.findWhere({selected: true}).get('id'));
      }
    });

    Views.MaskView = Marionette.ItemView.extend({
        template: '#tab-maskable-template',
        initialize: function(obj) {
             var Model = Backbone.Model.extend({});
             var img_path = {
                 book: '/static/personal_area/images/book.png',
                 bell: '/static/personal_area/images/bell.png',
                 check: '/static/personal_area/images/check.png',
                 school: '/static/personal_area/images/school.png',
                 homework: '/static/personal_area/images/homework.png',
                 portfolio: '/static/personal_area/images/portfolio.png',
                 people: '/static/personal_area/images/people.png',
                 megaphone: '/static/personal_area/images/megaphone.png',
                 mail: '/static/personal_area/images/mail-ico.png',
             };
             this.model = new Model({
                 img_src: img_path[obj.img],
             });
        }
    });
});

    
        PersonalArea.module("Core.Common", function (Common, PersonalArea, Backbone, Marionette, $, _) {

    Common.on("start", function(){

        // download urls
        $("a.download-url").on("click", function (e) {
            e.preventDefault();
            var hiddenIFrameID = 'hiddenDownloader',
                iframe = document.getElementById(hiddenIFrameID);
                if (iframe === null) {
                    iframe = document.createElement('iframe');
                    iframe.id = hiddenIFrameID;
                    iframe.style.display = 'none';
                    document.body.appendChild(iframe);
                }
                iframe.src = this.href;
        })

        var uagent = navigator.userAgent;//определяем версию ie
        uagent = uagent.indexOf("MSIE");
        if(uagent != -1){ // Если uagent не равен (-1) ie будет true
            var versIe = navigator.userAgent;  //  Создаем переменную versIe, помещаем в нее значение строки navigator.userAgent
            versIe = versIe.substr(uagent + 5, 2);
            versIe = parseInt(versIe); // Преобразуем в целое число
            PersonalArea.versIe = versIe
        }

        function configureBanners(){
            var cont=$('.banners'),
                cont2=$('.banners>div'),
                right=$('.wrapper>.right');

            $('.banners>span').on('click',function(){
                if(cont.is('.opened')) {
                    $.cookie('banner_closed', '1');
                    cont2.animate({height: 4}, 400, function(){cont.removeClass('opened')});
                    right.animate({'padding-bottom': 7}, 400);
                } else {
                    $.removeCookie('banner_closed');
                    cont2.animate({height: 143}, 400, function(){cont.addClass('opened')});
                    right.animate({'padding-bottom': 160}, 400);
                }
            });

            if(!$.cookie('banner_closed')){
                $(".banners>span").click();
            };

        }
        configureBanners();

    });
});

    
        PersonalArea.module("Core.Behavior", function (Views, PersonalArea, Backbone, Marionette, $, _) {

    PersonalArea.Behaviors.Indicator = Marionette.Behavior.extend({
        // листаемый список (показатели)
        defaults:{
            el: '.gpa',
            top: 0
        },
        events: {
            "click ul": "showPrevIndicator",
            "click .down": "showPrevIndicator",
            "click .up": "showNextIndicator"
        },
        showPrevIndicator: function(e){
            e.stopPropagation();
            var top = this.options.top,
                ul = this.$el.find("ul"),
                li = this.$el.find("li"),
                heightLi = li.outerHeight(),
                heightUl = li.size()*heightLi;

            if (top != heightUl-heightLi) {
                top += heightLi;
                ul.animate({top: "-="+heightLi}, 100, "linear");
            } else {
                li=li.eq(0).clone().appendTo(ul);
                ul.animate({top: "-="+heightLi}, 100, "linear", function(){$(this).css({top: 0});li.last().remove();});
                top=0;
            }
            this.options.top = top;
        },
        showNextIndicator: function(e){
            e.stopPropagation();
            var top = this.options.top,
                ul = this.$el.find("ul"),
                li = this.$el.find("li"),
                heightLi = li.outerHeight(),
                heightUl = li.size()*heightLi;
            if (top > 0) {
                top -= heightLi;
                ul.animate({top: "+="+heightLi}, 100, "linear");
            } else {
                li=li.last().clone().prependTo(ul);
                ul.animate({top: "+="+heightLi}, 100, "linear", function(){
                    li.first().remove();
                    $(this).css({top: -(heightUl)});
                    $(this).animate({top: "+="+heightLi}, 100, "linear");
                });
                top=heightUl-heightLi;
            }
            this.options.top = top;
        }

    });


    PersonalArea.Behaviors.Popupable = Marionette.Behavior.extend({
        // поведение, которое описывает всплытие окна
        defaults:{
            closeOnClickOverlay: false,
            el: "",
            popupView: undefined, // вьюха всплывающего окна
            popupEl: "div.popup",
            many: []
        },
        initialize: function() {
          this.view.on('render', function() {
            if (!_.isEmpty(this.options.many)) {
              this.multi();
            } else {
              this.one();
            }
          }, this);
        },
        multi: function() {
          _.each(this.options.many, function(item) {
            // Вешаем обработчики событий для всех попапов
            this.view.$(item.el).on('click', _.bind(function(e) {
              _.each(this.defaults, function(value, key) {
                if (key !== 'many')
                  this.options[key] = item.hasOwnProperty(key) ? item[key] : value;
              }, this);
              this.onShowPopup(e);
            }, this));
          }, this);
        },
        one: function() {
          // Если во вьюхе один попап
          var el = this.options.el ? this.view.$(this.options.el) : this.view.$el;
          el.on('click', _.bind(function(e) {
            this.onShowPopup(e);
          }, this));
        },
        hasPopupView: function () {
            return Boolean(this.options.popupView)
        },
        onShowPopup: function(e){
            e.preventDefault();
            e.stopPropagation();
            var overlay = $(".overlay"),
                popupView;
            if (this.hasPopupView()){
                popupView = new this.options.popupView({
                    model: this.view.model,
                    collection: this.view.model.collection || this.view.collection
                });
            } else {
                // можно не указывать вью, тогда будет div.popup
                var popupEl = this.$el.find(this.options.popupEl);
                if (!popupEl.length){
                    return
                }
                popupView = new Marionette.ItemView({
                    className: popupEl.attr('class'),
                    tagName: popupEl.prop('tagName'),
                    template: _.template(popupEl.html()),
                    events: {
                        "click .closable": function () {
                            this.trigger("close");
                        }
                    }
                });
            }
            this.view.trigger("popup:initialize", popupView);
            overlay.show();
            popupView.on("close", function () {
                PersonalArea.popupRegion.reset();
                overlay.hide()
            });
            popupView.on("show", function (){
                this.$el.show();
                popupView.$el.find('.popup:first').show();
            });
            PersonalArea.popupRegion.show(popupView);
            this.view.trigger("popup:show", popupView);

            if (this.options.closeOnClickOverlay) {
                overlay.one("click", function () {
                    popupView.trigger("close");
                    $(this).hide();
                });
            }
        }
    });

    PersonalArea.Behaviors.Maskable =  Marionette.Behavior.extend({
        defaults: {
            mask_parent: '.popup',
            params: {
                img_width: 50,
                img_height: 50,
                img_src: '/static/personal_area/images/spinner_big.gif'
            }
        },
        initialize: function() {
            var view = this.view;
            var options = this.options;
            this.view.showMask = function(){
                var mask = view.$(".view-mask");

                if(!mask.length){

                    var html = $("script#behaviour-maskable-template").html();
                    var template = _.template(html, options.params);
                    mask = $(template.trim());

                    // выравнивание по центру
                    var h = view.$(options.mask_parent).height(),
                        top_px = (h/2 - options.params.img_height/2),
                        top_per = top_px*100/h;

                    mask.find('.imgwrap').css({top: top_per + '%'});

                    mask.appendTo(view.$(options.mask_parent));
                }

                view.$('.view-overlay, view-mask').show();
            };

            this.view.hideMask = function(){
                view.$('.view-overlay, view-mask').hide();
            };
        }
    });

    PersonalArea.Behaviors.Modal = Marionette.Behavior.extend({
        // Добавление вьюхи поведения модального окна
        defaults: {
            // поправка выравнивания. сдвиг в процентах
            // относительно центрального положения
            top_extra: -10,
            alignment: true
        },

        initialize: function() {
            this.view.showModal = function(){
                PersonalArea.popupRegion.show(this);
            };
        },
        onShow: function(e){
            $(".overlay").show();

            this.view.on("close", function(){
                $(".overlay").hide();
                this.destroy();
            });

            if (this.options.alignment) {
              // выравнивание по центру
              var bh = $('body').height(),
                  ph = this.$('.popup').height(),
                  top_px = (bh/2 - ph/2),
                  top_per = top_px*100/bh;

              // устанавливаем top в процентах
              this.$('.popup').css({top: top_per + this.options.top_extra +'%'});
            }

            this.$('.popup').show();
        }
    });
    PersonalArea.Behaviors.MyModal = PersonalArea.Behaviors.Modal.extend({
        initialize: function() {
            this.view.showModal = function(){
                PersonalArea.anotherPopupRegion.show(this);
            };
        },
        onShow: function(e){
            $(".overlay").show();

            this.view.on("close", function(){
                this.destroy();
            });

            if (this.options.alignment) {
              // выравнивание по центру
              var bh = $('body').height(),
                  ph = this.$('.popup').height(),
                  top_px = (bh/2 - ph/2),
                  top_per = top_px*100/bh;

              // устанавливаем top в процентах
              this.$('.popup').css({top: top_per + this.options.top_extra +'%'});
            }

            this.$('.popup').show();
        }
    });

    PersonalArea.Behaviors.Closable = Marionette.Behavior.extend({
        // поведение закрывающейся штуки
        defaults:{
            el: '.closable'
        },
        events: function () {
            var events = {},
                event = "click " + this.options.el;
            events[event] = "onClosePopup";
            return events;
        },
        initialize: function() {
            var pThis = this;
            const keyEscape = 27;

            // Событие на клавишу esc
            $(document).keyup(function(e) {
                if (e.keyCode == keyEscape) {
                    pThis.onClosePopup(e)
                }
            });
        },
        onClosePopup: function(e){
            e.stopPropagation();
            this.view.trigger("close");
        }
    });

    PersonalArea.Behaviors.SubMenu = Marionette.Behavior.extend({
        // показ всплывающего подменю при клике по .menu-item
        defaults:{
            el: '.menu-item'
        },
        events: {
            "click": "toggleSubmenu"
        },
        toggleSubmenu: function(e){
            e.stopPropagation();
            var menuItem = this.$el;
            menuItem.toggleClass('active').find('.more').fadeToggle();
            if (menuItem.hasClass('active')){
                $('.page').one('click',function(){
                    menuItem.removeClass('active').find('.more').fadeOut()
                });
            }

        }
    });

    PersonalArea.Behaviors.Accordion = Marionette.Behavior.extend({
        defaults: {
            firstOpen: false
        },
        events: {
            'click .accordion > div': 'toggleAccordion'
        },
        onRender: function () {
            if (this.options.firstOpen) {
                // Откроет первый элемент аккордиона
                this.view.$el.find('.accordion').first().addClass('open');
            }
        },
        toggleAccordion: function(event) {
            $(event.currentTarget).parent('.accordion').toggleClass('open');
        }
    });

    PersonalArea.Behaviors.jScrollPane = Marionette.Behavior.extend({
        defaults: {
            container: "td.table_cont>div:first",
            scrollToBottom: false,
            minHeight: 'auto',
            jspaneConf: {
                showArrows: true,
                mouseWheelSpeed:20
            }
        },
        onShow: function () {

            $el = this.$el;
            var jspane = $el.find(this.options.container);
            if(!jspane.length){
                return;
            }
            var scrollHeight = jspane.data('scroll-height');
            if (scrollHeight) {
                jspane.css({minHeight: scrollHeight})
            }
            jspane.jScrollPane(this.options.jspaneConf);
            var api = jspane.data('jsp');
            api.reinitialise();

            if (this.options.scrollToBottom) {
                api.scrollToBottom();
            }

            this.view.jspane_api = api;

            // хак для правильного расчета ширины таблицы
            setTimeout(function(){api.reinitialise()}, 1000);

            var resize_ns = "resize.jspane" + this.view.cid;
            $(window).off(resize_ns).on(resize_ns, function() {
                if(api.getIsScrollableH()==false){
                    $el.find('.jspPane').css('left', 0);
                };
                api.reinitialise();
            });

            _.isFunction(this.options.afterinit) && this.options.afterinit.call(this, api);

            this.view.on('scroll:reinitialize', function(scrollbottom) {
                api.reinitialise();
                if (scrollbottom) {
                    api.scrollToBottom()
                }
            });

        }
    });

    /*
    Поведение для полей загрузки файлов.
    */
    PersonalArea.Behaviors.LoadFile = Marionette.Behavior.extend({
        onRender: function () {
            /* эмуляция работы загрузки файлов */
            this.view.$('.load_file > .btn, input[type=text]').not('.clear-inputs').on(
                'click', function(){
                    $(this).closest('.load_file').find('input[type=file]').click();
            });
            this.view.$('.load_file').on('click', '.btn.clear-inputs',function(e){
                $(this).closest('.load_file').find('input[type=file], input[type=text]').val('');
            });
            this.view.$('input[type=file]').on('change',function(){
                var fileNames = [];
                var files = $(this)[0].files;

                if(files.length > 0) {
                    for (var i = 0; i < files.length; i++) {
                        fileNames.push(files[i].name);
                    }
                }
                // Отображение имен файлов в интерфейсе
                $(this).closest('.load_file').find('input[type=text]').val(fileNames.join('; '));
                // Сохранение имен файлов для серверной части
                fileNamesStorage = $(this).closest('.load_file').find(
                    'input[type=hidden][name="filenames"]')
                fileNamesStorage.val(JSON.stringify(fileNames));
            });

        }
    });

    /*
     Поведение для скачивания ссылок в скрытом iframe (не работает для картинок)
     @el: селектор для ссылок
     */
    PersonalArea.Behaviors.DownloadLink = Marionette.Behavior.extend({
        defaults: {
            el: "a.download"
        },
        events: function() {
            var events = {};
            events["click " + this.options.el] = function (e) {
                e.preventDefault();
                var hiddenIFrameID = 'hiddenDownloader',
                    iframe = document.getElementById(hiddenIFrameID);
                if (iframe === null) {
                    iframe = document.createElement('iframe');
                    iframe.id = hiddenIFrameID;
                    iframe.style.display = 'none';
                    document.body.appendChild(iframe);
                }
                iframe.src = e.target.href;
            };
            return events
        }
    });

    /*
    Для вьюх с полем редактирования даты
    @el: селектор поля с датой
     */
    PersonalArea.Behaviors.DateInput = Marionette.Behavior.extend({
      defaults: {
        el: "input[name=date]"
      },
      onRender: function () {
        var dateInput = this.view.$(this.options.el);
        dateInput.val(
          $.datepicker.formatDate(
            $.datepicker.regional.ru.dateFormat, new Date(dateInput.val())));
        dateInput.datepicker({
          showOtherMonths: true,
          selectOtherMonths: true
        });
      }
    });

    /*
    Отображение пустых CompositeView
    //todo: доделать для CollectionView

    @el: html для вставки вместо childView
     */
    PersonalArea.Behaviors.EmptyView = Marionette.Behavior.extend({
      defaults: {
        el: ""
      },
      onRender: function () {
        var view = this.view;
        if (view.collection.length == 0) {
          view.$childViewContainer.append(this.options.el);
          view.collection.once("add", function () {
            view.render()
          })
        }
      },
      collectionEvents: {
        remove: function () {
          if (this.view.collection.length == 0) {
            this.view.render()
          }
        }
      }
    });


    /*
    wysiwig редактор для textarea
    @el: селектор для textarea
    */
    PersonalArea.Behaviors.CKEditor = Marionette.Behavior.extend({
      defaults: {
        el: ".ckeditor-area"
      },
      onRender: function () {
        this.$(this.options.el).ckeditor();
      }
    });

});

    
        /**
 * Created by tim on 17.07.14.
 */

PersonalArea.module("Core.Datepicker", function (Datepicker, PersonalArea, Backbone, Marionette, $, _) {

    Datepicker.Controller = Marionette.Controller.extend({

        showDatePicker: function (config, onSelect) {
            config = _.extend({
                showOtherMonths: true,
                selectOtherMonths: true,
                onSelect: function(dateString, datePicked) {
                    $('.calendar').removeClass('active').find('.calendar_wrap').slideUp();
                    if (_.isFunction(onSelect)) {
                        onSelect(datePicked);
                    }
                }
            }, (config || {}));
            var datepicker = $('#datepicker').datepicker(config);
            $().datepicker($.datepicker.regional["ru"]);
            $('.calendar_btn').on('click',function(e){
                $('.calendar').toggleClass('active').find('.calendar_wrap').slideToggle();
            });

            $('body').on('click',function(e) {
                var target = $(e.target);
                if(target.closest('.calendar').length>0 ||
                    target.is('.ui-datepicker-prev') ||
                    target.is('.ui-datepicker-next') ||
                    target.closest('.ui-datepicker-next').length>0 ||
                    target.closest('.ui-datepicker-next').length>0) {
                    e.stopPropagation();
                } else {
                    $('.calendar').removeClass('active').find('.calendar_wrap').slideUp();
                }
            });
            return datepicker;

        }
    });

});
    
        /**
 * Created by tim on 18.07.14.
 */

PersonalArea.module("Core.Widget.Models", function (Models, PersonalArea, Backbone, Marionette, $, _) {

    Models.Widget = Backbone.Model.extend({
        initialize: function (config) {
            var controller = PersonalArea.getModuleAttr(config.controller);
            this.controller = new controller();
        }
    });
    Models.WidgetCollection = Backbone.Collection.extend({
        model: Models.Widget
    });

    Models.initializeWidgets = function () {
        return new Models.WidgetCollection(
            [{"controller": "Core.Widget.Menu.Controller"}, {"controller": "Core.Widget.Meeting.Controller"}, {"controller": "Core.Widget.ClassHours.Controller"}, {"controller": "Core.Widget.Events.Controller"}, {"controller": "Core.Widget.Birthdays.Controller"}]
        );
    }
});
    
        /**
 * Created by tim on 18.07.14.
 */


PersonalArea.module("Core.Widget.Views", function (Views, PersonalArea, Backbone, Marionette, $, _) {

    Views.WidgetsView = Marionette.CompositeView.extend({

        getChildView: function (model) {
            return model.controller.getView();
        },
        
        childViewOptions: function (model) {
            return model.controller.getOptions();
        },
        
        template: _.template("<div/>"),
        childViewContainer: "div"
    });

    Views.WidgetLayoutView = Marionette.LayoutView.extend({

    })
});
    
        /**
 * Created by tim on 15.07.14.
 */

PersonalArea.module("Core.Widget", function (Widget, PersonalArea, Backbone, Marionette, $, _) {

    Widget.Controller = Marionette.Controller.extend({
        showWidgets: function () {
            var widgets = PersonalArea.Core.Widget.Models.initializeWidgets(),
                view = new Widget.Views.WidgetsView({
                    collection: widgets
                });
            PersonalArea.leftRegion.show(view);
        }

    });

    Widget.on("start", function(){
        var controller = new Widget.Controller();
        controller.showWidgets();
    });

});

    
        /**
 * Created by tim on 15.07.14.
 */

PersonalArea.module("Core.Widget.Menu.Models", function(Models, PersonalArea, Backbone, Marionette, $, _){
    Models.MenuItem = Backbone.Model.extend({
        defaults: {
            'submenu': []
        }
    });
    Models.MenuItems = Backbone.Collection.extend({
        model: Models.MenuItem
    });
    
    Models.initializeMenu = function () {
        return new Models.MenuItems(
            [{"url": "diary", "text": "\u0414\u043d\u0435\u0432\u043d\u0438\u043a", "className": "diary"}, {"url": "schedule", "text": "\u0420\u0430\u0441\u043f\u0438\u0441\u0430\u043d\u0438\u0435", "className": "schedule"}, {"url": "marks", "text": "\u041e\u0446\u0435\u043d\u043a\u0438", "className": "grades"}, {"url": "school", "text": "\u0428\u043a\u043e\u043b\u0430", "className": "school"}, {"url": "homework", "text": "\u0414\u043e\u043c\u0430\u0448\u043d\u0435\u0435 \u0437\u0430\u0434\u0430\u043d\u0438\u0435", "className": "homework"}, {"url": "portfolio", "text": "\u041f\u043e\u0440\u0442\u0444\u043e\u043b\u0438\u043e", "className": "portfolio"}, {"url": "advertboard", "text": "\u0414\u043e\u0441\u043a\u0430 \u043e\u0431\u044a\u044f\u0432\u043b\u0435\u043d\u0438\u0439", "className": "board", "event": "change:advertboard", "idx": 3}, {"url": "mailbox/inbox", "text": "\u041f\u043e\u0447\u0442\u0430", "className": "mailbox", "event": "change:mailbox", "idx": 4}]
        )
    }
});

    
        /**
 * Created by tim on 15.07.14.
 */

PersonalArea.module("Core.Widget.Menu.Views", function (Views, PersonalArea, Backbone, Marionette, $, _) {
    Views.SubMenuItemView = Marionette.ItemView.extend({
        tagName: 'li',
        template: '#submenu-item-template',
        initialize: function() {
            var count = this.model.get('count');
            if (!count) { this.model.set('count', 0) }
            if (this.model.has('event')) {
                PersonalArea.Core.Widget.Menu.on(this.model.get('event'), function(value) {
                    this.model.set('count', value);
                    this.render();
                }, this)
            }
        },
        onShow: function() {
            this.$el.addClass(this.model.get('className'));
        }
    });

    // Главное меню
    Views.MenuItemView = Marionette.CompositeView.extend({
        tagName: "li",
        template: "#menu-item",
        childView: Views.SubMenuItemView,
        childViewContainer:  function() {
            if (!_.isEmpty(this.model.get('submenu'))) {
                return 'ul';
            }
            return 'a';
        },
        className: function() {
            return this.model.get('className');
        },
        onRender: function () {
            this.$el.addClass(this.model.get("name"));
        },
        initialize: function() {
            var submenu = this.model.get('submenu');
            if (submenu) {
                this.collection = new Backbone.Collection(submenu);
            }

            var count = this.model.get('count');
            if (!count) { this.model.set('count', 0) }
            if (this.model.has('event')) {
                PersonalArea.Core.Widget.Menu.on(this.model.get('event'), function(value) {
                    this.model.set('count', value);
                    this.render();
                    PersonalArea.Core.Widget.Menu.setActiveMenu();
                }, this)
            }
        }
    });

    Views.MenuCollectionView = Marionette.CollectionView.extend({
        tagName: "ul",
        className: "menu",
        childView: Views.MenuItemView
    });


});

    
        /**
 * Created by tim on 18.07.14.
 */

PersonalArea.module("Core.Widget.Menu", function (Menu, PersonalArea, Backbone, Marionette, $, _) {

    Menu.Controller = Marionette.Controller.extend({

        getView: function () {
            return Menu.Views.MenuCollectionView
        },

        getOptions: function () {
            var menuItems = Menu.Models.initializeMenu();
            return {
                collection: menuItems
            }
        }
    });

    Menu.setActiveMenu = function () {
        $(".menu li>a").removeClass("active");

        var fragment = Backbone.history.fragment;
        var first = fragment.match(/^[^/]+/);
        var menuitem = $('.menu li>a[href^="#'+ first + '"]');
        menuitem.addClass("active");

        $(".menu li>.sub_menu").hide();
        var submenu = menuitem.parent('li').find('.sub_menu');
        submenu.show();

        // подсветка пункта субменю
        submenu.find('ul li>a').removeClass('active');
        var submenu_url = fragment.match(/^\w+?\/\w+/);

        if(submenu.length!=0 && submenu_url){
            submenu.find('ul li>a[href^="#'+ submenu_url + '"]')
                .addClass("active");
        }
    };

    Backbone.history.on("route", function(router, route, params){

        if (PersonalArea.need_select) {
            if (!(this.fragment.search('profile') == 0 ||
                  this.fragment.search('interaction/') == 0 ||
                  this.fragment.search('advertboard') == 0 ||
                  this.fragment.search('mailbox') == 0)
            ) {
                PersonalArea.navigate('#profile')
            }
        }

        Menu.setActiveMenu();
    });

});

    
        /**
 * Created by tim on 18.07.14.
 */

PersonalArea.module("Core.Widget.Birthdays.Models", function (Models, PersonalArea, Backbone, Marionette, $, _) {

    Models.Birthday = Backbone.Model.extend({});
    Models.Birthdays = Backbone.Collection.extend({
        model: Models.Birthday,
        url: '/api/WidgetService/getBirthdays',
        comparator: 'date'
    })

});
    
        /**
 * Created by tim on 18.07.14.
 */

PersonalArea.module("Core.Widget.Birthdays.Views", function (Views, PersonalArea, Backbone, Marionette, $, _) {
    Views.BirthdayView = Marionette.ItemView.extend({
        className: 'clearfix',
        template: '#birthday-item-template',
        initialize: function () {
            var date = new Date(this.model.get('date'));
            if (date.isToday()) {
                this.model.set('date', 'Сегодня');
            }
        }
    });

    Views.Birthdays = Marionette.CompositeView.extend({
        className: 'info_block birthdays',
        template: '#birthdays-collection-template',
        childView: Views.BirthdayView,
        initialize: function() {
            this.collection.fetch().done(_.bind(function() {
                this.render(this.collection);
                this.collection.on('add', this.render, this.collection);
                this.collection.on('reset', this.render, this.collection);
            }, this));
        },
        onRender: function() {
            _.isEmpty(this.collection.models) ? this.$el.hide() : this.$el.show();
        },
        appendHtml: function (collectionView, itemView, index) {
            collectionView.el.appendChild(itemView.el);
        }
    });

});
    
        /**
 * Created by andrey on 25.07.14.
 */

PersonalArea.module("Core.Widget.Birthdays", function (Birthdays, PersonalArea, Backbone, Marionette, $, _) {
    Birthdays.Controller = Marionette.Controller.extend({
        getView: function () {
            return Birthdays.Views.Birthdays;
        },
        getOptions: function () {
            Birthdays.birthdays = new Birthdays.Models.Birthdays();
            return {
                collection: Birthdays.birthdays
            }
        }
    });
});
    
        /**
 * Created by tim on 18.07.14.
 */

PersonalArea.module("Core.Widget.Meeting.Models", function (Models, PersonalArea, Backbone, Marionette, $, _) {

    Models.Meeting = Backbone.Model.extend({
        url: '/api/WidgetService/getMeeting',
        defaults: {
            date: '', begin: '', end: '', office: '', protocol: ''
        }
    });

});
    
        /**
 * Created by tim on 18.07.14.
 */

PersonalArea.module("Core.Widget.Meeting.Views", function (Views, PersonalArea, Backbone, Marionette, $, _) {

    Views.MeetingView = Marionette.ItemView.extend({
        className: 'info_block meeting',
        template: '#meeting-widget-template',
        initialize: function() {
            this.model.fetch().done(_.bind(function(){
                this.render(this);
                this.model.on('sync', this.render, this);
            }, this));
        },
        onRender: function() {
            _.any(this.model.attributes) ? this.$el.show() :  this.$el.hide();
        },
        events: {
          "click .download-url": function () {
            $.post(
              "/api/WidgetService/NotifyMeetingProtocolRead",
              {meeting_id: this.model.id}
            );
          }
        }
    });
});

    
        /**
 * Created by tim on 18.07.14.
 */

PersonalArea.module("Core.Widget.Meeting", function (Meeting, PersonalArea, Backbone, Marionette, $, _) {

    Meeting.Controller = Marionette.Controller.extend({
        
        getView: function () {
            return Meeting.Views.MeetingView;
        },
        
        getOptions: function () {
            Meeting.meetings = new Meeting.Models.Meeting();
            return {
                model: Meeting.meetings
            }
        }
        
    });
});
    
        /**
 * Created by tim on 18.07.14.
 */

PersonalArea.module("Core.Widget.Events.Models", function (Models, PersonalArea, Backbone, Marionette, $, _) {
    Models.Event = Backbone.Model.extend({});
    Models.Events = Backbone.Collection.extend({
        mode: Models.Event,
        url: '/api/WidgetService/getEvents'
    });

});
    
        /**
 * Created by tim on 18.07.14.
 */

PersonalArea.module("Core.Widget.Events.Views", function (Views, PersonalArea, Backbone, Marionette, $, _) {
    Views.EventView = Marionette.ItemView.extend({
        tagName: 'li',
        template: '#events-item-template'
    });

    Views.Events = Marionette.CompositeView.extend({
        className: 'info_block activity',
        template: '#events-collection-template',
        childView: Views.EventView,
        childViewContainer: 'ul',
        ui: {
            button: '.open_list',
            container: 'ul'
        },
        events: {
            'click @ui.button': 'toggle'
        },
        toggle: function(e) {
            this.ui.button.toggleClass('active');
            this.ui.container.toggleClass('active');
        },
        initialize: function() {
            this.collection.fetch().done(_.bind(function() {
                this.render(this.collection);
                this.collection.on('add', this.render, this.collection);
                this.collection.on('reset', this.render, this.collection);
            }, this));
        },
        onRender: function() {
            _.isEmpty(this.collection.models) ? this.$el.hide() : this.$el.show();
        }
    });

});
    
        /**
 * Created by andrey on 25.07.14.
 */

PersonalArea.module("Core.Widget.Events", function (Events, PersonalArea, Backbone, Marionette, $, _) {
    Events.Controller = Marionette.Controller.extend({
        getView: function () {
            return Events.Views.Events;
        },
        getOptions: function () {
            Events.events = new Events.Models.Events();
            return {
                collection: Events.events
            }
        }
    });
});
    
        /**
 * Created by andrey on 04.08.14.
 */

PersonalArea.module("Core.Widget.ClassHours.Models", function (Models, PersonalArea, Backbone, Marionette, $, _) {

    Models.ClassHour = Backbone.Model.extend({
        defaults: {
            date: '', begin: '', end: '', theme: '', place: ''
        },
        url: '/api/WidgetService/getClassHours'
    });

});
    
        /**
 * Created by andrey on 04.08.14.
 */

PersonalArea.module("Core.Widget.ClassHours.Views", function (Views, PersonalArea, Backbone, Marionette, $, _) {
    Views.ClassHourView = Marionette.ItemView.extend({
        className: 'info_block meeting',
        template: '#classhour-widget-template',
        initialize: function() {
            this.model.fetch().done(_.bind(function(){
                this.render(this);
                this.model.on('sync', this.render, this);
            }, this));
        },
        onRender: function() {
            _.any(this.model.attributes) ? this.$el.show() :  this.$el.hide();
        }
    });
});
    
        /**
 * Created by andrey on 25.07.14.
 */

PersonalArea.module("Core.Widget.ClassHours", function (ClassHours, PersonalArea, Backbone, Marionette, $, _) {
    ClassHours.Controller = Marionette.Controller.extend({
        getView: function () {
            return ClassHours.Views.ClassHourView;
        },
        getOptions: function () {
            ClassHours.classHours = new ClassHours.Models.ClassHour();
            return {
                model: ClassHours.classHours
            }
        }
    });
});
    
        PersonalArea.module("Core.HeaderWidget.Models", function (Models, PersonalArea, Backbone, Marionette, $, _) {

    Models.HeaderWidget = Backbone.Model.extend({
        initialize: function (config) {
            var controller = PersonalArea.getModuleAttr(config.controller);
            this.controller = new controller();
        }
    });
    Models.HeaderWidgetCollection = Backbone.Collection.extend({
        model: Models.HeaderWidget
    });

    Models.initializeHeaderWidgets = function () {
        var collection = new Models.HeaderWidgetCollection(
            [{"controller": "Core.HeaderWidget.Today.Controller", "idx": 0}, {"controller": "Core.HeaderWidget.Gpa.Controller", "idx": 2}, {"controller": "Core.HeaderWidget.Profile.Controller", "idx": 1}]
        );
        collection.comparator = function (widget) {
            return widget.get('idx');
        };
        return collection
    }
});

    
        PersonalArea.module("Core.HeaderWidget.Views", function (Views, PersonalArea, Backbone, Marionette, $, _) {

    Views.HeaderWidgetsView = Marionette.CompositeView.extend({

        getChildView: function (model) {
            return model.controller.getView();
        },
        
        childViewOptions: function (model) {
            return model.controller.getOptions();
        },
        
        template: _.template("<div/>"),
        className: "header clearfix",
        template: "#header-widget-template",
        childViewContainer: "div"
    });

    Views.HeaderWidgetLayoutView = Marionette.LayoutView.extend({

    });
});
    
        PersonalArea.module("Core.HeaderWidget", function (HeaderWidget, PersonalArea, Backbone, Marionette, $, _) {

    HeaderWidget.Controller = Marionette.Controller.extend({
        showHeaderWidgets: function () {
            var headerWidgets = PersonalArea.Core.HeaderWidget.Models.initializeHeaderWidgets();
            headerWidgets.sort();
            var view = new HeaderWidget.Views.HeaderWidgetsView({
                collection: headerWidgets
            });
            PersonalArea.headerRegion.show(view);
        },
        show: function() {
            if (PersonalArea.Core.personData.fetched) {
              this.showHeaderWidgets();
            } else {
              PersonalArea.Core.personData.on('sync', function() {
                this.showHeaderWidgets();
              }, this);
            }
        }

    });

    HeaderWidget.Router = Marionette.AppRouter.extend({
        initialize: function(option) {
          Backbone.history.on('route', function(controller) {
            if (!Backbone.history.fragment.match(/^interaction/)) {
              this.controller.show();
            }
          }, option);
        }
    });

    var controller = new HeaderWidget.Controller();

    PersonalArea.addInitializer(function() {
        new HeaderWidget.Router({
            controller: controller
        });

        PersonalArea.Core.personData = new PersonalArea.Profile.Models.PersonData();
        PersonalArea.Core.personData.fetch().done(function() {
            PersonalArea.Core.personData.fetched = true;
        });
    });

});

    
        PersonalArea.module("Core.HeaderWidget.Gpa.Models", function (Models, PersonalArea, Backbone, Marionette, $, _) {

    Models.Indicator = Backbone.Model.extend({})
    Models.Indicators = Backbone.Collection.extend({
        model: Models.Indicator
    });

});

    
        PersonalArea.module("Core.HeaderWidget.Gpa.Views", function (Views, PersonalArea, Backbone, Marionette, $, _) {

    Views.IndicatorItemView = Marionette.ItemView.extend({
        tagName: "li",
        template: "#indicator-item-template",
    });

    Views.IndicatorView = Marionette.CompositeView.extend({
        template: "#indicator-template",
        attributes : function () {
            return {
              id : "indicator-container"
            };
        },
        childView: Views.IndicatorItemView,
        childViewContainer: "ul",
        behaviors: {Indicator: {top: 0}},
    });
});

    
        PersonalArea.module("Core.HeaderWidget.Gpa", function(Gpa, PersonalArea, Backbone, Marionette, $, _){
    Gpa.Controller = Marionette.Controller.extend({
        getView: function () {
            return Gpa.Views.IndicatorView;
        },
        getOptions: function () {
            var indicators = new Gpa.Models.Indicators();
            _.each(PersonalArea.Core.personData.get('indicators'), function (item) {
                var indicator = new Gpa.Models.Indicator({
                    name: item['name'],
                    value: item['value'],
                    css: item['css']
                });
                indicator.collection = indicators;
                indicators.add(indicator);
            });
            return {
                collection: indicators
            }
        }
    });
});

    
        PersonalArea.module("Core.HeaderWidget.Today.Models", function (Models, PersonalArea, Backbone, Marionette, $, _) {

});

    
        PersonalArea.module("Core.HeaderWidget.Today.Views", function (Views, PersonalArea, Backbone, Marionette, $, _) {

    Views.TodayView = Marionette.LayoutView.extend({
        template: "#today-template",
    });
});

    
        PersonalArea.module("Core.HeaderWidget.Today", function(Today, PersonalArea, Backbone, Marionette, $, _){
    Today.Controller = Marionette.Controller.extend({
        getView: function () {
            return Today.Views.TodayView;
        },
        getOptions: function () {
            var weekDate = new Date();
            return {
                model: new Backbone.Model({
                    'weekDayName': weekDate.getDayName(),
                    'day': weekDate.getDate(),
                    'month': weekDate.getMonthName(),
                    'year': weekDate.getFullYear()
                })
            }
        }
    });
});

    
        PersonalArea.module("Core.HeaderWidget.Profile.Models", function (Models, PersonalArea, Backbone, Marionette, $, _) {
});

    
        PersonalArea.module("Core.HeaderWidget.Profile.Views", function (Views, PersonalArea, Backbone, Marionette, $, _) {
    Views.HeaderProfileView = Marionette.ItemView.extend({
        template: "#profile-header-template",
        attributes : function () {
            return {
              id : "profile-container"
            };
        },
        behaviors: {SubMenu: {top: 0}},
        events: {
            
            "click a.go_profile": "onProfileBtn"
        },
        onProfileBtn: function(){
            PersonalArea.navigate("profile");
        }
    });
});

    
        PersonalArea.module("Core.HeaderWidget.Profile", function(Profile, PersonalArea, Backbone, Marionette, $, _){
    Profile.Controller = Marionette.Controller.extend({
        getView: function () {
            return Profile.Views.HeaderProfileView;
        },
        getOptions: function () {
            return {
                model: PersonalArea.Core.personData
            }
        }
    });
});

    
        /**
 * Created by tim on 05.08.14.
 */

PersonalArea.module("Portfolio.Models", function (Models, PersonalArea, Backbone, Marionette, $, _) {

  var fileMimeGroups = {
    "image": "image",
    "text": "txt",
    "application": "txt",
    "audio": "audio",
    "video": "video"
  };

  Models.Creation = Backbone.Model.extend({
    url: "/api/PortfolioServices",
    apiMethods: {
      read: "GetCreations",
      create: "CreateCreation",
      update: "UpdateCreation",
      patch: "UpdateCreation",
      "delete": "DeleteCreation"
    },
    defaults: function () {
      return {
        name: "",
        date: new Date(),
        description: "",
        discipline: {
          id: "",
          name: ""
        },
        master: {
          id: "",
          name: ""
        },
        document_name: "",
        document_url: "",
        document_size: 0,
        document_mime_type: "text/plain",
        preview_url: ""
      }
    },
    initialize: function () {
      var documentMimeGroup = this.get("document_mime_type").split("/")[0];
      this.set("documentType", fileMimeGroups[documentMimeGroup]);
      this.set("dateInstance", new Date(this.get("date")));
    }
  });

  Models.Creations = Backbone.Collection.extend({
    model: Models.Creation,
    apiMethods: {
      read: "GetCreations"
    },
    url: "/api/PortfolioServices"
  });

  Models.Egegia = Backbone.Model.extend({
    defaults: {
      exam_date: "",
      discipline_name: "",
      task_a: "",
      task_b: "",
      task_c: "",
      task_d: "",
      point: "",
      value: ""
    },
    initialize: function () {
      this.set("exam_date", new Date(this.get("exam_date")))
    }
  });

  Models.EgegiaCollection = Backbone.Collection.extend({
    model: Models.Egegia
  });

  Models.EgeCollection = Models.EgegiaCollection.extend({
    url: "/api/PortfolioServices",
    apiMethods: {
      read: "GetEgeResults"
    }
  });

  Models.GiaCollection = Models.EgegiaCollection.extend({
    url: "/api/PortfolioServices",
    apiMethods: {
      read: "GetGiaResults"
    }
  });

  Models.Training = Backbone.Model.extend({
    defaults: {
      param_name: "",
      first_value: "",
      second_value: ""
    }
  });

  Models.TrainingCollection = Backbone.Collection.extend({
    model: Models.Training,
    url: "/api/PortfolioServices",
    apiMethods: {
      read: "GetPhysicalTrainingData"
    }
  });

  Models.ChildEvent = Backbone.Model.extend({
    defaults: function () {
      return {
        date: new Date(),
        event_name: "",
        level_name: "",
        teacher_names: [],
        result: "",
        rating: "",
        document_url: ""
      }
    },
    initialize: function () {
      this.set("date", new Date(this.get("date")));
    }
  });

  Models.ChildEvents = Backbone.Collection.extend({
    model: Models.ChildEvent,
    url: "/api/PortfolioServices",
    apiMethods: {
      read: "GetChildEvents"
    }
  });

  Models.Achievement = Backbone.Model.extend({
    defaults: function () {
      return {
        date: new Date(),
        description: "",
        document_url: "",
        document_name: "",
        preview_url: "",
        document_mime_type: "text/plain"
      }
    },
    url: "/api/PortfolioServices",
    apiMethods: {
      read: "GetChildAwards",
      create: "CreateChildAward",
      update: "UpdateChildAward",
      patch: "UpdateChildAward",
      "delete": "DeleteChildAward"
    },
    initialize: function () {
      var documentMimeGroup = this.get("document_mime_type").split("/")[0];
      this.set("documentType", fileMimeGroups[documentMimeGroup]);
      this.set("dateInstance", new Date(this.get("date")));
    }
  });

  Models.Achievements = Backbone.Collection.extend({
    model: Models.Achievement,
    url: "/api/PortfolioServices",
    apiMethods: {
      read: "GetChildAwards"
    }
  });

  Models.ChildDisciplines = Backbone.Collection.extend({
    url: "/api/PortfolioFieldServices/GetChildDisciplines"
  });

  Models.DisciplineTeachers = Backbone.Collection.extend({
    url: "/api/PortfolioFieldServices/GetChildTeachers"
  });

});
    
        /**
 * Created by tim on 05.08.14.
 */

PersonalArea.module("Portfolio.Views", function (Views, PersonalArea, Backbone, Marionette, $, _) {

  Views.PortfolioView = Marionette.LayoutView.extend({
    template: "#portfolio-layout",
    className: "tabs portfolio",
    regions: {
      works: "#works",
      hobby: "#hobby",
      exams: "#exams",
      training: "#training",
      achievements: "#achievements"
    },
    showTab: function (regionId) {
      this.$(".content").hide();
      this.$("#" + regionId + " .content").show();
      this.$(".tab a").removeClass("active");
      this.$('.tab a[href="#' + regionId + '"]').addClass("active");
    },
    events: {
      "click div.tab a": function (e) {
        e.preventDefault();
        var regionName = e.target.hash.split("#")[1];
        this.trigger("show-region", regionName);
      }
    },
    onRender: function () {
      // вкладка по умолчанию - Творческая деятельность
      this.trigger("show-region", "works")
    }
  });

  // творчество

  Views.CreationAddView = Marionette.LayoutView.extend({
    template: "#creation-add-template",
    className: "popup",
    model: PersonalArea.Portfolio.Models.Creation,
    behaviors: {
      Closable: {},
      LoadFile: {},
      DateInput: {}
    },
    regions: {
      disciplineCombobox: ".discipline-combobox-region",
      masterCombobox: ".master-combobox-region"
    },
    events: {
      "submit form": function (e) {
        e.preventDefault();
        this.trigger("submit", e);
      }
    }
  });

  Views.CreationView = Marionette.ItemView.extend({
    tagName: "li",
    className: "clearfix",
    template: "#creation-template",
    model: PersonalArea.Portfolio.Models.Creation,
    events: {
      "click .edit-work": function () {
        this.trigger("creation:edit")
      },
      "click .delete-work": function () {
        this.trigger("creation:delete")
      }
    },
    initialize: function() {
      this.model.bind('change', this.render);
    }
  });

  Views.CreationsView = Marionette.CompositeView.extend({
    className: "content",
    template: "#creations-template",
    childView: Views.CreationView,
    childViewContainer: "ul.listing",
    events: {
      "click .add-work": function () {
        this.trigger("creation:add")
      }
    }
  });

  // увлечения

  Views.HobbyView = Marionette.ItemView.extend({
    className: "content",
    template: "#hobby-template",
    behaviors: {
      CKEditor: {}
    },
    events: {
      "click button": function () {
        this.trigger("hobby:save")
      }
    }
  });

  // экзамены

  Views.EgegiaItemView = Marionette.ItemView.extend({
    tagName: "tr",
    template: "#egegia-item-template",
    model: PersonalArea.Portfolio.Models.EgeGia
  });


  Views.EgegiaCollectionView = Marionette.CompositeView.extend({
    template: "#egegia-collection-template",
    tagName: "table",
    childView: Views.EgegiaItemView,
    childViewContainer: "tbody"
  });

  Views.EgegiaView = Marionette.LayoutView.extend({
    className: "content",
    template: "#egegia-layout-template",
    regions: {
      giaRegion: ".gia-region",
      egeRegion: ".ege-region"
    }
  });

  // физ подгтовка

  Views.TrainingItemView = Marionette.ItemView.extend({
    tagName: "tr",
    template: "#training-item-template",
    model: PersonalArea.Portfolio.Models.Training
  });


  Views.TrainingView = Marionette.CompositeView.extend({
    className: "content",
    template: "#training-template",
    childView: Views.TrainingItemView,
    childViewContainer: "tbody"
  });

  // Достижения

  Views.AchievementsLayoutView = Marionette.LayoutView.extend({
    className: "content",
    template: "#achievements-layout-template",
    regions: {
      eventsRegion: ".events-region",
      achievementsRegion: ".achievements-region"
    },
    events: {
      "click .add-achievement": function () {
        this.trigger("achievement:add")
      }
    }
  });

  Views.EventView = Marionette.ItemView.extend({
    template: "#event-item-template",
    tagName: "tr"
  });

  Views.EventsView = Marionette.CompositeView.extend({
    template: "#events-template",
    tagName: "table",
    childView: Views.EventView,
    childViewContainer: "tbody"
  });

  Views.EventsEmptyView = Marionette.ItemView.extend({
    template: "#events-empty-template",
    tagName: "table"
  });

  Views.AchievementView = Marionette.ItemView.extend({
    template: "#achievement-item-template",
    tagName: "tr",
    events: {
      "click .edit-achievement": function () {
        this.trigger("achievement:edit")
      },
      "click .delete-achievement": function () {
        this.trigger("achievement:delete")
      }
    },
    initialize: function() {
      this.model.bind('change', this.render);
    }

  });

  Views.AchievementsView = Marionette.CompositeView.extend({
    template: "#achievements-template",
    tagName: "table",
    childView: Views.AchievementView,
    childViewContainer: "tbody",
    behaviors: {
      EmptyView: {
        el: '<tr><td colspan="3" style="text-align: center;">нет</td></tr>'
      }
    }
  });

  Views.AchievementsEmptyView = Marionette.ItemView.extend({
    template: "#achievements-empty-template",
    tagName: "table"
  });

  Views.AchievementAddView = Marionette.ItemView.extend({
    template: "#achievement-add-template",
    className: "popup w540",
    behaviors: {
      Closable: {},
      LoadFile: {},
      DateInput: {}
    },
    events: {
      "submit form": function (e) {
        e.preventDefault();
        this.trigger("submit")
      }
    }
  });


});
    
        /**
 * Created by tim on 05.08.14.
 */

PersonalArea.module("Portfolio", function (Portfolio, PersonalArea, Backbone, Marionette, $, _) {

    Portfolio.Controller = Marionette.Controller.extend({
        showPortfolio: function () {
            var view = new Portfolio.Views.PortfolioView();



            if(!this.portfolioView || this.portfolioView.isDestroyed){
                this.portfolioView = new Portfolio.Views.PortfolioView({});
            }

            view.on("show-region", function (regionId) {
                var tabRegion = view.getRegion(regionId),
                    viewDeferrerName = "get" + regionId.charAt(0).toUpperCase() + regionId.slice(1) + "View";
                var maskView = new PersonalArea.Core.Views.MaskView({
                    img: "portfolio",
                });

                tabRegion.show(maskView);
                if (tabRegion.currentView) {
                    $.when(
                        _.result(Portfolio.portfolioViewsAPI, viewDeferrerName)
                    ).then(function (tabView) {
                        tabRegion.show(tabView);
                    });
                }
                view.showTab(regionId);
            });

            PersonalArea.mainRegion.show(view);
        }
    });

    Portfolio.portfolioViewsAPI = {

        // вкладка творческие работы
        getWorksView: function () {
            var deferred = $.Deferred();

            var creations = new Portfolio.Models.Creations();
            creations.fetch().done(function () {
                var view = new Portfolio.Views.CreationsView({
                    collection: creations
                });
                var showAddEditView = function (model) {
                    var addView = new Portfolio.Views.CreationAddView({
                        model: model
                    });
                    PersonalArea.popupRegion.show(addView);
                    addView.$el.show();
                    $(".overlay").show();
                    addView.on("close", function () {
                        PersonalArea.popupRegion.empty();
                        $(".overlay").hide();
                    });

                    var disciplineField = new PersonalArea.Core.Views.SelectBox({
                        collection: new Portfolio.Models.ChildDisciplines(),
                        name: "discipline_id",
                        value: model.get("discipline").id,
                        defaultText: model.get("discipline").name,
                        required: true
                    });

                    var masterField = new PersonalArea.Core.Views.SelectBox({
                        collection: new Portfolio.Models.DisciplineTeachers(),
                        name: "master_id",
                        value: model.get("master").id,
                        defaultText: model.get("master").name,
                        disabled: !Boolean(model.get('discipline').id),
                        filterParams: model.get('discipline') ? {
                            'discipline_id': model.get('discipline').id
                        } : {}
                    });

                    addView.disciplineCombobox.show(disciplineField);
                    addView.masterCombobox.show(masterField);

                    disciplineField.on('select:ok', function (disciplineId) {
                        masterField.model.set('disabled', !disciplineId);
                        masterField.model.set('filterParams', {
                            discipline_id: disciplineId
                        })
                    });

                    addView.on("submit", function () {
                        $.when(Backbone.Syphon.serializeAsync(this)).done(function (data) {
                            addView.model.set(data);
                            addView.model.save().done(function () {
                                view.collection.unshift(model);
                                addView.trigger("close");

                            }).fail(function () {
                                //TODO: сейчас поверх попапа всплывает еще один попап, придумать как сделать по другому
                            });
                        });
                    });
                };
                view.on("creation:add", function () {
                    showAddEditView(new Portfolio.Models.Creation());
                });
                view.on("childview:creation:edit", function (creationView) {
                    showAddEditView(creationView.model);
                });
                view.on("childview:creation:delete", function (creationView) {
                    var confirmView = new PersonalArea.Core.Views.ConfirmView({
                        text: "Вы действительно хотите удалить работу?"
                    });
                    confirmView.showModal();
                    confirmView.on('select:ok', function () {
                        creationView.model.destroy({wait: true});
                        confirmView.trigger('close');
                    });
                });
                deferred.resolve(view);
            });
            return deferred.promise()
        },

        getHobbyView: function () {
            var deferred = $.Deferred();

            $.post(
                "/api/PortfolioServices",
                JSON.stringify({GetHobby: {}})
            ).done(function (data) {
                var view = new Portfolio.Views.HobbyView({model: new Backbone.Model({hobby: data})});
                view.on("hobby:save", function () {
                    $.post(
                        "/api/PortfolioServices",
                        JSON.stringify({UpdateHobby: {hobby: view.$("textarea").val()}})
                    ).done(function () {
                        popupShow("Внимание!", "Изменения успешно сохранены!")
                    });
                });
                deferred.resolve(view);
            });

            return deferred
        },

        getExamsView: function () {

            var view = new Portfolio.Views.EgegiaView();
            view.once("show", function () {
                var giaCollection = new Portfolio.Models.GiaCollection();
                var egeCollection = new Portfolio.Models.EgeCollection();
                $.when(egeCollection.fetch(), giaCollection.fetch()).done(
                    function () {
                        if (giaCollection.length > 0) {
                            var giaView = new Portfolio.Views.EgegiaCollectionView({
                                collection: giaCollection
                            });
                            view.giaRegion.show(giaView);
                        } else {
                            view.$(".gia-head").hide()
                        }
                        if (egeCollection.length > 0) {
                            var egeView = new Portfolio.Views.EgegiaCollectionView({
                                collection: egeCollection
                            });
                            view.egeRegion.show(egeView);
                        } else {
                            view.$(".ege-head").hide()
                        }
                    }
                );
            });
            return view
        },

        getTrainingView: function () {
            var deferred = $.Deferred();
            var trainingCollection = new Portfolio.Models.TrainingCollection();
            $.when($.post("/api/PortfolioServices", JSON.stringify({
                    GetMedicalGroup: {}
                }),
                {
                    dataType: "json",
                    contentType: "application/json",
                    processData: false
                }), trainingCollection.fetch()).done(function (groupXhrData) {

                var view = new Portfolio.Views.TrainingView({
                    model: new Backbone.Model(groupXhrData[0]),
                    collection: trainingCollection
                });
                deferred.resolve(view);
            });
            return deferred
        },

        getAchievementsView: function () {
            var view = new Portfolio.Views.AchievementsLayoutView();

            view.once("show", function () {
                var events = new Portfolio.Models.ChildEvents();
                events.fetch().done(function () {
                    var eventsView;
                    if (events.length == 0) {
                        eventsView = new Portfolio.Views.EventsEmptyView();
                    } else {
                        eventsView = new Portfolio.Views.EventsView({
                            collection: events
                        });
                    }
                    view.eventsRegion.show(eventsView);
                });

                var getAddEditView = function (model) {
                    var addEditView = new Portfolio.Views.AchievementAddView({model: model});
                    addEditView.on("show", function () {
                        $(".overlay").show();
                        addEditView.$el.show();
                    });
                    addEditView.on("close", function () {
                        PersonalArea.popupRegion.empty();
                        $(".overlay").hide();
                    });
                    addEditView.on("submit", function () {
                        Backbone.Syphon.serializeAsync(addEditView).done(function (data) {
                            addEditView.model.set(data);
                            addEditView.model.save().done(function () {
                                view.achievementsRegion.currentView.collection.unshift(addEditView.model);
                                addEditView.trigger("close")
                            })
                        });
                    });
                    return addEditView
                };

                var achievements = new Portfolio.Models.Achievements();
                achievements.fetch().done(function () {
                    var achievementView = new Portfolio.Views.AchievementsView({
                        collection: achievements
                    });
                    view.achievementsRegion.show(achievementView);
                    achievementView.on("childview:achievement:delete", function (childView) {
                        var confirmView = new PersonalArea.Core.Views.ConfirmView({
                            text: "Вы действительно хотите удалить запись?"
                        });
                        confirmView.showModal();
                        confirmView.on('select:ok', function () {
                            childView.model.destroy({wait: true});
                            confirmView.trigger('close');
                        });
                    });
                    achievementView.on("childview:achievement:edit", function (childView) {
                        var editView = getAddEditView(childView.model);
                        PersonalArea.popupRegion.show(editView)
                    });
                });

                view.on("achievement:add", function () {
                    var addView = getAddEditView(new Portfolio.Models.Achievement());
                    PersonalArea.popupRegion.show(addView);
                });
            });

            return view
        }

    };


    Portfolio.Router = Marionette.AppRouter.extend({
        appRoutes: {
            portfolio: "showPortfolio"
        }
    });
    var controller = new Portfolio.Controller();
    PersonalArea.addInitializer(function () {
        new Portfolio.Router({
            controller: controller
        });
    });

});

    
        PersonalArea.module("Diary.Models", function(Models, PersonalArea, Backbone, Marionette, $, _){

    Models.ScheduleLesson = Backbone.Model.extend({
        initialize: function (config) {
            this.set("date", new Date(this.get("date")));
            this.set("studyTime", this.get("study_time_name"));
            this.set("timeBegin", this.get("time_begin").slice(0, 5));
            this.set("timeEnd", this.get("time_end").slice(0, 5));
        },
        defaults: {
            "teacher": "",
            "discipline": "",
        }
    });

    Models.ScheduleLessonCollection = Backbone.Collection.extend({
        url: "/api/ScheduleService/GetDiary",
        model: Models.ScheduleLesson
    });

    Models.DaySchedule = Backbone.Model.extend({
        defaults: {
            "lessons": [],
            "is_vacation": false,
            "is_holiday": false,
            "dayOff": "",
        },
        initialize: function (config) {
            this.set("date", new Date(this.get("date")));
            if(this.get("is_vacation")){
                this.set("dayOff", "Каникулы");
            }else if(this.get("is_holiday")){
                this.set("dayOff", "Праздник");
            }else if(this.get("is_weekend")){
                this.set("dayOff", "Выходной");
            }else if(this.get("lessons").length==0){
                this.set("dayOff", "Не задано");
            };
        },
    });

    Models.DayScheduleCollection = Backbone.Collection.extend({
        model: Models.DaySchedule
    });

    Models.WeekSchedule = Backbone.Model.extend({
        urlRoot: "/api/ScheduleService/GetDiary",
    });

    Models.WeekScheduleCollection = Backbone.Collection.extend({
        model: Models.WeekSchedule,
        url: "/api/ScheduleService/GetDiary",
    });

});

    
        PersonalArea.module("Diary.Views", function(Views, PersonalArea, Backbone, Marionette, $, _){

    // комментарий и оценка в строке урока

    Views.MarkCommentView = Marionette.ItemView.extend({
        tagName: "div",
        className: "cursor_pointer popupable",
        template: "#mark-comment-template",
        behaviors: {
            Popupable: {}
        }
    });

    // вью информации об уроке (в всплывающем окне)

    Views.LessonInfoView = PersonalArea.Core.Views.PopupView.extend({
        template: "#lesson-info-template"
    });

    // строка урока

    Views.LessonView = Marionette.LayoutView.extend({
        tagName: "tr",
        className: "lesson-row cursor_pointer popupable",
        template: "#lesson-row-template",
        regions: {
            "mark_comment": "#mark-comment-container"
        },
        behaviors: {
            Popupable: {
                popupView: Views.LessonInfoView
            }
        },
        onShow: function () {
            markCommentView = new Views.MarkCommentView({'model': this.model})
            this.mark_comment.show(markCommentView);
        }
    });

    // блок уроков (день недели)

    Views.WeekdayView = Marionette.CompositeView.extend({
        tagName: "li",
        template: "#weekday-template",
        childViewContainer: "tbody",
        childView: Views.LessonView,
        initialize: function () {
            if(!this.model.get("dayOff")){
                var lessons = this.model.get('lessons')
                // пронумеруем уроки
                _.each(lessons, function(lesson, idx){
                    lesson['idx'] = lesson.index
                })
                this.collection = new PersonalArea.Diary.Models.ScheduleLessonCollection(lessons);
            }
        },
        onRender: function () {
            if (this.model.get('date').isToday()) {
                this.$el.addClass("today open");
            }
        },
        events: {
            "click span.arrow": "toggleOpen",
            "click div.weekday_header": "toggleOpen"
        },
        toggleOpen: function (e) {
            e.stopPropagation();
            this.$el.toggleClass("open");
        },
    });

    // блок дней недели

    Views.WeekView = Marionette.CompositeView.extend({
        template: "#week-template",
        childViewContainer: "ul.dynamic",
        childView: Views.WeekdayView,
        initialize: function (config) {
            this.model = config.model
            this.collection = new PersonalArea.Diary.Models.DayScheduleCollection(
                this.model.get("days"))
        }
    });

    // основная вью дневника

    Views.DiaryView = Marionette.LayoutView.extend({
        tagName: "div",
        className: "diary",
        template: "#diary-main-template",
        regions: {
            weekRegion: "#for-content",
            datepicker_widget: "#for-datepicker"
        },
        events: {
            "click .close_all": "closeAll",
            "click div.today": "toDay"
        },

        onShow: function(){
            this.datepickerWidget = new PersonalArea.Core.Views.DatepickerWidgetView({
                panelStyle: "week",
                pickerConf: {defaultDate: this.selectedDate},
            });
            this.datepickerWidget.on("datepicked", _.bind(function(date){
                this.trigger("datepicked", date);
            }, this));
            this.datepicker_widget.show(this.datepickerWidget);
        },
        closeAll: function () {
            this.$(".content li").removeClass("open");
        },
        toDay: function () {
            var todayEl = this.$(".content li.today");
            if (todayEl.length > 0) {
                // если сегодня попадает на выбранную неделю
                this.closeAll();
                this.$(".content li.today").addClass("open");
            } else {
                // иначе просто рендерим вкладку по новой
                var controller = new PersonalArea.Diary.Controller();
                controller.showDiary();
            }
        }
    });
});

    
        /**
 * Created by tim on 15.07.14.
 */

PersonalArea.module("Diary", function(Diary, PersonalArea, Backbone, Marionette, $, _){

    Diary.Controller = Marionette.Controller.extend({
        showDiary: function(weekDate) {
            weekDate = weekDate || new Date();
            var controller = this;
            var weekSchedule = new PersonalArea.Diary.Models.WeekSchedule();
            var maskView = new PersonalArea.Core.Views.MaskView({
                img: "book",
            });

            if(!this.diaryView || this.diaryView.isDestroyed){
                this.diaryView = new Diary.Views.DiaryView({});

                this.diaryView.on("datepicked", _.bind(function(date){
                    this.showDiary(date);
                }, this));
            }

            PersonalArea.mainRegion.show(this.diaryView);
            PersonalArea.trigger("menu:activate", "diary");

            this.diaryView.weekRegion.show(maskView);
            weekSchedule.fetch({
                data: {
                    date: weekDate.toJSONDateString(),
                    is_diary: true
                },
                type: 'post',
                success: _.bind(function() {
                    var weekView = new Diary.Views.WeekView({model: weekSchedule});
                    if (this.diaryView.weekRegion){
                        this.diaryView.weekRegion.show(weekView)
                    }
                }, this)
            });
        },
    });


    Diary.Router = Marionette.AppRouter.extend({
        appRoutes: {
            "diary": "showDiary"
        }
    });
    var controller = new Diary.Controller();

    PersonalArea.addInitializer(function(){
        new Diary.Router({
            controller: controller
        });
    });
});

    
        /**
 * Created by andrey on 31.07.14.
 */

PersonalArea.module('Homework.Models', function(Models, PersonalArea, Backbone, Marionette, $, _) {
    Models.Homework = Backbone.Model.extend({});
    Models.HomeworksCollection = Backbone.Collection.extend({
        model: Models.Homework,
        url: '/api/HomeworkService/GetHomeworkFromRange'
    });
});
    
        /**
 * Created by andrey on 31.07.14.
 */

PersonalArea.module('Homework.Views', function(Views, PersonalArea, Backbone, Marionette, $, _) {

    Views.HomeworkInfoView =  PersonalArea.Core.Views.PopupView.extend({
        template: '#homework-info-view'
    });

    Views.Homework = Marionette.ItemView.extend({
        tagName: 'tr',
        className: 'cursor_pointer',
        template: '#homework-template',
        events: {
            "click .ind": "onIndClick",
        },
        onIndClick: function (e) {
            e.stopPropagation();
        },
        behaviors: {
            Popupable: {
                popupView: Views.HomeworkInfoView
            }
        }
    });

    Views.Weekday = Marionette.CompositeView.extend({
        tagName: 'li',
        className: 'accordion',
        template: '#homework-weekday-template',
        childView: Views.Homework,
        childViewContainer: 'tbody',
        initialize: function () {
            var homeworks = this.model.get('homeworks');
            this.collection = new Backbone.Collection();

            if (homeworks) {
                this.collection = new Backbone.Collection(homeworks);
                this.collection.each(function(model, index) {
                    model.set('date', new Date(model.get('date')));
                    model.set('index', ++index);
                });
            }
            this.model.set('count', this.collection.length);
            var date = new Date(this.model.get('date'));
            this.model.set('date', date);

            if (date.isToday()) {
                this.$el.addClass('today open');
            }
        }
    });

    Views.Weekdays = Marionette.CompositeView.extend({
        className: 'content',
        template: '#homework-weekdays-template',
        childView: Views.Weekday,
        childViewContainer: 'ul',
        behaviors: {
            Accordion: {}
        }
    });

    Views.Layout = Marionette.LayoutView.extend({
        className: 'right homework',
        template: '#homework-layout-template',
        regions: {
            disciplineFilter: '#discipline-filter',
            datepicker: '#homework-datepicker-widget',
            content: '#content'
        },
        onShow: function () {
            this.datepickerWidget = new PersonalArea.Core.Views.DatepickerWidgetView({
                panelStyle: 'week'
            });
            this.datepickerWidget.on('datepicked', _.bind(function(date) {
                this.trigger('datepicked', date);
            }, this));
            this.datepicker.show(this.datepickerWidget);
        }
    });
});
    
        /**
 * Created by andrey on 14.07.31.
 */

PersonalArea.module('Homework', function(Homework, PersonalArea, Backbone, Marionette, $, _) {
    Homework.Controller = Marionette.Controller.extend({
        showHomework: function (date) {
            var layout = new Homework.Views.Layout();
            var collection = new Homework.Models.HomeworksCollection();
            var defaultText = 'Все';
            PersonalArea.mainRegion.show(layout);
            var maskView = new PersonalArea.Core.Views.MaskView({
                img: "homework",
            });
            layout.content.show(maskView);

            layout.on('datepicked', function(date) {
                collection.fetch({data: {date: date.toJSONDateString()}}).done(function() {
                    var disciplines = {};
                    collection.each(function(model) {
                        _(model.get('homeworks')).each(function(homework) {
                            disciplines[homework.discipline] = homework.discipline;
                        });
                    });

                    var homeworks = new Homework.Views.Weekdays({
                        collection: collection
                    });

                    layout.content.show(homeworks);
                    var combobox = new PersonalArea.Core.Views.ComboboxCustom({
                        data: disciplines,
                        defaultText: defaultText
                    });

                    combobox.on('select', function(e, ui) {
                      PersonalArea.Core.Views.trigger('combobox:change', e, ui);
                    });

                    layout.disciplineFilter.show(combobox);
                });
            });

            collection.fetch({date: date}).done(function() {
                var disciplines = {};
                    collection.each(function(model) {
                        _(model.get('homeworks')).each(function(homework) {
                            disciplines[homework.discipline] = homework.discipline;
                        });
                    });

                var homeworks = new Homework.Views.Weekdays({
                    collection: collection
                });

                layout.content.show(homeworks);
                var combobox = new PersonalArea.Core.Views.ComboboxCustom({
                    data: disciplines,
                    defaultText: defaultText
                });
                combobox.on('select', function(e, ui) {
                  PersonalArea.Core.Views.trigger('combobox:change', e);
                });
                layout.disciplineFilter.show(combobox);
            });

            // Слушаем событие изменения комбобокса для фильтрации по предметам
            PersonalArea.Core.Views.on('combobox:change', function(e) {
                var discipline = e.currentTarget.innerHTML;
                var filteredCollection = new Backbone.Collection(
                    collection.toJSON());

                if (discipline && discipline != defaultText) {
                    // Фильтрация уроков
                    filteredCollection.each(function(weekday) {
                        var homeworks = weekday.get('homeworks');
                        homeworks = _.filter(homeworks, function(homework) {
                            return homework.discipline == discipline;
                        });
                        weekday.set('homeworks', homeworks);
                    });
                }

                var accordion_state = []
                layout.content.$el.find('.accordion').each(function(i, state) {
                    accordion_state.push($(state).hasClass('open'))
                });

                // Показывает домашнии задания
                layout.content.show(new Homework.Views.Weekdays({
                    collection: filteredCollection
                }));

                layout.content.$el.find('.accordion').each(function(i, state) {
                    if (accordion_state[i]) {
                        $(state).addClass('open');
                    }
                });

            });
        }
    });

    Homework.Router = Marionette.AppRouter.extend({
        appRoutes: {
            'homework': 'showHomework'
        }
    });

    Homework.addInitializer(function() {
        new Homework.Router({
            controller: new Homework.Controller
        });
    });
});

    
        PersonalArea.module("Schedule.Models", function(Models, PersonalArea, Backbone, Marionette, $, _){

    Models.ScheduleLesson = Backbone.Model.extend({
        initialize: function (config) {
            this.set("date", new Date(this.get("date")));
            this.set("studyTime", this.get("study_time_name"));
            this.set("timeBegin", this.get("time_begin").slice(0, 5))
            this.set("timeEnd", this.get("time_end").slice(0, 5))
        },
        defaults: {
            "teacher": "",
            "discipline": "",
        }
    });

    Models.ScheduleLessonCollection = Backbone.Collection.extend({
        url: "/api/ScheduleService/GetWeekSchedule",
        model: Models.ScheduleLesson
    });

    Models.DaySchedule = Backbone.Model.extend({
        defaults: {
            "lessons": [],
            "is_vacation": false,
            "is_holiday": false,
            "dayOff": "",
        },
        initialize: function (config) {
            this.set("date", new Date(this.get("date")));
            if(this.get("is_vacation")){
                this.set("dayOff", "Каникулы");
            }else if(this.get("is_holiday")){
                this.set("dayOff", "Праздник");
            }else if(this.get("is_weekend")){
                this.set("dayOff", "Выходной");
            }else if(this.get("lessons").length==0){
                this.set("dayOff", "Не задано");
            };
        },
    });

    Models.DayScheduleCollection = Backbone.Collection.extend({
        model: Models.DaySchedule
    });

    Models.WeekSchedule = Backbone.Model.extend({
        urlRoot: "/api/ScheduleService/GetWeekSchedule",
    });

    Models.WeekScheduleCollection = Backbone.Collection.extend({
        model: Models.WeekSchedule,
        url: "/api/ScheduleService/GetMonthSchedule",
    });

});

    
        PersonalArea.module("Schedule.Views", function(Views, PersonalArea, Backbone, Marionette, $, _){

    // schedule on week views

    Views.LessonView = Marionette.ItemView.extend({
        tagName: "tr",
        template: "#weekschedule-lesson-template",
        templateHelpers: {
            getMinute: function(timestr){
                return timestr.split(":", 2)[1]
            },
            getHours: function(timestr){
                return +timestr.split(":", 1)[0]
            }
        },
    });

    Views.WeekdayView = Marionette.CompositeView.extend({
        tagName: "li",
        className: function(){
            if(this.model.get("date").isToday()){
                return "today open";
            }
        },
        template: "#weekschedule-oneday-template",
        childViewContainer: "tbody",
        childView: Views.LessonView,
        initialize: function (config) {
            if(!this.model.get("dayOff")){
                this.collection = new PersonalArea.Schedule.Models.ScheduleLessonCollection(
                    this.model.get('lessons'));
            };
        },
    });

    Views.WeekView = Marionette.CompositeView.extend({
        id: "week",
        className: "content",
        template: "#weekschedule-template",
        childViewContainer:  "ul.dynamic",
        childView: Views.WeekdayView,
        initialize: function (config) {
            this.model = config.model;
            this.collection = new PersonalArea.Schedule.Models.DayScheduleCollection(
                this.model.get("days"))
        },
        events: {
            "click li div.clearfix": "toggleOpen"
        },
        toggleOpen: function (evt) {
            $(evt.currentTarget).parent("li").toggleClass("open");
        },
    });

    // schedule on month views

    Views.MonthDayView = Marionette.ItemView.extend({
        tagName: 'td',
        className: function(){
            if(this.model.get("date").isToday()){
                return "today";
            }
        },
        getTemplate: function(){
            if(_.isUndefined(this.model.get("index"))){
                return "#monthschedule-oneday-template";
            }else{
                return "#monthschedule-firsttd-template";
            }
        },
        onShow: function (config) {
          if (this.options.date.getMonth() != this.model.get('date').getMonth()) {
            this.$el.addClass('disabled');
          }
        }
    });


    Views.MonthRowView = Marionette.CollectionView.extend({
        tagName: 'tr',
        childView: Views.MonthDayView,
        childViewOptions: function() {
          return {
            'date': this.options.date
          }
        },
        initialize: function (config) {
            this.collection = new PersonalArea.Schedule.Models.DayScheduleCollection(
                this.model.get('days'));
            this.collection.unshift({
                'index': this.model.get('index')
            });
        }
    });


    Views.MonthView = Marionette.CompositeView.extend({
        id: "month",
        className: "content",
        childViewContainer: "tbody",
        template: "#monthschedule-template",
        childView: Views.MonthRowView,
        childViewOptions: function() {
          return {
            'date': this.options.date
          }
        },
        onRender: function () {
        },
        onShow: function(){
            $("#month tbody tr").each(function(i, el){
                var divel = $(el).find("td>div");
                divel.height($(el).height() - 2);
            });
        },
    });

    // schedule main view

    Views.ScheduleView = PersonalArea.Core.Views.TabbedLayoutView.extend({
        tagName: "div",
        className: "schedule tabs",

        template: "#schedule-template",
        regions: {
            dateRegion: ".datepicker-widget",
        },
        tabs: {
            "week": "#week-schedule",
            "month": "#month-schedule",
        },
        tabDates: {},
        events: {
            "click .print": "onPrintBtn",
        },
        onShow: function () {
            this.datepickerWidget = new PersonalArea.Core.Views.DatepickerWidgetView({
                panelStyle: "week"
            });
            this.datepickerWidget.on("datepicked", _.bind(function(date){
                this.trigger("datepicked", date);
            }, this));
            this.dateRegion.show(this.datepickerWidget);
        },
        onSwitchTabBefore: function(tabName){
            this.tabDates[this.currentTab] = this.datepickerWidget.getDate();

            if(this.tabDates[tabName]){
                this.datepickerWidget.setDate(this.tabDates[tabName], true);
            }

            if(tabName == "month"){
                this.datepickerWidget.setPanelStyle("month");
            }
            if(tabName == "week"){
                this.datepickerWidget.setPanelStyle("week");
            }
        },
        onPrintBtn: function(){
            var date = this.datepickerWidget.datepicker.datepicker("getDate");
            var tabName = this.getCurrentTab();
            $.ajax({
                type: "GET",
                url: "/api/ScheduleService/ScheduleReport",
                data: {
                    date: date.toJSONDateString(),
                    interval: tabName,
                },
                success: function(url){
                    PersonalArea.openFile(url);
                },
            });
        }
    });
});

    
        PersonalArea.module("Schedule", function(Schedule, PersonalArea, Backbone, Marionette, $, _){

    Schedule.Controller = Marionette.Controller.extend({

        tabLoader: function(tabName){
            var fun = {
                "week": this.showWeekSchedule,
                "month": this.showMonthSchedule,
            }[tabName] || this.showWeekSchedule;
            return _.bind(fun, this);
        },

        showWeekSchedule: function(date){
            var view = this.getScheduleView();
            var weekSchedule = new PersonalArea.Schedule.Models.WeekSchedule();
            var for_date  = (date || new Date());

            if(!date && view.datepickerWidget){
                view.tabDates.week = for_date;
            }
            maskView = new PersonalArea.Core.Views.MaskView({
                img: "bell",
            });
            view.loadTab("week", maskView);
            weekSchedule.fetch({
                data: {
                    date: for_date.toJSONDateString(),
                },
                processData: true,
                success: function(){
                    var weekView = new Schedule.Views.WeekView({
                        model: weekSchedule
                    });
                    view.loadTab("week", weekView);
                }
            });
        },

        showMonthSchedule: function(date){
            var view = this.getScheduleView();
            var weeks = new PersonalArea.Schedule.Models.WeekScheduleCollection();
            var for_date  = (date || new Date());

            if(!date && view.datepickerWidget){
                view.tabDates.month = for_date;
            }

            weeks.fetch({
                data: {
                    date: for_date.toJSONDateString(),
                },
                processData: true,
                success: function(){
                    var monthView = new Schedule.Views.MonthView({
                        collection: weeks, date: for_date
                    });
                    view.loadTab("month", monthView);
                }
            });
        },

        getScheduleView: function(){
            if(!this.scheduleView || this.scheduleView.isDestroyed){
                this.scheduleView = new Schedule.Views.ScheduleView({});
                this.scheduleView.on("datepicked", _.bind(function(date){
                    var tabName = this.scheduleView.getCurrentTab();
                    this.tabLoader(tabName)(date);
                }, this));
            }
            PersonalArea.mainRegion.show(this.scheduleView);
            return this.scheduleView;
        },

        showTab: function(tabName){
            tabName = tabName || "week";
            var view = this.getScheduleView();
            if(!view.getRegion(tabName + "Tab")){
                this.tabLoader(tabName)();
            }
            view.switchToTab(tabName);
        },
    });

    Schedule.Router = Marionette.AppRouter.extend({
        appRoutes: {
            "schedule": "showTab",
            "schedule/:tabname": "showTab",
        },
    });

    var controller = new Schedule.Controller();

    PersonalArea.scheduleRouter = new Schedule.Router({
        controller: controller
    });

});

    
        PersonalArea.module("Profile.Models", function(Models, PersonalArea, Backbone, Marionette, $, _){

    Models.PersonData = Backbone.Model.extend({
        urlRoot: "/api/ProfileService/GetPersonData",
    })

    Models.Profile = Backbone.Model.extend({
        url: "/api/ProfileService/UpdateProfile",
    })

    Models.MyChild = Backbone.Model.extend({
        selectChild: function(){
            $.ajax({
                type: "POST",
                url: "/api/ProfileService/SetChild",
                data: {selected: this.id},
                success: function(){
                    PersonalArea.Core.personData.fetch();

                    if (PersonalArea.Core.Widget.ClassHours.classHours) {
                        PersonalArea.Core.Widget.ClassHours.classHours.fetch();
                    }
                    if (PersonalArea.Core.Widget.Birthdays.birthdays) {
                        PersonalArea.Core.Widget.Birthdays.birthdays.fetch();
                    }
                    if (PersonalArea.Core.Widget.Events.events) {
                        PersonalArea.Core.Widget.Events.events.fetch();
                    }
                    if (PersonalArea.Core.Widget.Meeting.meetings) {
                        PersonalArea.Core.Widget.Meeting.meetings.fetch();
                    }

                    PersonalArea.need_select = false;
                    PersonalArea.navigate('diary');
                }
            });
        }
    })

    Models.MyChildCollection = Backbone.Collection.extend({
        model: Models.MyChild
    })


});

    
        PersonalArea.module("Profile.Views", function(Views, PersonalArea, Backbone, Marionette, $, _){
    var is_one_point_lessons = true;

    // ребенок
    Views.ChildView = Marionette.ItemView.extend({
        tagName: "td",
        template: "#child-template",
        events: {
            "click a": "onChildSelect",
        },
        onChildSelect: function(e){
            e.stopPropagation();
            this.model.selectChild();
            if (this.model.attributes.point_lessons && is_one_point_lessons) {
                popupShow('Внимание!', this.model.attributes.point_lessons);
                // Выводить сообщение только один раз
                is_one_point_lessons = false;
            }
        },
    });

    // дети
    Views.ChildrenView = Marionette.CollectionView.extend({
        tagName: "tr",
        childView: Views.ChildView,
        childViewContainer: "#child-container",
        initialize: function (config) {
            this.collection = config.collection;
        },
    });

    // редактирование профиля
    Views.ProfileEditView = PersonalArea.Core.Views.PopupView.extend({
        template: "#user-info-edit-template",
        events: {
            "click a#change-pass": "onChangePass",
            "click a#change-email": "onChangeEmail",
            "click a#change-phone": "onChangePhone"
        },
        onChangePass: function(e){
            e.stopPropagation();
            this.model.set({
                'old_pass': this.$el.find('[name=old]')[0].value,
                'new_pass': this.$el.find('[name=new]')[0].value,
                'confirm_pass': this.$el.find('[name=repeat]')[0].value
            });
            this.updateModel();
        },
        onChangeEmail: function(e){
            e.stopPropagation();
            this.model.set({
                'email': this.$el.find('[name=email]')[0].value
            });
            this.updateModel();
        },
        onChangePhone: function(e){
            e.stopPropagation();
            var view = this;
            this.model.set({
                'phone': this.$el.find('[name=phone]')[0].value,
                'phone_sms': this.$el.find('[name=phone_sms]')[0].value
            });
            this.updateModel()
        },
        updateModel: function(){
            var view = this;
            this.model.save(
                {'changes': this.model.changed}
            ).done(function(result) {
                if (result.faultstring) {
                    showError(result.detail, result.faultstring);
                } else {
                    view.trigger('close');
                    // TODO сделать event
                    var profileController = new PersonalArea.Profile.Controller();
                    profileController.showProfile()
                }
            });
        }
    });

    Views.ProfileBtnView = Marionette.ItemView.extend({
        tagName: "a",
        className: "fr btn big1",
        template: "#profile-btn-template",
        behaviors: {
            Popupable: {
                popupView: Views.ProfileEditView
            }
        }

    });

    // профиль пользователя
    Views.UserInfoView = Marionette.LayoutView.extend({
        tagName: "div",
        template: "#user-info-template",
        regions: {
            "profile_btn": "#profile-btn-container"
        },
        events: {
            "click .ava_remove": "onAvaRemove"
        },
        onShow: function(){
            // подписка на событие "Сменить аватар"
            this.$el.find(".ava_change").ajaxUpload({
                url: "/api/ProfileService/UpdateAvatar",
                name: "file",
                onSubmit: function(input) {
                    if (window.File && window.FileReader && window.FileList && window.Blob) {
                        function isImage(headerString) {
                            // проверяем содержится ли hex-дескриптор заголовка файла 
                            // в списке дескрипторов для png, gif, jpeg
                            return ["89504e47", "47494638", "ffd8ffe0", "ffd8ffe1", "ffd8ffe2"]
                                .includes(headerString);
                        }

                        var file = $(input)[0].files[0];
                        var fileReader = new FileReader();
                        fileReader.onloadend = function(e) {
                            var uint = (new Uint8Array(e.target.result)).subarray(0, 4);
                            var header = "";
                            for(var i = 0; i < uint.length; i++) {
                                header += uint[i].toString(16);
                            }

                            if (!isImage(header)) {
                                PersonalArea.showError(
                                    'Неверный формат файла, попробуйте загрузить другой файл.'
                                );
                            }
                        };
                        fileReader.readAsArrayBuffer(file);

                        var filesize = $(input)[0].files[0].size;
                        var maxfilesize = +'10485760';
                        if(filesize > maxfilesize){
                            PersonalArea.showError(
                                'ЗАГРУЖАЕМЫЙ ФАЙЛ БОЛЬШЕ ЗАДАННОГО РАЗМЕРА',
                                'Размер загружаемого файла не должен быть больше чем ' +
                                maxfilesize.toHumanReadableFileSize() +
                                '. Попробуйте загрузить файл нужного размера' +
                                ' или обратитесь к администратору системы.'
                            );
                            return false;
                        }
                    }
                    $('.overlay').show();
                },
                onComplete: function(result) {
                    var resJson = JSON.parse(result);
                    $('.overlay').hide()
                    if (resJson.faultstring){
                        showError(resJson.detail, resJson.faultstring);
                    }
                    else{
                        var profileController = new PersonalArea.Profile.Controller()
                        profileController.showProfile()
                    }
                }
            });
        },
        onAvaRemove: function(e) {
            e.stopPropagation();
            var view = this;
            $.ajax({
                type: "POST",
                url: "/api/ProfileService/RemoveAvatar",
                data: {},
                success: function(res){
                    view.model.set({
                        'user_ava_url': res,
                        'user_has_ava': false
                    });
                    view.render()
                }
            });
        }
    });

    Views.ProfileView = Marionette.LayoutView.extend({
        tagName: "div",
        className: "profile_page",
        template: "#profile-template",
        regions: {
            "user_info": "#user-info-container",
            "children_info": "#children-container",
        },
        onShow: function() {
            this.$el.prepend("");
            this.$el.append("");
        }
    });

});

    
        PersonalArea.module("Profile", function(Profile, PersonalArea, Backbone, Marionette, $, _){

    Profile.Controller = Marionette.Controller.extend({
        showProfile: function() {
        // TODO, подумать как лучше сделать без повторного обращения
            var personData = new PersonalArea.Profile.Models.PersonData();
            personData.fetch({
                data: {},
                processData: true,
            }).done(function () {
                var profileModel = new PersonalArea.Profile.Models.Profile({
                    fullname: personData.get('user_fullname'),
                    user_ava_url: personData.get('user_ava_url'),
                    user_has_ava: personData.get('user_has_ava'),
                    classyear: personData.get('selected_pupil_classyear'),
                    school: personData.get('selected_pupil_school'),
                    email: personData.get('user_email'),
                    phone: personData.get('phone'),
                    phone_sms: personData.get('phone_sms')
                });
                var userInfoView = new PersonalArea.Profile.Views.UserInfoView({
                    model: profileModel
                });
                var myChildCollection = new PersonalArea.Profile.Models.MyChildCollection();
                 _.each(personData.get('children_persons'), function (item) {
                    var myChild = new PersonalArea.Profile.Models.MyChild({
                        id: item['person_id'],
                        fullname: item['fullname'],
                        school: item['school'],
                        classyear: item['classyear'],
                        email: item['email'],
                        ava_url: item['ava_url'],
                        point_lessons: item['point_lessons']
                    });
                    myChild.collection = myChildCollection;
                    myChildCollection.add(myChild);
                });

                var childrenView = new PersonalArea.Profile.Views.ChildrenView({
                    collection: myChildCollection
                });

                var profileView = new Profile.Views.ProfileView();
                var ProfileBtnView = new Profile.Views.ProfileBtnView({
                    model: profileModel
                });
                PersonalArea.mainRegion.show(profileView);
                profileView.user_info.show(userInfoView);
                userInfoView.profile_btn.show(ProfileBtnView);
                profileView.children_info.show(childrenView);

            })
        }
    });

    Profile.Router = Marionette.AppRouter.extend({
        appRoutes: {
            "profile": "showProfile"
        }
    });

    var controller = new Profile.Controller();

    PersonalArea.addInitializer(function(){
        new Profile.Router({
            controller: controller
        });
    });

});

    
        PersonalArea.module("Marks.Models", function(Models, PersonalArea, Backbone, Marionette, $, _){

    Models.DisciplineMark = Backbone.Model.extend({});

    Models.DisciplineMarkCollection = Backbone.Collection.extend({
        model: Models.DisciplineMark
    });

    Models.TotalMarksInfo = Backbone.Model.extend({
        urlRoot: "/api/MarkService/GetTotalMarks"
    });

    Models.SummaryMarksInfo = Backbone.Model.extend({
        urlRoot: "/api/MarkService/GetSummaryMarks"
    });

    Models.VisualizationInfo = Backbone.Model.extend({
        defaults: {
            "disciplines": []
        },
        urlRoot: "/api/MarkService/GetVisualizationData"
    });

});

    
        PersonalArea.module("Marks.Views", function(Views, PersonalArea, Backbone, Marionette, $, _){

    // Вкладка "Сводная"
    Views.SummaryMarksView = Marionette.ItemView.extend({
        id: "summary",
        className: "content",
        template: "#summarymarks-template",
        templateHelpers: {
            fromatedDate: function(datestr){
                var date = new Date(datestr);
                return date.getDateStringZeroed() + "." + date.getMonthStringZeroed()
            },
            markGroup: function(dateMark) {
              // Объединение оценок по датам
              var dateMarks = {};
              _.each(dateMark.marks, function(mark) {
                if (!dateMarks[mark.date]) {
                  dateMarks[mark.date] = [];
                }
                dateMarks[mark.date].push(mark)
              });
              return dateMarks;
            }
        },
        initialize: function(config){
            this.selectedDate = config.date;
            this.model = config.model;
            this.model.set("selectedDate", config.date.toJSONDateString());
        },
        events: {
            "mouseleave td.table_cont": "onTableMouseleave",
            "mouseover .table_cont table tr>td": "onCellMouseover"
        },
        onCellMouseover: function(e){
            //подсветка столбцов
            var eq = $(e.currentTarget).index();
            var $tr = this.$el.find('.table_cont table tr');
            $tr.find('td.hover').removeClass('hover');
            $tr.find('th.hover').removeClass('hover').next().removeClass('next_hover');
            $tr.find('td').eq(eq).addClass('hover');
            $tr.find('th').eq(eq).addClass('hover').next().addClass('next_hover');
            
            // подсветка строк (заметно только в теме rtk)
            var row = $(e.currentTarget).parent().index();
            this.$('.table_first_col tbody tr.hover').removeClass('hover');
            this.$('.avg_score_col tbody tr.hover').removeClass('hover');

            this.$('.table_first_col tbody tr').eq(row).addClass('hover');
            this.$('.avg_score_col tbody tr').eq(row).addClass('hover');
        },
        onTableMouseleave: function(){
            this.$el.find('.hover').removeClass('hover');
            this.$el.find('.next_hover').removeClass('next_hover');
        },
        onShow: function () {
            /* выравнивание высоты ячеек */
            var $el =  this.$el;
            var versIe = PersonalArea.versIe;
            var i=0,f=1;
            $el.find("ul li>table tr td:first-child table td").each(function(index) {
                var leftHeight = $(this).innerHeight(),
                    rightEl = $el.find(".table_cont tbody tr td:first-child").eq(index),
                    avgEl = $el.find(".avg_score_col tbody tr td:first-child").eq(index),
                    lastEl = $el.find("#last tr td:first-child").eq(index);

                if ((versIe == 7 || versIe ==8)&&f==1 ) {i=-1;} // -1px для ie7 только 1 раз
                if (leftHeight >= rightEl.innerHeight()) {
                    rightEl.innerHeight(leftHeight+i);
                    lastEl.innerHeight(leftHeight+i);
                    f=0;i=0;
                } else {
                    $(this).innerHeight(rightEl.innerHeight());
                }

                avgEl.innerHeight($(this).innerHeight());
            });
        },
        behaviors: {
            jScrollPane: {
                afterinit: function(api){
                    // выделяем столбец с выбранной датой если есть
                    var el = $(api.getContentPane()).find(
                        "table tr td.selected").first();
                    el.length && api.scrollToElement(el, true);
                }
            }
        },
    });

    // Вкладка "Итоговые"
    Views.TotalMarksView = Marionette.ItemView.extend({
        id: "total",
        className: "content",
        template: "#totalmarks-template",
        behaviors: {
            jScrollPane: {}
        }
    });

    // Графики вкладки "Визуализация"
    Views.ChartsView = Marionette.ItemView.extend({
        template: "#visualmarks-chartspanel-template",
        attendanceChartLeft: null,
        attendanceChartRight: null,
        averageChart: null,
        progressChart: null,
        onShow: function(){
            var data = this.model.attributes;
            switch (this.model.get('chart_type')){
                case "attendance":
                    this.render_attendance_left(data);
                    this.render_attendance_right(data);
                    break;
                case "average":
                    this.render_average_chart(data);
                    break;
                case "progress":
                    this.render_progress_chart(data);
                    break;
            }
        },
        render_attendance_left: function(data) {
            Highcharts.theme = {
                 colors: ['#3366CC', '#FF0000']
            };
            Highcharts.setOptions(Highcharts.theme);
            attendanceChartLeft = new Highcharts.Chart({
                chart: {
                    renderTo: "chart-subpanel1",
                    defaultSeriesType: 'pie',
                    borderWidth: null,
                    plotBackgroundColor: null,
                    plotBorderWidth: null,
                    plotShadow: false
                },
                title: {
                    text: 'Посещаемость'
                },
                tooltip: {
                    formatter: function() {
                        return '<b>'+ this.point.name +'</b>: '+ this.percentage.toFixed(0) +' %';
                    }
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                           enabled: true,
                           color: '#000000',
                           connectorColor: '#000000',
                           formatter: function() {
                                return '<b>'+ this.point.name +'</b>: '+ this.percentage.toFixed(0) +' %';
                           }
                        },
                        showInLegend: true
                    }
                },
                credits: {
                    enabled: false
                },

                series: [{
                     type: 'pie',
                     name: 'Посещаемость',
                     data: [
                             ['Из них присутствовал',   data.present],
                             ['Из них отсутствовал', data.absent]
                     ]
                }]

            });
            return attendanceChartLeft;
        },

        render_attendance_right: function(data) {
            Highcharts.theme = {
                 colors: ['#33CC33', '#FFCC00']
              };
            Highcharts.setOptions(Highcharts.theme);
            this.attendanceChartRight = new Highcharts.Chart({
                chart: {
                    renderTo: "chart-subpanel2",
                    defaultSeriesType: 'column',
                    borderWidth: null,
                    plotBackgroundColor: null,
                    plotBorderWidth: null,
                    plotShadow: false
                },

                xAxis: {
                    categories: [
                       'Отсутствовал(а)'
                     ]
                },

                yAxis: {
                    min: 0,
                    title: {
                    text: 'Количество занятий'
                  }
                },

                title: {
                    text: 'Количество пропущенных занятий'
                },
                tooltip: {
                    formatter: function() {
                       return ''+
                          this.x +'<br>'+'<b>'+this.series.name+': '+'</b>'+this.y;
                    }
                },

                plotOptions: {
                    column: {
                       pointPadding: 0.2,
                       borderWidth: 0,
                       dataLabels: {
                           enabled: true,
                           color: '#000000',
                           connectorColor: '#000000',
                           formatter: function() {
                                return '<b>'+ this.series.name +'</b>: '+this.y;
                           }
                        }
                    }
                },
                credits: {
                            enabled: false
                        },

                series: [{
                     name: 'По уважительной причине',
                     data: [data.absent_good]
                     },{
                     name: 'Без уважительной причины',
                     data: [data.absent_bad]
                     }]
            });
        },

        render_average_chart: function(data) {
            this.averageChart = new Highcharts.Chart({
                chart: {
                    renderTo: "chart-panel",
                    defaultSeriesType: 'bar',
                    borderWidth: null
                },
                title: {
                    text: 'Средний балл по предметам'
                },
                xAxis: {
                    categories: data.categories,
                    title: {
                        text: null
                    }
                },
                yAxis: {
                    min: 0,
                    title: {
                        text: 'балл',
                        align: 'high'
                    }
                },
                tooltip: {
                    formatter: function() {
                        return ''+
                             this.series.name +': '+ this.y;
                    }
                },
                plotOptions: {
                    bar: {
                        dataLabels: {
                            enabled: true
                        }
                    }
                },
                legend: {
                    layout: 'horizontal',
                    align: 'center',
                    verticalAlign: 'bottom',
                    x: 0,
                    y: 10,
                    floating: false,
                    borderWidth: 1,
                    backgroundColor: '#FFFFFF',
                    shadow: true
                },
                credits: {
                    enabled: false
                },
                series: data.series
            });
        },
        render_progress_chart: function(data){
            this.progressChart = new Highcharts.Chart({
                chart: {
                    renderTo: "chart-panel",
                    defaultSeriesType: 'line',
                    marginRight: 130,
                    marginBottom: 25,
                    borderWidth: null
                },
                title: {
                    text: 'Успеваемость',
                    x: -20 //center
                },
                subtitle: {
                    text: data.subject,
                    x: -20
                },
                xAxis: {
                    title: {
                        text: null
                    }
                },
                yAxis: {
                    title: {
                        text: 'Средний балл'
                    }
                },
                tooltip: {
                    formatter: function() {
                        return 'На '+ data.dates[this.x] +'</br> Средний балл: '+ this.y.toFixed(2);
                    }
                },
                legend: {
                    layout: 'vertical',
                    align: 'right',
                    verticalAlign: 'top',
                    x: 0,
                    y: 10,
                    floating: false,
                    borderWidth: 1,
                    backgroundColor: '#FFFFFF',
                    shadow: true
                },
                credits: {
                    enabled: false
                },
                series: data.series
            });
        },

    });

    // Вкладка "Визуализация"
    Views.VisualMarksView = Marionette.LayoutView.extend({
        id: "visual",
        className: "content",
        template: "#visualmarks-template",
        regions: {
            dateFromRegion: ".datepicker-widget.date-from",
            dateToRegion: ".datepicker-widget.date-to",
            chartsPanelRegion: ".charts-container",
        },
        events: {
            "change .params .select.chart-type select": "changeCartType",
            "change .params .select.chart-discipline select": "renderChart",
        },
        onShow: function () {
            var begin = new Date(this.model.get("period_begin")),
                end = new Date(this.model.get("period_end"));

            pickerConf= {
                minDate: begin,
                maxDate: end,
            };

            this.datepickerWidgetFrom = new PersonalArea.Core.Views.DatepickerWidgetView({
                pickerConf: _.extend(pickerConf,{
                    defaultDate: begin
                }),
                panelStyle: "day"
            });
            this.datepickerWidgetTo = new PersonalArea.Core.Views.DatepickerWidgetView({
                pickerConf: _.extend(pickerConf,{
                    defaultDate: end
                }),
                panelStyle: "day"
            });

            this.datepickerWidgetFrom.on("datepicked", _.bind(function(date){
                this.datepickerWidgetTo.datepicker.datepicker(
                    "option", "minDate", date);
                this.renderChart();
            }, this));

            this.datepickerWidgetTo.on("datepicked", _.bind(function(date){
                this.datepickerWidgetFrom.datepicker.datepicker(
                    "option", "maxDate", date);
                this.renderChart();
            }, this));

            this.dateFromRegion.show(this.datepickerWidgetFrom);
            this.dateToRegion.show(this.datepickerWidgetTo);
            this.renderChart();
        },
        changeCartType: function(){
            var discipline = this.$el.find(
                ".params .select.chart-discipline select").val("0");
            this.renderChart();
        },
        renderChart: function(){
            var value = this.$el.find(
                    ".params .select.chart-type select").val(),
                discipline = this.$el.find(
                    ".params .select.chart-discipline select").val(),
                dateBegin = this.datepickerWidgetFrom.getDate(),
                dateEnd = this.datepickerWidgetTo.getDate();

            var data = {
                'date_begin': dateBegin.toJSONDateString(),
                'date_end': dateEnd.toJSONDateString(),
                'subject': discipline,
            };
            data[this.model.get('student_id_param_name')] = this.model.get("pupil_id");

            var chartModel = new Backbone.Model();

            chartModel.fetch({
                type: 'POST',
                url: this.model.get('charts_urls')[value],
                data: data,
                success: _.bind(function(model, attributes){
                    model.set("chart_type", value)
                    var chartView = new Views.ChartsView({
                        model: model
                    });

                    this.chartsPanelRegion.show(chartView);
                }, this),
            });
        },

    });

    // View пункта меню "Оценки"
    Views.MarksView = PersonalArea.Core.Views.TabbedLayoutView.extend({
        tagName: "div",
        className: "right tabs grades",

        template: "#marks-template",
        regions: {
            dateRegion: ".datepicker-widget"
        },
        tabs: {
            "summary": "#summary-marks",
            "total": "#total-marks",
            "visual": "#visual-marks",
        },
        onShow: function () {
            this.datepickerWidget = new PersonalArea.Core.Views.DatepickerWidgetView({
                panelStyle: "none"
            })
            this.datepickerWidget.on("datepicked", _.bind(function(date){
                this.trigger("datepicked", date);
            }, this));
            this.dateRegion.show(this.datepickerWidget);
        },
        onSwitchTabBefore: function(tabName){
            if(tabName == "summary"){
                this.dateRegion.$el.show();
            }else{
                this.dateRegion.$el.hide();
            }
        }
    });
});

    
        PersonalArea.module("Marks", function(Marks, PersonalArea, Backbone, Marionette, $, _){

    Marks.Controller = Marionette.Controller.extend({

        tabLoader: function(tabName){
            var fun = {
                "summary": this.showSummaryMarks,
                "total": this.showTotalMarks,
                "visual": this.showVisualMarks,
            }[tabName] || this.showSummaryMarks;
            return _.bind(fun, this);
        },

        showSummaryMarks: function(date){
            var view = this.getMarksView();
            var summaryMarksInfo = new PersonalArea.Marks.Models.SummaryMarksInfo();
            var maskView = new PersonalArea.Core.Views.MaskView({
                img: "check",
            });
            view.loadTab("summary", maskView);

            date = date || new Date();
            var weekdayRange = date.getWeekdayRange(),
                dateFrom = weekdayRange[0],
                dateTo = weekdayRange[1];

            summaryMarksInfo.fetch({
                data: {
                    date: date.toJSONDateString(),
                },
                processData: true,
                success: function(){
                    var summaryMarksView = new Marks.Views.SummaryMarksView({
                        model: summaryMarksInfo,
                        date: date,
                    });
                    view.loadTab("summary", summaryMarksView);
                }
            });
        },

        showTotalMarks: function(date){
            var view = this.getMarksView();
            var totalMarksInfo = new PersonalArea.Marks.Models.TotalMarksInfo();
            var maskView = new PersonalArea.Core.Views.MaskView({
                img: "check",
            });
            view.loadTab("total", maskView);

            date = date || new Date();
            var weekdayRange = date.getWeekdayRange(),
                dateFrom = weekdayRange[0],
                dateTo = weekdayRange[1];

            totalMarksInfo.fetch({
                data: {
                    dateFrom: dateFrom.toJSONDateString(),
                    dateTo: dateTo.toJSONDateString(),
                    childPersonId: 123456,
                },
                processData: true,
                success: function(){
                    var totalMarksView = new Marks.Views.TotalMarksView({
                        model: totalMarksInfo
                    });
                    view.loadTab("total", totalMarksView);
                }
            });
        },        

        showVisualMarks: function(){
            var view = this.getMarksView();

            var infoModel = new PersonalArea.Marks.Models.VisualizationInfo();
            var maskView = new PersonalArea.Core.Views.MaskView({
                img: "check",
            });
            view.loadTab("visual", maskView);

            infoModel.fetch({
                success: function(model){
                    var visualMarksView = new Marks.Views.VisualMarksView({
                        model: model
                    });
                    view.loadTab("visual", visualMarksView);
                }
            });
        },

        getMarksView: function(){
            if(!this.marksView || this.marksView.isDestroyed){
                this.marksView = new Marks.Views.MarksView({});
                this.marksView.on("datepicked", _.bind(function(date){
                    var tabName = this.marksView.getCurrentTab();
                    this.tabLoader(tabName)(date);
                }, this));
            }
            PersonalArea.mainRegion.show(this.marksView);
            return this.marksView;
        },

        showTab: function(tabName){
            tabName = tabName || "summary";
            var view = this.getMarksView();
            if(!view.getRegion(tabName + "Tab")){
                this.tabLoader(tabName)();
            }
            view.switchToTab(tabName);
        },
    });

    Marks.Router = Marionette.AppRouter.extend({
        appRoutes: {
            "marks": "showTab",
            "marks/:tabname": "showTab",
        },
    });

    var controller = new Marks.Controller();

    PersonalArea.marksRouter = new Marks.Router({
        controller: controller
    });

});

    
        /**
 * Created by andrey on 22.07.14.
 */

PersonalArea.module('School.Models', function(Models, PersonalArea, Backbone, Marionette, $, _) {

    Models.Employee = Backbone.Model.extend({});
    Models.Pupil = Backbone.Model.extend({});


    Models.School = Backbone.Model.extend({
        defaults: {
            email: '',
            phone: '',
            photo: '',
            address: '',
            site_url: '',
            count_pupils: 0,
            count_employees: 0

        },
        url: "/api/SchoolService/getSchoolInfo"
    });

    // Модель класса
    Models.ClassYear = Backbone.Model.extend({
        url: "/api/SchoolService/getClassYearInfo"
    });

    // Коллекция учеников
    Models.PupilsCollection = Backbone.Collection.extend({
        model: Models.Pupil,
        url: "/api/SchoolService/getClassYearPupils"
    });

    // Коллекция сотрудников
    Models.EmployeesCollection = Backbone.Collection.extend({
        model: Models.Employee
    });
});
    
        /**
 * Created by andrey on 22.07.14.
 */

PersonalArea.module('School.Views', function(Views, PersonalArea, Backbone, Marionette, $, _) {
    Views.SchoolView = PersonalArea.Core.Views.TabbedLayoutView.extend({
        className: 'right tabs school',
        template: '#school-tab',
        tabs: {
            common: '#school-school',
            classyear: '#school-class'
        }
    });

    // Пустышка, что бы добить грид не хватающими ячейками
    Views.EmptyCell = Marionette.ItemView.extend({
        tagName: 'td',
        template: '#empty-cell'
    });

    // ячейка с учеником
    Views.PupilCell = Marionette.ItemView.extend({
        tagName: 'td',
        template: '#pupil-cell'
    });

    // Ряд с учениками
    Views.PupilRow = Marionette.CollectionView.extend({
        tagName: 'tr',
        getChildView: function(model) {
            // Если пришла пустая модель значит ученики кончились
            // и нужно дополнить ряд пустыми ячейками
            if (model.get('empty')) {
                return Views.EmptyCell;
            }
            return Views.PupilCell;
        },
        initialize: function() {
            // Создаем коллекцию из своей модели
            this.collection = new Backbone.Collection(
                _.values(this.model.attributes));
        }
    });

    Views.ClassYear = Marionette.CompositeView.extend({
        id: 'class',
        className: 'content',
        template: '#classyear',
        childView: Views.PupilRow,
        childViewContainer: 'tbody',
        initialize: function() {
            // Получаем учеников класса
            var pupils = this.model.get('pupils');
            if (pupils) {
                // Кол-во элементов для группировки
                var groupByCounts = 3;

                // Группируем учеников по количеству
                var grid = _.groupBy(pupils, function(element, index) {
                    return Math.floor(index / groupByCounts);
                });

                // Если рядов больше 1
                if (_.keys(grid).length > 1) {
                    // Выбираем последний ряд
                    var last = _.last(_.values(grid));

                    // Добиваем ряд пустыми ячейками, если учеников не хватает
                    _.each(_.range(groupByCounts - last.length), function () {
                        this.push({empty: true});
                    }, last);
                }

                this.collection = new Backbone.Collection(_.toArray(grid));
                this.model.unset('pupils');
            }
        }
    });

    // Ячейка с сотрудником
    Views.EmployeeCell = Marionette.ItemView.extend({
        tagName: 'td',
        template: '#employee-cell'
    });

    // Строка с пед составом
    Views.EmployeesRow = Marionette.CollectionView.extend({
        tagName: 'tr',
        getChildView: function(model) {
            if (model.get('empty')) {
                return Views.EmptyCell;
            }
            return Views.EmployeeCell;
        },
        initialize: function() {
            // Создаем коллекцию из своей модели
            this.collection = new Backbone.Collection(
                _.values(this.model.attributes));
        }
    });

    // Под состав, разбитый по группам
    Views.Employees = Marionette.CompositeView.extend({
        tagName: 'li',
        className: 'accordion',
        template: '#employees-group',
        childView: Views.EmployeesRow,
        childViewContainer: 'tbody',
        initialize: function() {
            // Кол-во группируемых сотрудников
            var groupByCounts = 2;

            // Группируем учеников по количеству
            var grid = _.groupBy(_.values(this.model.attributes), function(element, index) {
                return Math.floor(index / groupByCounts);
            });

            // Если рядов больше 1
            if (_.keys(grid).length > 1) {
                // Выбираем последний ряд
                var last = _.last(_.values(grid));

                // Добиваем ряд пустыми ячейками, если учеников не хватает
                _.each(_.range(groupByCounts - last.length), function () {
                    this.push({empty: true});
                }, last);
            }

            this.collection = new Backbone.Collection(_.toArray(grid));
        },
        templateHelpers: {
            group: function() {
                // Возвращает название группы
                return this[0].group;
            }
        }
    });

    // Школы
    Views.School = Marionette.CompositeView.extend({
        id: 'school',
        className: 'content',
        template: '#school-template',
        childView: Views.Employees,
        childViewContainer: '.dynamic',
        behaviors: {
            Accordion: {}
        },
        initialize: function() {
            var employees = this.model.get('employees');
            if (employees) {
                employees = _(employees).groupBy('group');
                var priority = {
                    'Администрация': 1,
                    'Педагогический состав': 2,
                    'Обслуживающий персонал': 3
                };

                employees = _(employees).sortBy(function(obj, key) {
                  return this[key];
                }, priority);

                _.each(employees, function(group_employees, idx) {
                  employees[idx] = _.uniq(group_employees, function(employee) {
                    return employee.fullname;
                  });
                });

                this.collection = new PersonalArea.School.Models.EmployeesCollection(
                    _.values(employees));
                this.model.unset('employees');
            }
        }
    });

});
    
        /**
 * Created by andrey on 22.07.14.
 */

PersonalArea.module('School', function(School, PersonalArea, Backbone, Marionette, $, _) {
    School.Controller = Marionette.Controller.extend({

        tabLoader: function(tabName){
            var fun = {
                "common": this.showSchool,
                "classyear": this.showClassYear,
            }[tabName] || this.showSchool;
            return _.bind(fun, this);
        },

        getSchoolView: function(){
            if(!this.schoolView || this.schoolView.isDestroyed){
                this.schoolView = new School.Views.SchoolView({});
            }
            PersonalArea.mainRegion.show(this.schoolView);
            return this.schoolView;
        },

        showTab: function(tabName) {
            tabName = tabName || "common";
            var view = this.getSchoolView();
            if(!view.getRegion(tabName + "Tab")){
                this.tabLoader(tabName)();
            }
            view.switchToTab(tabName);
        },

        showSchool: function () {
            var view = this.getSchoolView();
            var schoolModel  = new PersonalArea.School.Models.School();
            var maskView = new PersonalArea.Core.Views.MaskView({
                img: "school",
            });
            view.loadTab("common", maskView);
            schoolModel.fetch({
                success: function (model) {
                    var schoolView = new School.Views.School({
                        model: model
                    });
                    view.loadTab("common", schoolView);
                }
            });
        },
        showClassYear: function () {
            var layoutView = new this.getSchoolView();
            var model      = new PersonalArea.School.Models.ClassYear();
            var maskView = new PersonalArea.Core.Views.MaskView({
                img: "school",
            });
            layoutView.loadTab("classyear", maskView);
            model.fetch({
                success: function () {
                    var view = new School.Views.ClassYear({model: model});
                    layoutView.loadTab('classyear', view);
                }
            });
        }
    });

    School.Router = Marionette.AppRouter.extend({
        appRoutes: {
            'school': 'showTab',
            'school/:tabName': 'showTab'
        }
    });

    var controller = new School.Controller();

    PersonalArea.schoolRouter = new School.Router({
        controller: controller
    })

});
    
        
PersonalArea.module("Portfolio.Models", function (Models, PersonalArea, Backbone, Marionette, $, _) {

  Models.GveCollection = Models.EgegiaCollection.extend({
    url: "/api/ContingentPortfolioServices",
    apiMethods: {
      read: "GetGveResults"
    }
  });

  Models.ChildEvent = Backbone.Model.extend({
    defaults: function () {
      return {
        date: '',
        event_name: '',
        event_type: '',
        level_name: '',
        result_name: '',
        rank: '',
        document_url: ''
      }
    }
  });

  Models.ChildEvents = Backbone.Collection.extend({
    model: Models.ChildEvent,
    url: "/api/ContingentPortfolioServices",
    apiMethods: {
      read: "GetChildEvents"
    }
  });

});

    
        PersonalArea.module("Portfolio.Views", function (Views, PersonalArea, Backbone, Marionette, $, _) {

  Views.EgegiaView = Marionette.LayoutView.extend({
    className: "content",
    template: "#gveegegia-layout-template",
    regions: {
      giaRegion: ".gia-region",
      egeRegion: ".ege-region",
      gveRegion: ".gve-region"
    }
  });

  Views.EventView = Marionette.ItemView.extend({
    template: "#contingent-event-item-template",
    tagName: "tr"
  });

  Views.EventsView = Marionette.CompositeView.extend({
    template: "#contingent-events-template",
    tagName: "table",
    childView: Views.EventView,
    childViewContainer: "tbody"
  });

  Views.EventsEmptyView = Marionette.ItemView.extend({
    template: "#contingent-events-empty-template",
    tagName: "table"
  });

});

    
        
PersonalArea.module("Portfolio", function (Portfolio, PersonalArea, Backbone, Marionette, $, _) {

  Portfolio.portfolioViewsAPI.getExamsView = function () {

      var view = new Portfolio.Views.EgegiaView();
      view.once("show", function () {
        var giaCollection = new Portfolio.Models.GiaCollection();
        var egeCollection = new Portfolio.Models.EgeCollection();
        var gveCollection = new Portfolio.Models.GveCollection();
        $.when(egeCollection.fetch(), giaCollection.fetch(), gveCollection.fetch()).done(
          function () {
            if (gveCollection.length > 0) {
              var gveView = new Portfolio.Views.EgegiaCollectionView({
                collection: gveCollection
              });
              view.gveRegion.show(gveView);
            } else {
              view.$(".gve-head").hide()
            }
            if (giaCollection.length > 0) {
              var giaView = new Portfolio.Views.EgegiaCollectionView({
                collection: giaCollection
              });
              view.giaRegion.show(giaView);
            } else {
              view.$(".gia-head").hide()
            }
            if (egeCollection.length > 0) {
              var egeView = new Portfolio.Views.EgegiaCollectionView({
                collection: egeCollection
              });
              view.egeRegion.show(egeView);
            } else {
              view.$(".ege-head").hide()
            }
          }
        );
      });
      return view
    }

});

    
        PersonalArea.module("SchoolMeals.Models", function(Models, PersonalArea, Backbone, Marionette, $, _){

    Models.FrameData = Backbone.Model.extend({
        url: "/api/SchoolMealsService/getFrameUrl"
    })
})

    
        PersonalArea.module('SchoolMeals', function(SchoolMeals, PersonalArea, Backbone, Marionette, $, _) {
    SchoolMeals.Controller = Marionette.Controller.extend({
        showSchoolMeals: function () {
            var model = new SchoolMeals.Models.FrameData();
            $.when(model.fetch()).then(function(){
                PersonalArea.mainRegion.show(
                    new SchoolMeals.Views.SchoolMeals({model: model})
                );
            })
        }
    });

    SchoolMeals.Router = Marionette.AppRouter.extend({
        appRoutes: {
            'school-meals': 'showSchoolMeals',
        }
    });

    PersonalArea.addInitializer(function() {
        new SchoolMeals.Router({
            controller: new SchoolMeals.Controller
        })
    });
});
    
        PersonalArea.module('SchoolMeals.Views', function(Views, PersonalArea, Backbone, Marionette, $, _) {

    Views.SchoolMeals = Marionette.ItemView.extend({
        template: "#school-meals-view",
        className: 'content',
    });
});
    
        PersonalArea.module('Feedback.Models', function(Models, PersonalArea, Backbone, Marionette, $, _) {
    // Обращение
    Models.Message = Backbone.Model.extend({
        defaults: {date: '', update_date: '', title: '', rubric: '', text: ''}
    });

    // Обращения
    Models.MessagesCollection = Backbone.Collection.extend({
        model: Models.Message,
        url: "/api/FeedbackService/getMessages"
    });

    Models.MessagesList = Backbone.Model.extend({
        url: "/api/FeedbackService/getMessages"
    });

    // Новое обращение
    Models.NewMessage = Backbone.Model.extend({
        url: "/api/FeedbackService/newMessage"
    });

    // Рубрики
    Models.Rubrics = Backbone.Model.extend({
        url: "/api/FeedbackService/getRubrics"
    });

    // Контактные данные (телефон и email)
    Models.UpdateContacts = Backbone.Model.extend({
        url: "/api/FeedbackService/updateContacts"
    });

    // Счетчик непрочитанных обращений
    Models.UnreadCount = Backbone.Model.extend({
        url: "/api/FeedbackService/getUnreadCount",
        initialize: function() {
            this.on('sync', function (model, value) {
                PersonalArea.Core.Widget.Menu.trigger(
                'change:feedbacks', value)
            });
        }
    });
});

    
        PersonalArea.module('Feedback', function (Feedback, PersonalArea, Backbone, Marionette, $, _) {

  Feedback.on('start', function () {
    var model = new this.Models.UnreadCount();
    model.fetch();
  });
  Feedback.Controller = Marionette.Controller.extend({

    showMessages: function (page, searchText, monthDate) {
      page = page || 1;
      Feedback.date = monthDate = monthDate || Feedback.date || new Date();
      var model = new Feedback.Models.MessagesList({
        currentPage: page,
        searchText: searchText,
        date: monthDate
      });
      var params = {
        method: 'POST',
        data: {
          page: page,
          search_text: searchText,
          date: monthDate.toJSONDateString()
        }
      };
      var maskView = new PersonalArea.Core.Views.MaskView({
        img: "book",
      });
      this.getFeedbackView(page, searchText).weekRegion.show(maskView);
      model.fetch(params).done(_.bind(function(data) {
        var collection = new Feedback.Models.MessagesCollection(data.items);
        var view = new Feedback.Views.Messages({
          collection: collection,
          model: model
        });
        this.getFeedbackView(page, searchText).weekRegion.show(view)
      }, this));
    },
    getFeedbackView: function(page, searchText){
        if(!this.feedbackView || this.feedbackView.isDestroyed){
            this.feedbackView = new Feedback.Views.FeedbackView({});
            this.feedbackView.on("datepicked", _.bind(function(date){
                this.showMessages(page, searchText, date);
            }, this));
        }
        PersonalArea.mainRegion.show(this.feedbackView);
        PersonalArea.trigger("menu:activate", "feedback");
        return this.feedbackView;
    }
  });

  Feedback.Router = Marionette.AppRouter.extend({
    appRoutes: {
      'feedback(/:page)(/:searchText)': 'showMessages'
    }
  });

  PersonalArea.addInitializer(function() {
    new Feedback.Router({
      controller: new Feedback.Controller
    })
  });
});
    
        PersonalArea.module('Feedback.Views', function (Views, PersonalArea, Backbone, Marionette, $, _) {
  Views.Message = Marionette.ItemView.extend({
    tagName: 'tr',
    template: '#feedback-message',
    ui: {
      'fullMessage': '.full-message',
    },
    events: {
      'click @ui.fullMessage': 'fullMessage',
      'click': 'toggleSelect'
    },
    initialize: function(config) {
      this.model.view = this;
      this.on('show', _.bind(function () {
        if (this.model.get('is_unread')) {
          this.$el.addClass('feedback-new');
        }
      }, this));
      this.$el.css('cursor', 'pointer');
      this.model.on('change:selected', _.bind(function() {
        this.onRender();
      }, this));
    },
    onRender: function () {
      if (this.model.get('selected')) {
        this.$el.css('background', '#f1f1f1')
      } else {
        this.$el.css('background', '#fff')
      }
    },
    toggleSelect: function () {
      var currentSelected = !this.model.get('selected');
      var selected = this.model.collection.where({'selected': true});
      _.each(selected, function (item) {
        item.set('selected', false);
      });
      this.model.set('selected', currentSelected);
    },
    fullMessage: function (e) {
      e.preventDefault();
      // Пометим как прочитанное
      if (this.model.get('is_unread')) {
        $.when(this.model.fetch({
          method: 'POST',
          url: "/api/FeedbackService/markRead",
          data: {feedback_id: this.model.get('id')}
        })).then(_.bind(function () {
          this.model.set('is_unread', false);
          this.$el.removeClass('feedback-new');
          // Декремент счетчика непрочитанных обращений
          var unreadCount = parseInt($('.menu .feedback .hint').text());
          PersonalArea.Core.Widget.Menu.trigger(
            'change:feedbacks', (unreadCount - 1)
          )}, this));
      };
      var view = new PersonalArea.Feedback.Views.FullMessage({model: this.model});
      view.showModal();
    },
  });


  // Основная вьюха
  Views.FeedbackView = Marionette.LayoutView.extend({
    tagName: "div",
    className: "feedback",
    template: "#feedback-main-template",
    regions: {
        weekRegion: "#for-content",
        datepicker_widget: "#for-datepicker"
    },
    onShow: function(){
        this.datepickerWidget = new PersonalArea.Core.Views.DatepickerWidgetView({
            panelStyle: "month",
            pickerConf: {defaultDate: this.selectedDate},
        });
        this.datepickerWidget.on("datepicked", _.bind(function(date){
            this.trigger("datepicked", date);
        }, this));
        this.datepicker_widget.show(this.datepickerWidget);
    },
  });


  // Обращения
  Views.Messages = Marionette.CompositeView.extend({
    itemsPerPage: 25,
    pagingPrefix: '#feedback/',
    childView: Views.Message,
    className: 'right tabs access',
    template: '#feedback-messages',
    childViewContainer: 'tbody',
    behaviors: {
      EmptyView: {
        el: '<tr><td colspan="4" style="text-align: center;">нет</td></tr>'
      }
    },
    events: {
      'click .refresh': 'refresh',
      'keypress @ui.search': 'search',
      'click @ui.more': 'more',
      'click @ui.newMessage': 'newMessage',
      'click @ui.showMessage': 'showMessage'
    },
    ui: {
      'search': '.feedback-search',
      'more': '.load-more',
      'newMessage': '.new-message',
      'showMessage': '.showMessage'
    },
    initialize: function(config) {
      _.bindAll(this, 'clearSelected');
      $(document).on('keyup', this.clearSelected);
    },
    clearSelected: function (e) {
      if (e.keyCode == 27) {
        // escape
        this.collection.each(function(item) {
          item.set('selected', false);
        });
      }
    },
    search: function(e) {
      const ENTER = 13;
      if (e.keyCode == ENTER) {
        var searchText = this.ui.search.val();
        var route = PersonalArea.getCurrentRoute().split('/').splice(0,1);
        if (!searchText) {
          Backbone.history.navigate(route.join('/'), {trigger: true});
          return;
        }
        route.push('1'); route.push(searchText);
        Backbone.history.navigate(route.join('/'), {trigger: true})
      }
    },
    showMessage: function (e) {
      e.preventDefault();
      var selected = this.collection.findWhere({selected: true});
      if (!selected) {
        showError('Внимание', 'Элемент не выбран');
        return;
      }
      selected.view.fullMessage(e);
    },
    refresh: function (e) {
      e.preventDefault();
      this.loadData();
    },
    loadData: function(searchFocus, add) {
      var searchText = this.ui.search.val();
      this.model.fetch({
        method: 'POST', data: {
          search_text: searchText,
          page: this.model.get('currentPage'),
          date: this.model.get('date').toJSONDateString()
        }
      }).done(_.bind(function(data) {
        this.collection = new PersonalArea.Feedback.Models.MessagesCollection(data.items);
        this.render();
        this.onShow();
      }, this));
    },
    newMessage: function (e) {
        e.preventDefault();
        var model = new PersonalArea.Feedback.Models.NewMessage();
        var view = new PersonalArea.Feedback.Views.NewMessage({model: model});
        view.showModal();
    },
    onShow: function () {
      var total = this.model.get('total');
      var searchText = this.model.get('searchText');
      if (searchText) {
        this.ui.search.focus();
        this.ui.search.val(searchText);
      }
      if (total > this.itemsPerPage) {
        $('.paging2').pagination({
          items: this.model.get('total'),
          itemsOnPage: this.itemsPerPage,
          hrefTextPrefix: this.pagingPrefix,
          hrefTextSuffix:  searchText ? '/' + searchText : '',
          displayedPages: 3,
          currentPage: this.model.get('currentPage') || 1
        })
      }
    },
    templateHelpers: function() {
      return {
        getPagingInfo: _.bind(function() {
          var currentPage = (this.model.get('currentPage') || 1) - 1,
              total = this.model.get('total'),
              from = (currentPage * this.itemsPerPage) + 1 || 1,
              to = from + this.itemsPerPage - 1;
          if (to > total) { to = total; }
          return from + '-' + to +  ' из ' + total;
        }, this)
      }
    }
  });


  // Окно нового обращения
  Views.NewMessage = Marionette.ItemView.extend({
    template: '#feedback-new-message',
    behaviors: {
      Modal: {alignment: false},
      Closable: {el: '.close-popup'},
      LoadFile: {},
    },
    ui: {
      'send': '#send-message-btn',
      'cancel': '#cancel-btn',
      'rubricCombobox': '#rubric-combobox',
      'alertMsg': '#alert-msg',
      'childCombobox': '#child-combobox'
    },
    events: {
      'submit-form': 'sendMessageWithCheck',
      'click @ui.send': 'sendMessageWithCheck',
    },
    initialize: function () {
      this.on('show', _.bind(function () {
        this.loadRubrics();
        this.loadChilds();
      }, this));
      this.REDMINE_RUBRIC_ID = 2;
    },
    loadRubrics: function () {
      var model = new PersonalArea.Feedback.Models.Rubrics();
      var rubricCombobox = this.ui.rubricCombobox;
      var me = this;
      rubricCombobox.on('change', _.bind(this.showAlertMsg, this));
      model.fetch().done(_.bind(function(data) {
        rubricCombobox.html('');
        _.each(data.items, function (item) {
          rubricCombobox.append($('<option/>', {
            value: item.id,
            text: item.title
          }, this));
        });
        me.showAlertMsg();
      }));
    },
    loadChilds: function () {
      var model = new PersonalArea.Profile.Models.PersonData();
      var childCombobox = this.ui.childCombobox;
      model.fetch().done(_.bind(function(data) {
        childCombobox.html('');
        childCombobox.append($('<option/>', {
          value: 0,
          text: 'Не выбран'
        }, this));
        _.each(data.children_persons, function (item) {
          childCombobox.append($('<option/>', {
            value: item.person_id,
            text: item.fullname
          }, this));
        });
        if (data.selected_pupil_id) {
            childCombobox.val(data.selected_pupil_id);
        }
      }));
    },
    showAlertMsg: function(e) {
      if (this.ui.rubricCombobox.val() == this.REDMINE_RUBRIC_ID) {
        this.ui.alertMsg.show();
      } else {
        this.ui.alertMsg.hide();
      }
    },
    sendMessage: function () {
      Backbone.Syphon.serializeAsync(this).done(_.bind(function (data) {
        $.when(this.model.fetch({
          url: "/api/FeedbackService/newMessage",
          method: 'POST',
          data: data
        })).then(_.bind(function (result) {
          this.trigger('close');
          Backbone.history.loadUrl();
          popupShow('Внимание!', 'Вашему обращению присвоен номер ' +
                    result + '.<br>');
        }, this));

      }, this));
    },
    sendMessageWithCheck: function(e) {
      e.preventDefault();
      var me = this;
      Backbone.Syphon.serializeAsync(this).done(_.bind(function (data) {
        if (!data.title) {
          showError('Внимание!', 'Поле «Тема» не может быть пустым!');
          return false;
        }
        if (!data.text) {
          showError('Внимание!', 'Поле «Вопрос» не может быть пустым!');
          return false;
        }
        if (!data.rubric) {
          showError('Внимание!', 'Поле «Рубрика» не может быть пустым!');
          return false;
        }
        if (data.child == '0') {
          showError('Внимание!', 'Необходимо выбрать ученика!');
          return false;
        }

        me.ui.send.attr("disabled", "true");
        me.ui.send.addClass("disabled");
        me.ui.send.html("Отправляется...");

        me.ui.cancel.hide();

        var model = new PersonalArea.Profile.Models.PersonData();
        model.fetch().done(_.bind(function(data) {
          if (!data.phone && !data.user_email) {
            me.updateContacts();
          }  else {
            me.sendMessage();
          }
        }, me));
      }));
    },
    updateContacts: function () {
      var model = new PersonalArea.Feedback.Models.UpdateContacts();
      var view = new PersonalArea.Feedback.Views.UpdateContacts({
        model: model,
        parentView: this,
      });
      view.showModal();
    }
  });


  // Форма ввода контактных данных
  Views.UpdateContacts = Marionette.ItemView.extend({
    template: '#feedback-update-contacts',
    behaviors: {
      Modal: {alignment: false},
      Closable: {el: '.close-popup'},
      LoadFile: {},
    },
    ui: {
      'send': '#send-contacts',
      'form': 'form:first'
    },
    events: {
      'submit-form': 'sendContacts',
      'click @ui.send': 'sendContacts',
    },
    initialize: function (options) {
      this.on('contacts-updated', _.bind(function () {
        options.parentView.sendMessage();
      }, this));
      this.once("show", function () {
        $('#phone').inputmask("+7(\\999)99-99-999");

      });
    },
    sendContacts: function (e) {
      e.preventDefault();
      Backbone.Syphon.serializeAsync(this).done(_.bind(function (data) {
        if (!data.phone && !data.email) {
          showError('Внимание!', 'Необходимо заполнить хотя бы одно из полей!');
          return false;
        };
        if (!this.ui.form[0].checkValidity()) {
          showError('Внимание!', 'Проверьте корректность заполнения полей!');
          return false;
        }
        $.when(this.model.fetch({
          url: "/api/FeedbackService/updateContacts",
          method: 'POST',
          data: data
        })).then(_.bind(function (result) {
          this.trigger('contacts-updated');
          this.trigger('close');
        }, this));
      }, this));
    },
  });


  // Окно обращения
  Views.FullMessage = Marionette.ItemView.extend({
    template: '#feedback-full-message',
    behaviors: {
      Modal: {alignment: false},
      Closable: {el: '.close-popup'}
    },
    ui: {
      'toRevision': '#to-revision-btn',
      'closeMessage': '#close-message-btn',
      'closeWindow': '#close-window-btn',
      'comment': '.comment-field'
    },
    events: {
      'click @ui.toRevision': 'toRevision',
      'click @ui.closeMessage': 'closeMessage'
    },
    initialize: function(options) {
      this.parent = options.parent;
    },
    toRevision: function (e) {
      var comment = this.ui.comment.val();
      if (!comment) {
        showError('Внимание!', 'Поле «Комментарий» не может быть пустым!');
        return false;
      }

      this.ui.toRevision.attr("disabled", "true");
      this.ui.toRevision.addClass("disabled");
      this.ui.toRevision.html("Выполняется...");

      this.ui.closeMessage.hide();
      this.ui.closeWindow.hide();

      $.when(this.model.fetch({
        url: "/api/FeedbackService/toRevision",
        method: 'POST',
        data: {
            feedback_id: this.model.get('id'),
            comment: comment
        }
      })).then(_.bind(function () {
        this.trigger('close');
        Backbone.history.loadUrl();
      }, this));
    },
    closeMessage: function (e) {
      var comment = this.ui.comment.val();

      this.ui.closeMessage.attr("disabled", "true");
      this.ui.closeMessage.addClass("disabled");
      this.ui.closeMessage.html("Выполняется...");

      this.ui.toRevision.hide();
      this.ui.closeWindow.hide();

      $.when(this.model.fetch({
        url: "/api/FeedbackService/closeMessage",
        method: 'POST',
        data: {
          feedback_id: this.model.get('id'),
          comment: comment
        }
      })).then(_.bind(function () {
        this.trigger('close');
        Backbone.history.loadUrl();
      }, this));
    }
  });
});

    
        PersonalArea.module('MailBox.Models', function(Models, PersonalArea, Backbone, Marionette, $, _) {

    Models.InBoxCounter = Backbone.Model.extend({
        url: "/api/MailBoxService/getInBoxCount"
    });

    // Сообщение
    Models.Message = Backbone.Model.extend({
        defaults: {avatar: '', receiver_avatar: ''}
    });
    // Сообщения
    Models.Messages = Backbone.Collection.extend({
        model: Models.Message
    });
    // Входящие сообщения
    Models.InBox = Backbone.Model.extend({
        url: "/api/MailBoxService/getInBoxMessages",
        initialize: function () {
            this.on('sync', function (model) {
                PersonalArea.Core.Widget.Menu.trigger(
                    'change:mailbox', model.get('new_count'))
            });
        }
    });
    // Исходящие сообщения
    Models.OutBox = Backbone.Model.extend({
        url: "/api/MailBoxService/getOutBoxMessages"
    });
    // Новое сообщение
    Models.NewMessage = Backbone.Model.extend({
        url: "/api/MailBoxService/newMailBoxMessage",
        defaults: {
            subject: '', receivers: new Backbone.Collection(), text: ''
        }
    });

    // Получатель
    Models.Receiver = Backbone.Model.extend({});

    // Получатели ученики
    Models.PupilReceivers = Models.Receiver.extend({
        url: "/api/MailBoxService/getPupilUserProfiles"
    });

    // Получатели сотрудники
    Models.EmployeeReceivers = Models.Receiver.extend({
        url: "/api/MailBoxService/getEmployeeUserProfiles"
    });

    // Получатели родители
    Models.ParentReceivers = Models.Receiver.extend({
        url: "/api/MailBoxService/getParentUserProfiles"
    });

    // Получатели администраторы
    Models.AdminReceivers = Models.Receiver.extend({
        url: "/api/MailBoxService/getAdminUserProfiles"
    });

});

    
        CKEDITOR.env.isCompatible = true;

PersonalArea.module('MailBox.Views', function (Views, PersonalArea, Backbone, Marionette, $, _) {
  // Сообщение
  Views.Message = Marionette.ItemView.extend({
    tagName: 'li',
    className: 'clearfix',
    template: '#mailbox-message',
    ui: {
      'checkbox': '.check',
      'subject': '.subject',
      'reply': '#reply',
      'replyAll': '#reply_all'
    },
    events: {
      'click @ui.checkbox': 'check',
      'click @ui.subject': 'showMessage',
      'click @ui.reply': 'reply',
      'click @ui.replyAll': 'replyAll'
    },
    showMessage: function (e) {
      e.preventDefault();
      var view = new this.fullMessageView({
        model: this.model, parent: this
      });
      view.showModal();
    },
    check: function() {
      var checked = this.model.get('checked');
      this.ui.checkbox.addClass('active');
      this.model.set('checked', true);
      if (checked) {
        this.ui.checkbox.removeClass('active');
        this.model.set('checked', false);
      }
    },
    onShow: function () {
      if (this.model.get('is_new')) {
        this.$el.addClass('new');
      }
    }
  });

  // Сообщения
  Views.Messages = Marionette.CompositeView.extend({
    itemsPerPage: 10,
    childView: Views.Message,
    childViewContainer: '#mailbox-listing',
    ui: {
      'checkbox': '.check_all',
      'childCheckbox': '.check',
      'removeChecked': '#remove_checked'
    },
    events: {
      'click @ui.checkbox': 'check_all',
      'click @ui.childCheckbox': 'checkChild',
      'click @ui.removeChecked': 'removeChecked'
    },
    check_all: function () {
      var all_checked = _.all(this.collection.pluck('checked'));
      _.each(this.children._views, function (child) {
        if (!all_checked) {
          child.ui.checkbox.addClass('active');
          child.model.set('checked', true);
        } else {
          child.ui.checkbox.removeClass('active');
          child.model.set('checked', false);
        }
      });
    },
    checkChild: function () {
      if (_.all(this.collection.pluck('checked'))) {
        this.ui.checkbox.addClass('active');
      } else {
        this.ui.checkbox.removeClass('active');
      }
    },
    removeChecked: function (e) {
      e.preventDefault();
      var removeUrl = this.removeUrl;
      var checkedModels = this.collection.where({'checked': true});
      var confirmView =  new PersonalArea.Core.Views.ConfirmView({
        text: "<b>Внимание!</b> Данная операция приведет к необратимым " +
              "результатам. Вы действительно хотите удалить " +
              checkedModels.length + " сообщений?"
      });

      if (checkedModels.length) {
        confirmView.showModal();
        confirmView.on('select:ok', function(){
          $.when(this.model.fetch({
            url: removeUrl,
            method: 'POST',
            data: {'messages': _.pluck(checkedModels, 'id').join(',')}
          })).then(function () {
            Backbone.history.loadUrl();
          });
          confirmView.trigger('close');
        });
      } else {
        showError('Внимание!', 'Не выбран ни один из элементов.')
      }
    },
    initialize: function () {
      this.collection = new PersonalArea.MailBox.Models.Messages(
        this.model.get('items'));
    },
    onShow: function () {
      var count = this.model.get('count');
      var searchText = this.model.get('search_text');
      if (count > this.itemsPerPage) {
        $('.paging2').pagination({
          items: this.model.get('count'),
          itemsOnPage: this.itemsPerPage,
          hrefTextPrefix: this.pagingPrefix,
          hrefTextSuffix:  searchText ? '/' + searchText : '',
          displayedPages: 3,
          currentPage: this.model.get('current_page') || 1
        })
      }
    },
    templateHelpers: function() {
      return {
        getPagingInfo: _.bind(function() {
          var currentPage = (this.model.get('current_page') || 1) - 1,
              count = this.model.get('count'),
              from = (currentPage * this.itemsPerPage) + 1 || 1,
              to = from + this.itemsPerPage - 1;

          if (to > count) { to = count; }
          return from + '-' + to +  ' из ' + count;
        }, this)
      }
    }
  });

  // Окно нового сообщения
  Views.NewMessage = Marionette.ItemView.extend({
    template: '#mailbox-new-message',
    behaviors: {
      Modal: {alignment: false},
      Closable: {el: '.close-popup'},
      LoadFile: {},
      jScrollPane: {
         container: '#scrollable-container'
      },
      CKEditor: {}
    },
    ui: {
      'send': '#send-message',
      'form': '#my_form',
      'getPupilReceivers': '#get-pupil-receivers',
      'getEmployeeReceivers': '#get-employee-receivers',
      'getParentReceivers': '#get-parent-receivers',
      'getAdminReceivers': '#get-admin-receivers',
      'receivers_names': '#receivers_names ul',
      'receivers_ids': '#receivers_ids'
    },
    events: {
      'submit-form': 'sendMessage',
      'click @ui.send': 'sendMessage',
      'click @ui.getPupilReceivers': 'getPupilReceivers',
      'click @ui.getEmployeeReceivers': 'getEmployeeReceivers',
      'click @ui.getParentReceivers': 'getParentReceivers',
      'click @ui.getAdminReceivers': 'getAdminReceivers'
    },
    initialize: function () {
      this.model.on('change', _.bind(function () {
        var receivers = this.model.get('receivers');
        var receiver_ids = receivers.pluck('profile_id');

        var receiver_names = this.model.get('receivers').pluck('fullname');

        this.ui.receivers_names.html('<li>' + receiver_names.join(', ') + '</li>');
        this.ui.receivers_ids.val(receiver_ids.join(','));
        this.trigger('scroll:reinitialize');
      }, this))
    },
    sendMessage: function (e) {
      e.preventDefault();
      Backbone.Syphon.serializeAsync(this).done(_.bind(function (data) {
        if (!this.checkMandatoryField(data.subject)) {
          showError('Внимание!', 'Поле «Тема» не может быть пустым!');
          return false;
        }
        if (!this.checkMandatoryField(data.receivers_ids)) {
          showError('Внимание!', 'Поле «Кому» не может быть пустым!');
          return false;
        }

        if (!this.checkMandatoryField(data.message)) {
          showError('Внимание!', 'Поле «Текст» не может быть пустым!');
          return false;
        }

        $.when(this.model.fetch({
          url: "/api/MailBoxService/newMailBoxMessage",
          method: 'POST',
          data: data
        })).then(_.bind(function () {
          this.trigger('close');
          Backbone.history.loadUrl();
        }, this));

      }, this));
    },
    getReceivers: function (template, childViewTemplate, model) {
      $.when(model.fetch({
          method: 'POST',
          data: {'initial': 'true'}
      })).then(_.bind(function () {
        var view = new Views.Receivers({
          childViewTemplate: childViewTemplate,
          template: template,
          model: model,
          receivers: this.model.get('receivers'),
          receiversModel: this.model,
        });
        view.showModal();

        view.on('select:ok', _.bind(function (receivers, unselected) {
          receivers = _.values(receivers);
          var selected = this.model.get('receivers');
          selected.remove(_.values(unselected));
          if (selected) {
            receivers = [].concat(receivers, selected.models);
          }

          var collection = new Backbone.Collection(
            receivers, {comparator: 'fullname'}
          );

          this.model.trigger('change');
          this.model.set('receivers', collection);
          view.trigger('close');
        }, this));
      }, this))
    },
    getPupilReceivers: function (e) {
      e.preventDefault();
      var model = new PersonalArea.MailBox.Models.PupilReceivers();

      this.getReceivers(
        '#new-message-pupil-receivers',
        '#new-message-pupil-receiver',
        model
      );
    },
    getEmployeeReceivers: function (e) {
      e.preventDefault();
      var model = new PersonalArea.MailBox.Models.EmployeeReceivers();
      this.getReceivers(
        '#new-message-employee-receivers',
        '#new-message-employee-receiver',
        model
      );
    },
    getParentReceivers: function (e) {
      e.preventDefault();
      var model = new PersonalArea.MailBox.Models.ParentReceivers();

      this.getReceivers(
        '#new-message-parent-receivers',
        '#new-message-parent-receiver',
        model
      );
    },
    getAdminReceivers: function (e) {
      e.preventDefault();
      var model = new PersonalArea.MailBox.Models.AdminReceivers();
      this.getReceivers(
        '#new-message-admin-receivers',
        '#new-message-admin-receiver',
        model
      );
    },
    checkMandatoryField: function (v) {
      return !!('' + v).trim();
    }
  });

  // Получатель
  Views.Receiver = Marionette.ItemView.extend({
    tagName: 'tr',
    template: '#new-message-pupil-receiver',
    ui: {
      'checkbox': '.check',
      'subject': '.subject'
    },
    events: {
      'click @ui.checkbox': 'check'
    },
    initialize: function (options) {
      this.template = options.template;
    },
    check: function() {
      var checked = this.model.get('checked');
      this.ui.checkbox.addClass('active');
      this.model.set('checked', true);
      delete this.model.collection.unselected[this.model.id];

      if (checked) {
        this.model.collection.unselected[this.model.id] = this.model;
        this.ui.checkbox.removeClass('active');
        this.model.set('checked', false);
      }
    },
    onShow: function () {
      this.model.on('change:checked', _.bind(function (model) {
        if (model.get('checked')) {
          this.$el.find('.check').addClass('active');
        } else {
          this.$el.find('.check').removeClass('active');
        }
      }, this));
      if (this.model.get('checked')) {
        this.$el.find('.check').addClass('active');
      } else {
          this.$el.find('.check').removeClass('active');
      }
    }
  });

  // Окно выбора получателей
  Views.Receivers = Marionette.CompositeView.extend({
    itemsPerPage: 25,
    childView: Views.Receiver,
    childViewContainer: 'tbody',
    template: '#new-message-pupil-receivers',
    behaviors: {
      MyModal: {alignment: false},
      Closable: {el: '.close-popup'},
      jScrollPane: {
        container: '.user_list_body'
      }
    },
    ui: {
      'checkbox': '.check_all',
      'childCheckbox': '.check',
      'searchForm': '.receivers-search-form',
      'searchText': '.search-text',
      'select': '.select-receivers',
      'filterFields': '.column-filter-field'
    },
    events: {
      'click @ui.checkbox': 'check_all',
      'click @ui.childCheckbox': 'checkChild',
      'submit @ui.searchForm': 'search',
      'click @ui.select': 'select',
      'keyup @ui.filterFields': 'filter'
    },
    initialize: function (options) {
      // При инициализации отфильтруем данные по классу ученика
      this.model.set('filter_data', {
        'study_level': this.model.get('study_level'),
        'letter': this.model.get('letter')
      });
      this.template = options.template;
      this.childViewOptions = {
        template: options.childViewTemplate
      };

      var items = this.model.get('items');
      this.collection = new Backbone.Collection(items);
      this.collection.selected = {};
      this.collection.unselected = {};

      if (options.receivers) {
        options.receivers.each(_.bind(function (item) {
          this.collection.selected[item.id] = item;
          var itemCollection = this.collection.findWhere({id: item.id});
          if (itemCollection) {
            itemCollection.set('checked', true);
          }
        }, this));
      }
      // При изменении коллекции сохраним список выбранных записей
      this.collection.on('change', _.bind(function() {
        // Сохраняем список выбранных записей
        _.each(this.collection.where({'checked': true}), _.bind(function (item) {
          this.collection.selected[item.id] = item;
        }, this));

        // Удаляем тех что не выбранны
        _.each(this.collection.where({'checked': false}), _.bind(function (item) {
          delete this.collection.selected[item.id];
        }, this));
      }, this))
    },
    onShow: function () {
      // При первом вызове окна заносим данные о классе ученика в поля фильтра
      var study_level = this.model.get('study_level'),
          letter = this.model.get('letter');
      _.each(this.ui.filterFields, function (item) {
          if (item.name === 'study_level' && study_level){
              item.value = study_level;
          }
          if (item.name === 'letter' && letter){
              item.value = letter;
          }
      });
      // Постраничная навигация
      this.$el.find('.paging2').pagination({
        items: this.model.get('count'),
        itemsOnPage: this.itemsPerPage,
        displayedPages: 3,
        currentPage: 1,
        onPageClick: _.bind(function (page, e) {
          if (e) {e.preventDefault();}
          if (this.model.get('pass_load')) {
            this.model.set('pass_load', false);
            return;
          }

          var data = this.model.get('filter_data') || {};
          data['search_text'] = this.model.get('search_text');
          data['page'] = page;

          $.when(this.model.fetch({
            method: 'POST',
            data: data
          })).then(_.bind(function () {
            this.collection.reset();
            this.collection.add(this.model.get('items'));
            this.collection.each(_.bind(function (item) {
              if (item.id in this.collection.selected) {
                item.set('checked', true);
              }
            }, this));
            this.trigger('scroll:reinitialize');
            this.checkChild();
          }, this))
        }, this)
      });

      if (
        this.collection.where({checked: true}).length ==
        this.collection.length
      ) {
        this.ui.checkbox.addClass('active');
      }
    },
    select: function (e) {
      e.preventDefault();
      this.trigger('select:ok', this.collection.selected, this.collection.unselected);
    },
    search: function (e) {
      e.preventDefault();
      // Поиск
      var searchText = this.ui.searchText.val();
      var data = this.model.get('filter_data') || {};
      data['search_text'] = searchText;
      this.model.set('search_text', searchText);
      $.when(this.model.fetch({
        method: 'POST',
        data: data
      })).then(_.bind(function () {
        this.collection.reset();
        this.collection.add(this.model.get('items'));

        this.model.set('pass_load', true);
        this.trigger('scroll:reinitialize');
        this.$el.find('.paging2').pagination(
          'updateItems', this.model.get('count'));
        this.$el.find('.paging2').pagination('selectPage', 1);
      }, this));
    },
    check_all: function () {
      var all_checked = _.all(this.collection.pluck('checked'));
      var unselected = this.collection.unselected;

      _.each(this.children._views, function (child) {
        if (!all_checked) {
          child.ui.checkbox.addClass('active');
          child.model.set('checked', true);
          delete unselected[child.model.id];
        } else {
          child.ui.checkbox.removeClass('active');
          child.model.set('checked', false);
          unselected[child.model.id] = child.model;
        }
      });
    },
    checkChild: function () {
      if (_.all(this.collection.pluck('checked'))) {
        this.ui.checkbox.addClass('active');
      } else {
        this.ui.checkbox.removeClass('active');
      }
    },
    filter: function (e) {

      var data = {};
      _.each(this.ui.filterFields, function (item) {
         data[item.name] = item.value;
      });

      this.model.set('filter_data', data);
      data['search_text'] = this.model.get('search_text');

      if (e.keyCode == 13) {
        $.when(this.model.fetch({
          method: 'POST',
          data: data
        })).then(_.bind(function () {
          this.collection.reset();
          this.collection.add(this.model.get('items'));
          this.model.set('pass_load', true);

          this.trigger('scroll:reinitialize');
          this.$el.find('.paging2').pagination(
            'updateItems', this.model.get('count'));
          this.$el.find('.paging2').pagination('selectPage', 1);
        }, this));
      }
    }
  });

  Views.OutBoxFullMessage = Marionette.ItemView.extend({
    template: '#outbox-full-message',
    behaviors: {
      Modal: {alignment: false},
      Closable: {el: '.close-popup'},
      jScrollPane: {
        container: '.receivers_list'
      }
    },
    ui: {
      'remove': '.remove_btn'
    },
    events: {
      'click @ui.remove': 'removeMessage'
    },
    removeMessage: function (e) {
      var model = this.model;
      var id = this.model.get('id');
      var confirmView =  new PersonalArea.Core.Views.ConfirmView({
        text: "<b>Внимание!</b> Данная операция приведет к необратимым " +
              "результатам. Вы действительно хотите удалить это сообщение?"
      });

      confirmView.showModal();
      confirmView.on('select:ok', function(){
        $.when(model.fetch({
          url: "/api/MailBoxService/removeOutBoxMessages",
          method: 'POST',
          data: {'messages': id}
        })).then(function () {
          Backbone.history.loadUrl();
        });
        confirmView.trigger('close');
      });
    },
    onShow: function () {
      if (this.model.get('receivers').length >= 3) {
        this.trigger('scroll:reinitialize');
      } else {
        this.$el.find('.receivers_list').removeClass('receivers_list').css('height', 16);
      }
    }
  });

  // Окно входящего сообщения
  Views.InBoxFullMessage = Marionette.ItemView.extend({
    template: '#inbox-full-message',
    behaviors: {
      Modal: {alignment: false},
      Closable: {el: '.close-popup'},
      jScrollPane: {
        container: '.receivers_list'
      }
    },
    ui: {
      'remove': '.remove_btn',
      'reply': '#reply',
      'replyAll': '#reply_all'
    },
    events: {
      'click @ui.remove': 'removeMessage',
      'click @ui.reply': 'reply',
      'click @ui.replyAll': 'replyAll'
    },
    initialize: function(options) {
      this.parent = options.parent;
      // Пометим сообщение как прочитанное
      if (this.model.get('is_new')) {
        $.when(this.model.fetch({
          method: 'POST',
          url: "/api/MailBoxService/markRead",
          data: {message_id: this.model.get('id')}
        })).then(function () {
          Backbone.history.loadUrl();
        });
      }
    },
    reply: function (e) {
      this.parent.reply(e);
    },
    replyAll: function (e) {
      this.parent.replyAll(e);
    },
    removeMessage: function (e) {
      var model = this.model;
      var id = this.model.get('id');
      var confirmView =  new PersonalArea.Core.Views.ConfirmView({
        text: "<b>Внимание!</b> Данная операция приведет к необратимым " +
              "результатам. Вы действительно хотите удалить это сообщение?"
      });

      confirmView.showModal();
      confirmView.on('select:ok', function(){
        $.when(model.fetch({
          url: "/api/MailBoxService/removeInBoxMessages",
          method: 'POST',
          data: {'messages': id}
        })).then(function () {
          Backbone.history.loadUrl();
        });
        confirmView.trigger('close');
      });
    },
    onShow: function () {
      if (this.model.get('receivers').length >= 3) {
        this.trigger('scroll:reinitialize');
      } else {
        this.$el.find('.receivers_list').removeClass('receivers_list').css('height', 16);
      }
    }
  });

  // Вью входящего сообщения
  Views.InBoxMessage = Views.Message.extend({
    template: '#inbox-message',
    fullMessageView: Views.InBoxFullMessage,
    reply: function (e) {
      e.preventDefault();
      this.replyMessage(new Backbone.Collection([{
        id: this.model.get('sender_id'),
        fullname: this.model.get('sender_fullname')
      }]))
    },
    replyAll: function (e) {
      e.preventDefault();
      var profile_id = PersonalArea.Core.personData.get('auth_user_profile_id');
      var receivers = _.filter(this.model.get('receivers'), function(receiver) {
        return receiver.id != profile_id
      });

      receivers.push({
        id: this.model.get('sender_id'),
        fullname: this.model.get('sender_fullname')
      });
      this.replyMessage(new Backbone.Collection(receivers));
    },
    replyMessage: function (receivers) {
      var model = new PersonalArea.MailBox.Models.NewMessage({
        receivers: receivers,
        subject: 'Ответ: ' + this.model.get('subject').replace('Ответ: ', ''),
        text: [
            'Исходное сообщение —',
            'От: ' + this.model.get('sender_fullname'),
            'Отправлено: ' + this.model.get('date'),
            'Кому: ' + _.pluck(this.model.get('receivers'), 'fullname').join(', '),
            'Тема: ' + this.model.get('subject'), '', '',
            this.model.get('text')
        ].join('\n')
      });
      var view = new PersonalArea.MailBox.Views.NewMessage({model: model});
      view.showModal();
    }
  });

  // Вью входящих сообщений
  Views.InBoxMessages = Views.Messages.extend({
    pagingPrefix: '#mailbox/inbox/',
    removeUrl: "/api/MailBoxService/removeInBoxMessages",
    template: '#inbox-messages',
    childView: Views.InBoxMessage
  });

  // Вью исходящего сообщения
  Views.OutBoxMessage = Views.Message.extend({
    template: '#outbox-message',
    fullMessageView: Views.OutBoxFullMessage
  });

  // Вью исходящих сообщений
  Views.OutBoxMessages = Views.Messages.extend({
    pagingPrefix: '#mailbox/outbox/',
    removeUrl: "/api/MailBoxService/removeOutBoxMessages",
    template: '#outbox-messages',
    childView: Views.OutBoxMessage
  });


  Views.Tab = Marionette.ItemView.extend({
    tagName: 'li',
    getTemplate: function() {
      if (this.model.has('url')) {
        return '#mailbox-tab-template-default'
      }

      // Для случая если это не таб, а какая то информация например
      // Кол-во диалогов
      this.$el.addClass('hint');
      return '#mailbox-tab-template-hint'
    },
    onShow: function () {
      if (this.model.has('active')) {
        this.$el.find('a').addClass('active');
      }

      // Имя ключа в моделе счетчика
      if (this.model.has('fieldName')) {
        var fieldName = this.model.get('fieldName');
        var value = PersonalArea.Social.Core.Counter.get(fieldName);
        this.model.set('count', value)
      }
    },
    initialize: function () {
      if (this.model.has('countEvent')) {
        var event = this.model.get('countEvent');
        // Событие для прослушки изменения счётчика
        PersonalArea.Social.Messages.on(event, function(value) {
          this.model.set('count', value);
        }, this);
      }
    }
  });

  Views.Tabs = Marionette.CollectionView.extend({
    tagName: 'ul',
    className: 'int_tabs clearfix',
    childView: Views.Tab,
    initialize: function () {
      // Находим модель, активной вкладки
      var hash  = Backbone.history.location.hash;
      // Учитываем только 2 уровня
      hash = hash.split('/').splice(0, 2).join('/');
      var model = this.collection.findWhere({url: hash});

      if (model) model.set('active', true);
      this.collection.on('change', function() {
        this.render();
      }, this)
    }
  });

  Views.MailBoxLayout = Marionette.LayoutView.extend({
    className: 'right mailbox',
    template: '#mailbox-layout-template',
    regions: {
      tabs: '#tabs',
      head: '#head',
      content: '.int_tab'
    },
    ui: {
      'searchForm': '.top_search form',
      'searchText': '#search_text',
      'newMessage': '.new-message a'
    },
    events: {
      'submit @ui.searchForm': 'search',
      'click @ui.newMessage': 'newMessage'
    },
    initialize: function (data) {
      this.searchText = data.searchText;
    },
    onShow: function () {
      this.ui.searchText.val(this.searchText)
    },
    search: function(e) {
      e.preventDefault();
      var searchText = this.ui.searchText.val();
      var route = PersonalArea.getCurrentRoute().split('/').splice(0,2);
      if (!searchText) {
        Backbone.history.navigate(route.join('/'), {trigger: true});
        return;
      }
      route.push('1'); route.push(searchText);
      Backbone.history.navigate(route.join('/'), {trigger: true})
    },
    newMessage: function (e) {
        e.preventDefault();
        var model = new PersonalArea.MailBox.Models.NewMessage();
        var view = new PersonalArea.MailBox.Views.NewMessage({model: model});
        view.showModal();
    }
  });
});

    
        PersonalArea.module('MailBox', function (MailBox, PersonalArea, Backbone, Marionette, $, _) {

  MailBox.on('start', function () {
      var model = new this.Models.InBoxCounter();
      $.when(model.fetch()).then(function (count) {
         PersonalArea.Core.Widget.Menu.trigger('change:mailbox', count);
      });
  });

  MailBox.Controller = Marionette.Controller.extend({
    showInBox: function (page, searchText) {
      // Входящие сообщения
      var inBox = new MailBox.Models.InBox({
        current_page: page, search_text: searchText
      });
      this.showLayout(inBox.get('new_count'), searchText);
      var maskView = new PersonalArea.Core.Views.MaskView({
          img: 'mail',
      });
      this.layout.content.show(maskView);

      $.when(inBox.fetch({
        method: 'POST', data: {'page': page || 1, search_text: searchText}
      })).then(_.bind(function () {
        var view = new MailBox.Views.InBoxMessages({model: inBox});
        this.layout.content.show(view);
      }, this));
    },
    showOutBox: function (page, searchText) {
      // Исходящие сообщения
      var outBox = new MailBox.Models.OutBox({
        current_page: page, search_text: searchText
      });

      $.when(outBox.fetch({
        method: 'POST', data: {'page': page || 1, search_text: searchText}
      })).then(_.bind(function () {
        this.showLayout(outBox.get('new_count'), searchText);
        var view = new MailBox.Views.OutBoxMessages({model: outBox});
        this.layout.content.show(view);
      }, this));
    },
    showLayout: function (inBoxCount, searchText) {
      this.layout = new MailBox.Views.MailBoxLayout({searchText: searchText});
      // Табы и информации о них
      MailBox.Tabs = new Backbone.Collection([
        {count: inBoxCount, name: 'Входящие', url: '#mailbox/inbox'},
        {count: 0, name: 'Исходящие', url: '#mailbox/outbox'}
      ]);
      PersonalArea.mainRegion.show(this.layout);
      this.layout.tabs.show(new MailBox.Views.Tabs({
        collection: MailBox.Tabs
      }));
    }
  });

  MailBox.Router = Marionette.AppRouter.extend({
    appRoutes: {
      'mailbox/inbox(/:page)(/:search_text)': 'showInBox',
      'mailbox/outbox(/:page)(/:search_text)': 'showOutBox'
    }
  });

  PersonalArea.addInitializer(function() {
    new MailBox.Router({
      controller: new MailBox.Controller
    })
  });
});

    
        CKEDITOR.env.isCompatible = true;

PersonalArea.module('MailBox.Views', function (Views, PersonalArea, Backbone, Marionette, $, _) {
  // Сообщение
  Views.Message = Marionette.ItemView.extend({
    tagName: 'li',
    className: 'clearfix',
    template: '#mailbox-message',
    ui: {
      'checkbox': '.check',
      'subject': '.subject',
      'reply': '#reply',
      'replyAll': '#reply_all'
    },
    events: {
      'click @ui.checkbox': 'check',
      'click @ui.subject': 'showMessage',
      'click @ui.reply': 'reply',
      'click @ui.replyAll': 'replyAll'
    },
    showMessage: function (e) {
      e.preventDefault();
      var view = new this.fullMessageView({
        model: this.model, parent: this
      });
      view.showModal();
    },
    check: function() {
      var checked = this.model.get('checked');
      this.ui.checkbox.addClass('active');
      this.model.set('checked', true);
      if (checked) {
        this.ui.checkbox.removeClass('active');
        this.model.set('checked', false);
      }
    },
    onShow: function () {
      if (this.model.get('is_new')) {
        this.$el.addClass('new');
      }
    }
  });

  // Сообщения
  Views.Messages = Marionette.CompositeView.extend({
    itemsPerPage: 25,
    childView: Views.Message,
    childViewContainer: '#mailbox-listing',
    ui: {
      'checkbox': '.check_all',
      'childCheckbox': '.check',
      'removeChecked': '#remove_checked'
    },
    events: {
      'click @ui.checkbox': 'check_all',
      'click @ui.childCheckbox': 'checkChild',
      'click @ui.removeChecked': 'removeChecked'
    },
    check_all: function () {
      var all_checked = _.all(this.collection.pluck('checked'));
      _.each(this.children._views, function (child) {
        if (!all_checked) {
          child.ui.checkbox.addClass('active');
          child.model.set('checked', true);
        } else {
          child.ui.checkbox.removeClass('active');
          child.model.set('checked', false);
        }
      });
    },
    checkChild: function () {
      if (_.all(this.collection.pluck('checked'))) {
        this.ui.checkbox.addClass('active');
      } else {
        this.ui.checkbox.removeClass('active');
      }
    },
    removeChecked: function (e) {
      e.preventDefault();
      var removeUrl = this.removeUrl;
      var checkedModels = this.collection.where({'checked': true});
      var confirmView =  new PersonalArea.Core.Views.ConfirmView({
        text: "<b>Внимание!</b> Данная операция приведет к необратимым " +
              "результатам. Вы действительно хотите удалить " +
              checkedModels.length + " сообщений?"
      });

      if (checkedModels.length) {
        confirmView.showModal();
        confirmView.on('select:ok', function(){
          $.when(this.model.fetch({
            url: removeUrl,
            method: 'POST',
            data: {'messages': _.pluck(checkedModels, 'id').join(',')}
          })).then(function () {
            Backbone.history.loadUrl();
          });
          confirmView.trigger('close');
        });
      } else {
        showError('Внимание!', 'Не выбран ни один из элементов.')
      }
    },
    initialize: function () {
      this.collection = new PersonalArea.MailBox.Models.Messages(
        this.model.get('items'));
    },
    onShow: function () {
      var count = this.model.get('count');
      var searchText = this.model.get('search_text');
      if (count > this.itemsPerPage) {
        $('.paging2').pagination({
          items: this.model.get('count'),
          itemsOnPage: this.itemsPerPage,
          hrefTextPrefix: this.pagingPrefix,
          hrefTextSuffix:  searchText ? '/' + searchText : '',
          displayedPages: 3,
          currentPage: this.model.get('current_page') || 1
        })
      }
    },
    templateHelpers: function() {
      return {
        getPagingInfo: _.bind(function() {
          var currentPage = (this.model.get('current_page') || 1) - 1,
              count = this.model.get('count'),
              from = (currentPage * this.itemsPerPage) + 1 || 1,
              to = from + this.itemsPerPage - 1;

          if (to > count) { to = count; }
          return from + '-' + to +  ' из ' + count;
        }, this)
      }
    }
  });

  // Окно нового сообщения
  Views.NewMessage = Marionette.ItemView.extend({
    template: '#mailbox-new-message',
    behaviors: {
      Modal: {alignment: false},
      Closable: {el: '.close-popup'},
      LoadFile: {},
      jScrollPane: {
         container: '#scrollable-container'
      },
      CKEditor: {}
    },
    ui: {
      'send': '#send-message',
      'form': '#my_form',
      'getPupilReceivers': '#get-pupil-receivers',
      'getEmployeeReceivers': '#get-employee-receivers',
      'getParentReceivers': '#get-parent-receivers',
      'getAdminReceivers': '#get-admin-receivers',
      'receivers_names': '#receivers_names ul',
      'receivers_ids': '#receivers_ids'
    },
    events: {
      'submit-form': 'sendMessage',
      'click @ui.send': 'sendMessage',
      'click @ui.getPupilReceivers': 'getPupilReceivers',
      'click @ui.getEmployeeReceivers': 'getEmployeeReceivers',
      'click @ui.getParentReceivers': 'getParentReceivers',
      'click @ui.getAdminReceivers': 'getAdminReceivers'
    },
    initialize: function () {
      this.model.on('change', _.bind(function () {
        var receivers = this.model.get('receivers');
        var receiver_ids = receivers.pluck('profile_id');

        var receiver_names = this.model.get('receivers').pluck('fullname');

        this.ui.receivers_names.html('<li>' + receiver_names.join(', ') + '</li>');
        this.ui.receivers_ids.val(receiver_ids.join(','));
        this.trigger('scroll:reinitialize');
      }, this))
    },
    sendMessage: function (e) {
      e.preventDefault();
      Backbone.Syphon.serializeAsync(this).done(_.bind(function (data) {
        if (!this.checkMandatoryField(data.subject)) {
          showError('Внимание!', 'Поле «Тема» не может быть пустым!');
          return false;
        }
        if (!this.checkMandatoryField(data.receivers_ids)) {
          showError('Внимание!', 'Поле «Кому» не может быть пустым!');
          return false;
        }

        if (!this.checkMandatoryField(data.message)) {
          showError('Внимание!', 'Поле «Текст» не может быть пустым!');
          return false;
        }

        $.when(this.model.fetch({
          url: "/api/MailBoxService/newMailBoxMessage",
          method: 'POST',
          data: data
        })).then(_.bind(function () {
          this.trigger('close');
          Backbone.history.loadUrl();
        }, this));

      }, this));
    },
    getReceivers: function (template, childViewTemplate, model) {
      $.when(model.fetch({
          method: 'POST',
          data: {'initial': 'true'}
      })).then(_.bind(function () {
        var view = new Views.Receivers({
          childViewTemplate: childViewTemplate,
          template: template,
          model: model,
          receivers: this.model.get('receivers'),
          receiversModel: this.model,
        });
        view.showModal();

        view.on('select:ok', _.bind(function (receivers, unselected) {
          receivers = _.values(receivers);
          var selected = this.model.get('receivers');
          selected.remove(_.values(unselected));
          if (selected) {
            receivers = [].concat(receivers, selected.models);
          }

          var collection = new Backbone.Collection(
            receivers, {comparator: 'fullname'}
          );

          this.model.trigger('change');
          this.model.set('receivers', collection);
          view.trigger('close');
        }, this));
      }, this))
    },
    getPupilReceivers: function (e) {
      e.preventDefault();
      var model = new PersonalArea.MailBox.Models.PupilReceivers();

      this.getReceivers(
        '#new-message-pupil-receivers',
        '#new-message-pupil-receiver',
        model
      );
    },
    getEmployeeReceivers: function (e) {
      e.preventDefault();
      var model = new PersonalArea.MailBox.Models.EmployeeReceivers();
      this.getReceivers(
        '#new-message-employee-receivers',
        '#new-message-employee-receiver',
        model
      );
    },
    getParentReceivers: function (e) {
      e.preventDefault();
      var model = new PersonalArea.MailBox.Models.ParentReceivers();

      this.getReceivers(
        '#new-message-parent-receivers',
        '#new-message-parent-receiver',
        model
      );
    },
    getAdminReceivers: function (e) {
      e.preventDefault();
      var model = new PersonalArea.MailBox.Models.AdminReceivers();
      this.getReceivers(
        '#new-message-admin-receivers',
        '#new-message-admin-receiver',
        model
      );
    },
    checkMandatoryField: function (v) {
      return !!('' + v).trim();
    }
  });

  // Получатель
  Views.Receiver = Marionette.ItemView.extend({
    tagName: 'tr',
    template: '#new-message-pupil-receiver',
    ui: {
      'checkbox': '.check',
      'subject': '.subject'
    },
    events: {
      'click @ui.checkbox': 'check'
    },
    initialize: function (options) {
      this.template = options.template;
    },
    check: function() {
      var checked = this.model.get('checked');
      this.ui.checkbox.addClass('active');
      this.model.set('checked', true);
      delete this.model.collection.unselected[this.model.id];

      if (checked) {
        this.model.collection.unselected[this.model.id] = this.model;
        this.ui.checkbox.removeClass('active');
        this.model.set('checked', false);
      }
    },
    onShow: function () {
      this.model.on('change:checked', _.bind(function (model) {
        if (model.get('checked')) {
          this.$el.find('.check').addClass('active');
        } else {
          this.$el.find('.check').removeClass('active');
        }
      }, this));
      if (this.model.get('checked')) {
        this.$el.find('.check').addClass('active');
      } else {
          this.$el.find('.check').removeClass('active');
      }
    }
  });

  // Окно выбора получателей
  Views.Receivers = Marionette.CompositeView.extend({
    itemsPerPage: 25,
    childView: Views.Receiver,
    childViewContainer: 'tbody',
    template: '#new-message-pupil-receivers',
    behaviors: {
      MyModal: {alignment: false},
      Closable: {el: '.close-popup'},
      jScrollPane: {
        container: '.user_list_body'
      }
    },
    ui: {
      'checkbox': '.check_all',
      'childCheckbox': '.check',
      'searchForm': '.receivers-search-form',
      'searchText': '.search-text',
      'select': '.select-receivers',
      'filterFields': '.column-filter-field'
    },
    events: {
      'click @ui.checkbox': 'check_all',
      'click @ui.childCheckbox': 'checkChild',
      'submit @ui.searchForm': 'search',
      'click @ui.select': 'select',
      'keyup @ui.filterFields': 'filter'
    },
    initialize: function (options) {
      // При инициализации отфильтруем данные по классу ученика
      this.model.set('filter_data', {
        'study_level': this.model.get('study_level'),
        'letter': this.model.get('letter')
      });
      this.template = options.template;
      this.childViewOptions = {
        template: options.childViewTemplate
      };

      var items = this.model.get('items');
      this.collection = new Backbone.Collection(items);
      this.collection.selected = {};
      this.collection.unselected = {};

      if (options.receivers) {
        options.receivers.each(_.bind(function (item) {
          this.collection.selected[item.id] = item;
          var itemCollection = this.collection.findWhere({id: item.id});
          if (itemCollection) {
            itemCollection.set('checked', true);
          }
        }, this));
      }
      // При изменении коллекции сохраним список выбранных записей
      this.collection.on('change', _.bind(function() {
        // Сохраняем список выбранных записей
        _.each(this.collection.where({'checked': true}), _.bind(function (item) {
          this.collection.selected[item.id] = item;
        }, this));

        // Удаляем тех что не выбранны
        _.each(this.collection.where({'checked': false}), _.bind(function (item) {
          delete this.collection.selected[item.id];
        }, this));
      }, this))
    },
    onShow: function () {
      // При первом вызове окна заносим данные о классе ученика в поля фильтра
      var study_level = this.model.get('study_level'),
          letter = this.model.get('letter');
      _.each(this.ui.filterFields, function (item) {
          if (item.name === 'study_level' && study_level){
              item.value = study_level;
          }
          if (item.name === 'letter' && letter){
              item.value = letter;
          }
      });
      // Постраничная навигация
      this.$el.find('.paging2').pagination({
        items: this.model.get('count'),
        itemsOnPage: this.itemsPerPage,
        displayedPages: 3,
        currentPage: 1,
        onPageClick: _.bind(function (page, e) {
          if (e) {e.preventDefault();}
          if (this.model.get('pass_load')) {
            this.model.set('pass_load', false);
            return;
          }

          var data = this.model.get('filter_data') || {};
          data['search_text'] = this.model.get('search_text');
          data['page'] = page;

          $.when(this.model.fetch({
            method: 'POST',
            data: data
          })).then(_.bind(function () {
            this.collection.reset();
            this.collection.add(this.model.get('items'));
            this.collection.each(_.bind(function (item) {
              if (item.id in this.collection.selected) {
                item.set('checked', true);
              }
            }, this));
            this.trigger('scroll:reinitialize');
            this.checkChild();
          }, this))
        }, this)
      });

      if (
        this.collection.where({checked: true}).length ==
        this.collection.length
      ) {
        this.ui.checkbox.addClass('active');
      }
    },
    select: function (e) {
      e.preventDefault();
      this.trigger('select:ok', this.collection.selected, this.collection.unselected);
    },
    search: function (e) {
      e.preventDefault();
      // Поиск
      var searchText = this.ui.searchText.val();
      var data = this.model.get('filter_data') || {};
      data['search_text'] = searchText;
      this.model.set('search_text', searchText);
      $.when(this.model.fetch({
        method: 'POST',
        data: data
      })).then(_.bind(function () {
        this.collection.reset();
        this.collection.add(this.model.get('items'));

        this.model.set('pass_load', true);
        this.trigger('scroll:reinitialize');
        this.$el.find('.paging2').pagination(
          'updateItems', this.model.get('count'));
        this.$el.find('.paging2').pagination('selectPage', 1);
      }, this));
    },
    check_all: function () {
      var all_checked = _.all(this.collection.pluck('checked'));
      var unselected = this.collection.unselected;

      _.each(this.children._views, function (child) {
        if (!all_checked) {
          child.ui.checkbox.addClass('active');
          child.model.set('checked', true);
          delete unselected[child.model.id];
        } else {
          child.ui.checkbox.removeClass('active');
          child.model.set('checked', false);
          unselected[child.model.id] = child.model;
        }
      });
    },
    checkChild: function () {
      if (_.all(this.collection.pluck('checked'))) {
        this.ui.checkbox.addClass('active');
      } else {
        this.ui.checkbox.removeClass('active');
      }
    },
    filter: function (e) {

      var data = {};
      _.each(this.ui.filterFields, function (item) {
         data[item.name] = item.value;
      });

      this.model.set('filter_data', data);
      data['search_text'] = this.model.get('search_text');

      if (e.keyCode == 13) {
        $.when(this.model.fetch({
          method: 'POST',
          data: data
        })).then(_.bind(function () {
          this.collection.reset();
          this.collection.add(this.model.get('items'));
          this.model.set('pass_load', true);

          this.trigger('scroll:reinitialize');
          this.$el.find('.paging2').pagination(
            'updateItems', this.model.get('count'));
          this.$el.find('.paging2').pagination('selectPage', 1);
        }, this));
      }
    }
  });

  Views.OutBoxFullMessage = Marionette.ItemView.extend({
    template: '#outbox-full-message',
    behaviors: {
      Modal: {alignment: false},
      Closable: {el: '.close-popup'},
      jScrollPane: {
        container: '.receivers_list'
      }
    },
    ui: {
      'remove': '.remove_btn'
    },
    events: {
      'click @ui.remove': 'removeMessage'
    },
    removeMessage: function (e) {
      var model = this.model;
      var id = this.model.get('id');
      var confirmView =  new PersonalArea.Core.Views.ConfirmView({
        text: "<b>Внимание!</b> Данная операция приведет к необратимым " +
              "результатам. Вы действительно хотите удалить это сообщение?"
      });

      confirmView.showModal();
      confirmView.on('select:ok', function(){
        $.when(model.fetch({
          url: "/api/MailBoxService/removeOutBoxMessages",
          method: 'POST',
          data: {'messages': id}
        })).then(function () {
          Backbone.history.loadUrl();
        });
        confirmView.trigger('close');
      });
    },
    onShow: function () {
      if (this.model.get('receivers').length >= 3) {
        this.trigger('scroll:reinitialize');
      } else {
        this.$el.find('.receivers_list').removeClass('receivers_list').css('height', 16);
      }
    }
  });

  // Окно входящего сообщения
  Views.InBoxFullMessage = Marionette.ItemView.extend({
    template: '#inbox-full-message',
    behaviors: {
      Modal: {alignment: false},
      Closable: {el: '.close-popup'},
      jScrollPane: {
        container: '.receivers_list'
      }
    },
    ui: {
      'remove': '.remove_btn',
      'reply': '#reply',
      'replyAll': '#reply_all'
    },
    events: {
      'click @ui.remove': 'removeMessage',
      'click @ui.reply': 'reply',
      'click @ui.replyAll': 'replyAll'
    },
    initialize: function(options) {
      this.parent = options.parent;
      // Пометим сообщение как прочитанное
      if (this.model.get('is_new')) {
        $.when(this.model.fetch({
          method: 'POST',
          url: "/api/MailBoxService/markRead",
          data: {message_id: this.model.get('id')}
        })).then(function () {
          Backbone.history.loadUrl();
        });
      }
    },
    reply: function (e) {
      this.parent.reply(e);
    },
    replyAll: function (e) {
      this.parent.replyAll(e);
    },
    removeMessage: function (e) {
      var model = this.model;
      var id = this.model.get('id');
      var confirmView =  new PersonalArea.Core.Views.ConfirmView({
        text: "<b>Внимание!</b> Данная операция приведет к необратимым " +
              "результатам. Вы действительно хотите удалить это сообщение?"
      });

      confirmView.showModal();
      confirmView.on('select:ok', function(){
        $.when(model.fetch({
          url: "/api/MailBoxService/removeInBoxMessages",
          method: 'POST',
          data: {'messages': id}
        })).then(function () {
          Backbone.history.loadUrl();
        });
        confirmView.trigger('close');
      });
    },
    onShow: function () {
      if (this.model.get('receivers').length >= 3) {
        this.trigger('scroll:reinitialize');
      } else {
        this.$el.find('.receivers_list').removeClass('receivers_list').css('height', 16);
      }
    }
  });

  // Вью входящего сообщения
  Views.InBoxMessage = Views.Message.extend({
    template: '#inbox-message',
    fullMessageView: Views.InBoxFullMessage,
    reply: function (e) {
      e.preventDefault();
      this.replyMessage(new Backbone.Collection([{
        id: this.model.get('sender_id'),
        fullname: this.model.get('sender_fullname')
      }]))
    },
    replyAll: function (e) {
      e.preventDefault();
      var profile_id = PersonalArea.Core.personData.get('auth_user_profile_id');
      var receivers = _.filter(this.model.get('receivers'), function(receiver) {
        return receiver.id != profile_id
      });

      receivers.push({
        id: this.model.get('sender_id'),
        fullname: this.model.get('sender_fullname')
      });
      this.replyMessage(new Backbone.Collection(receivers));
    },
    replyMessage: function (receivers) {
      var model = new PersonalArea.MailBox.Models.NewMessage({
        receivers: receivers,
        subject: 'Ответ: ' + this.model.get('subject').replace('Ответ: ', ''),
        text: [
            'Исходное сообщение —',
            'От: ' + this.model.get('sender_fullname'),
            'Отправлено: ' + this.model.get('date'),
            'Кому: ' + _.pluck(this.model.get('receivers'), 'fullname').join(', '),
            'Тема: ' + this.model.get('subject'), '', '',
            this.model.get('text')
        ].join('\n')
      });
      var view = new PersonalArea.MailBox.Views.NewMessage({model: model});
      view.showModal();
    }
  });

  // Вью входящих сообщений
  Views.InBoxMessages = Views.Messages.extend({
    pagingPrefix: '#mailbox/inbox/',
    removeUrl: "/api/MailBoxService/removeInBoxMessages",
    template: '#inbox-messages',
    childView: Views.InBoxMessage
  });

  // Вью исходящего сообщения
  Views.OutBoxMessage = Views.Message.extend({
    template: '#outbox-message',
    fullMessageView: Views.OutBoxFullMessage
  });

  // Вью исходящих сообщений
  Views.OutBoxMessages = Views.Messages.extend({
    pagingPrefix: '#mailbox/outbox/',
    removeUrl: "/api/MailBoxService/removeOutBoxMessages",
    template: '#outbox-messages',
    childView: Views.OutBoxMessage
  });


  Views.Tab = Marionette.ItemView.extend({
    tagName: 'li',
    getTemplate: function() {
      if (this.model.has('url')) {
        return '#mailbox-tab-template-default'
      }

      // Для случая если это не таб, а какая то информация например
      // Кол-во диалогов
      this.$el.addClass('hint');
      return '#mailbox-tab-template-hint'
    },
    onShow: function () {
      if (this.model.has('active')) {
        this.$el.find('a').addClass('active');
      }

      // Имя ключа в моделе счетчика
      if (this.model.has('fieldName')) {
        var fieldName = this.model.get('fieldName');
        var value = PersonalArea.Social.Core.Counter.get(fieldName);
        this.model.set('count', value)
      }
    },
    initialize: function () {
      if (this.model.has('countEvent')) {
        var event = this.model.get('countEvent');
        // Событие для прослушки изменения счётчика
        PersonalArea.Social.Messages.on(event, function(value) {
          this.model.set('count', value);
        }, this);
      }
    }
  });

  Views.Tabs = Marionette.CollectionView.extend({
    tagName: 'ul',
    className: 'int_tabs clearfix',
    childView: Views.Tab,
    initialize: function () {
      // Находим модель, активной вкладки
      var hash  = Backbone.history.location.hash;
      // Учитываем только 2 уровня
      hash = hash.split('/').splice(0, 2).join('/');
      var model = this.collection.findWhere({url: hash});

      if (model) model.set('active', true);
      this.collection.on('change', function() {
        this.render();
      }, this)
    }
  });

  Views.MailBoxLayout = Marionette.LayoutView.extend({
    className: 'right mailbox',
    template: '#mailbox-layout-template',
    regions: {
      tabs: '#tabs',
      head: '#head',
      content: '.int_tab'
    },
    ui: {
      'searchForm': '.top_search form',
      'searchText': '#search_text',
      'newMessage': '.new-message a'
    },
    events: {
      'submit @ui.searchForm': 'search',
      'click @ui.newMessage': 'newMessage'
    },
    initialize: function (data) {
      this.searchText = data.searchText;
    },
    onShow: function () {
      this.ui.searchText.val(this.searchText)
    },
    search: function(e) {
      e.preventDefault();
      var searchText = this.ui.searchText.val();
      var route = PersonalArea.getCurrentRoute().split('/').splice(0,2);
      if (!searchText) {
        Backbone.history.navigate(route.join('/'), {trigger: true});
        return;
      }
      route.push('1'); route.push(searchText);
      Backbone.history.navigate(route.join('/'), {trigger: true})
    },
    newMessage: function (e) {
        e.preventDefault();
        var model = new PersonalArea.MailBox.Models.NewMessage();
        var view = new PersonalArea.MailBox.Views.NewMessage({model: model});
        view.showModal();
    }
  });
});

    
        PersonalArea.module('AdvertBoard.Models', function(Models, PersonalArea, Backbone, Marionette, $, _) {
    Models.Advert = Backbone.Model.extend({});
    Models.AdvertCollection = Backbone.Collection.extend({
        model: Models.Advert,
        url: '/api/AdvertBoardService/getAdvertBoard',
        byFilter: function(filterWord){
            filtered = this.filter(function(advert){
                return (function (obj){
                    for (var key in obj.attributes){
                        if (advert.get(key).indexOf(filterWord) > -1){
                            return true;
                        }
                    }
                    return false;
                })(advert);
            });
            return new Models.AdvertCollection(filtered);
        }
    });
});

    
        CKEDITOR.env.isCompatible = true;
PersonalArea.module('AdvertBoard.Views', function(Views, PersonalArea, Backbone, Marionette, $, _) {

    Views.AdvertView = Marionette.ItemView.extend({
        template: "#current-advert",
        behaviors: {
            Closable: {el: '.close-popup'},
        }
    });

    Views.AdvertBoardItemView = Marionette.LayoutView.extend({
        regions: {
            "advert_view_btn": "#view-btn-container"
        },
        template: "#advertboard-item-view",
        onShow: function () {
            advertView = new Views.AdvertBtnView({'model': this.model})
            this.advert_view_btn.show(advertView);
        }
    });

    Views.AdvertBoard = Marionette.CompositeView.extend({
        template: "#advertboard",
        childViewContainer: "div.advertboard-content",
        childView: Views.AdvertBoardItemView,
        events: {
            "submit #advert-search-form": "goSearch",
        },
        goSearch: function (e) {
            var searchText = $("#advert-search-text").val();
            var controller = new PersonalArea.AdvertBoard.Controller();
            if (searchText) {
                controller.showFilterAdvertBoard(searchText);
            }
            else {
                controller.showAdvertBoard();
            }

        },
    });

    Views.AdvertBtnView = Marionette.ItemView.extend({
        tagName: "a",
        template: "#advert-btn",
        ui: {
          'reply': '.reply',
        },
        events: {
          'click @ui.reply': 'reply',
        },
        behaviors: {
            Popupable: {
                many: [
                  {el: '.view', popupView: Views.AdvertView},
                ]
            },
            Closable: {
                el: '.close-popup'
            }
        },
        reply: function (e) {
          e.preventDefault();
          this.replyAdvert(new Backbone.Collection([{
            id: this.model.get('author_id'),
            fullname: this.model.get('author')
          }]))
        },
        replyAdvert: function (receivers) {
          var personData = PersonalArea.Core.personData;
          var fullname = personData.get('selected_pupil_name') || personData.get('user_fullname');
          var model = new PersonalArea.MailBox.Models.NewMessage({
            receivers: receivers,
            subject: 'Ответ: ' + this.model.get('theme').replace('Ответ: ', ''),
            text: [
                'Исходное сообщение —',
                'От: ' + this.model.get('author'),
                'Отправлено: ' + this.model.get('advert_date'),
                'Кому: ' + fullname,
                'Тема: ' + this.model.get('theme'), '', '',
                this.model.get('message')
            ].join('\n')
          });
          var view = new PersonalArea.MailBox.Views.NewMessage({model: model});
          view.showModal();
        }
    });
});

    
        PersonalArea.module('AdvertBoard', function(AdvertBoard, PersonalArea, Backbone, Marionette, $, _) {
    AdvertBoard.Controller = Marionette.Controller.extend({
        showAdvertBoard: function () {
            var collection = new AdvertBoard.Models.AdvertCollection();
            var maskView = new PersonalArea.Core.Views.MaskView({
                img: "megaphone",
            });
            PersonalArea.mainRegion.show(maskView);

            collection.fetch().done(function() {
                var advertBoard = new AdvertBoard.Views.AdvertBoard({
                    collection: collection
                });
                PersonalArea.mainRegion.show(
                    advertBoard
                );
            });
        },
        showFilterAdvertBoard: function (filter) {
            var collection = new AdvertBoard.Models.AdvertCollection();
            var maskView = new PersonalArea.Core.Views.MaskView({
                img: "megaphone",
            });
            PersonalArea.mainRegion.show(maskView);

            collection.fetch().done(function() {
                collection = collection.byFilter(filter);
                var advertBoard = new AdvertBoard.Views.AdvertBoard({
                    collection: collection
                });
                PersonalArea.mainRegion.show(
                    advertBoard
                );
            });
        }
    });

    AdvertBoard.Router = Marionette.AppRouter.extend({
        appRoutes: {
            'advertboard': 'showAdvertBoard',
        }
    });

    PersonalArea.addInitializer(function() {
        new AdvertBoard.Router({
            controller: new AdvertBoard.Controller
        })
    });
});

    
    PersonalArea.start();
</script>





  

  





<div id="ui-datepicker-div" class="ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all"></div></body></html>